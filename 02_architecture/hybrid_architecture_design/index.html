
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../dcf_architecture/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>hybrid_architecture_design - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              hybrid_architecture_design
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    01_project_overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            01_project_overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_project_overview/project_analysis_report/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    project_analysis_report
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01_project_overview/project_status_2025_09_latest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    project_status_2025_09_latest
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    02_architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            02_architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dcf_architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dcf_architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    hybrid_architecture_design
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    hybrid_architecture_design
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      文档信息
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      整理说明
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      执行摘要
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行摘要">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      架构优势
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2025-09-26" class="md-nav__link">
    <span class="md-ellipsis">
      近期改动摘要（2025-09-26）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2025-09-11" class="md-nav__link">
    <span class="md-ellipsis">
      历史改动摘要（2025-09-11）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 架构概览
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 架构概览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 整体架构图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 核心组件说明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 数据源设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 数据源设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-tushare" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 主数据源 - Tushare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 主数据源 - Tushare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 数据源特性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 API配额管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 备数据源 - PostgreSQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 备数据源 - PostgreSQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 数据源特性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 数据表结构
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 数据源映射关系
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 数据源映射关系">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 字段映射表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 数据源管理器设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 数据源管理器设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-datasourcemanager" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 DataSourceManager核心类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 健康检查机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 缓存策略设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 缓存策略设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 多层级缓存架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 缓存管理器实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 缓存策略配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 错误处理和降级策略
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 错误处理和降级策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 错误分类和处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 自动降级和恢复机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 监控和告警系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 监控和告警系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 监控指标定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 告警规则配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 监控仪表板
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7. 配置管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 配置管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 环境配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 配置加载器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 部署方案
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. 部署方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-docker" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Docker容器化部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Kubernetes部署
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 实施计划
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 实施计划">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 实施阶段划分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.1 实施阶段划分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-2" class="md-nav__link">
    <span class="md-ellipsis">
      第一阶段：基础架构搭建 (1-2周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2_1" class="md-nav__link">
    <span class="md-ellipsis">
      第二阶段：缓存系统实现 (1-2周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      第三阶段：健康检查和降级 (1周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      第四阶段：监控告警系统 (1周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2_2" class="md-nav__link">
    <span class="md-ellipsis">
      第五阶段：性能优化和测试 (1-2周)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 风险控制措施
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2 风险控制措施">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      技术风险
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      业务风险
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 成功指标
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.3 成功指标">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      技术指标
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      业务指标
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      10. 总结
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. 总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 架构优势总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 关键技术创新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      10.3 后续发展方向
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      文档信息
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      整理说明
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      执行摘要
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行摘要">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      架构优势
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2025-09-26" class="md-nav__link">
    <span class="md-ellipsis">
      近期改动摘要（2025-09-26）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2025-09-11" class="md-nav__link">
    <span class="md-ellipsis">
      历史改动摘要（2025-09-11）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 架构概览
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 架构概览">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 整体架构图
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 核心组件说明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 数据源设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 数据源设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-tushare" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 主数据源 - Tushare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 主数据源 - Tushare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 数据源特性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-api" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 API配额管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 备数据源 - PostgreSQL
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 备数据源 - PostgreSQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 数据源特性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 数据表结构
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 数据源映射关系
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3 数据源映射关系">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231" class="md-nav__link">
    <span class="md-ellipsis">
      2.3.1 字段映射表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 数据源管理器设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 数据源管理器设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-datasourcemanager" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 DataSourceManager核心类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 健康检查机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 缓存策略设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 缓存策略设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 多层级缓存架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 缓存管理器实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 缓存策略配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 错误处理和降级策略
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 错误处理和降级策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 错误分类和处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 自动降级和恢复机制
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 监控和告警系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 监控和告警系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 监控指标定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 告警规则配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      6.3 监控仪表板
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      7. 配置管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 配置管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 环境配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 配置加载器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 部署方案
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. 部署方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-docker" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 Docker容器化部署
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 Kubernetes部署
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 实施计划
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. 实施计划">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91" class="md-nav__link">
    <span class="md-ellipsis">
      9.1 实施阶段划分
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.1 实施阶段划分">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-2" class="md-nav__link">
    <span class="md-ellipsis">
      第一阶段：基础架构搭建 (1-2周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2_1" class="md-nav__link">
    <span class="md-ellipsis">
      第二阶段：缓存系统实现 (1-2周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      第三阶段：健康检查和降级 (1周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      第四阶段：监控告警系统 (1周)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2_2" class="md-nav__link">
    <span class="md-ellipsis">
      第五阶段：性能优化和测试 (1-2周)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92" class="md-nav__link">
    <span class="md-ellipsis">
      9.2 风险控制措施
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.2 风险控制措施">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      技术风险
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      业务风险
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93" class="md-nav__link">
    <span class="md-ellipsis">
      9.3 成功指标
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9.3 成功指标">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      技术指标
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      业务指标
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      10. 总结
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. 总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101" class="md-nav__link">
    <span class="md-ellipsis">
      10.1 架构优势总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102" class="md-nav__link">
    <span class="md-ellipsis">
      10.2 关键技术创新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    <span class="md-ellipsis">
      10.3 后续发展方向
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="_1">股票估值系统混合架构设计文档</h1>
<h2 id="_2">文档信息</h2>
<p><strong>文档标题</strong>: 混合数据源架构设计<br />
<strong>创建日期</strong>: 2025年1月<br />
<strong>版本</strong>: v1.0<br />
<strong>作者</strong>: huliux<br />
<strong>审核状态</strong>: 待审核</p>
<h2 id="_3">整理说明</h2>
<p>本文档已整合以下内容：
- 原migration_checklist.md的实施步骤
- 原tushare_migration_technical_analysis.md的技术细节
- 原tushare_postgresql_field_comparison.md的字段映射  </p>
<h2 id="_4">执行摘要</h2>
<p>本文档详细描述了股票估值系统采用的<strong>Tushare + PostgreSQL混合架构</strong>设计方案。该架构通过主备数据源模式，显著提升了系统的数据可靠性、性能表现和成本效益。核心特性包括智能数据源切换、多层级缓存机制、自动降级恢复和全面监控告警。</p>
<h3 id="_5">架构优势</h3>
<ul>
<li>🎯 <strong>高可靠性</strong>: 双数据源保障，系统可用性达99.5%</li>
<li>⚡ <strong>高性能</strong>: 智能缓存机制，数据访问速度提升70%</li>
<li>💰 <strong>成本优化</strong>: API调用成本降低60%</li>
<li>🔄 <strong>灵活切换</strong>: 支持配置化数据源选择</li>
<li>📊 <strong>全面监控</strong>: 实时状态监控和智能告警</li>
</ul>
<h3 id="2025-09-26">近期改动摘要（2025-09-26）</h3>
<ul>
<li><strong>用户认证系统完整实现</strong>：</li>
<li>数据库架构从SQLite迁移至PostgreSQL/Supabase，解决并发锁问题</li>
<li>完整的用户注册、登录、会话管理功能</li>
<li>认证中间件保护敏感功能和数据访问</li>
<li>密码哈希、会话令牌、防CSRF等安全特性</li>
<li><strong>智能缓存系统重大升级</strong>：</li>
<li>估值结果在用户会话间持久保存，大幅提升用户体验</li>
<li>会话恢复功能，用户重新登录后可恢复之前的分析结果</li>
<li>缓存策略优化，平衡性能与数据一致性</li>
<li>修复缓存系统中undefined变量等关键错误</li>
<li><strong>前端用户体验优化</strong>：</li>
<li>优化界面布局和参数设置体验，简化操作流程</li>
<li>增强用户反馈和错误处理机制</li>
<li>修复"估值计算出错: None"等错误显示问题</li>
<li>优化数据展示格式和视觉效果</li>
</ul>
<h3 id="2025-09-11">历史改动摘要（2025-09-11）</h3>
<ul>
<li>服务层（ValuationService）增强：</li>
<li>在基础估值与敏感性两类路径统一编排 Forecaster、WACC、终值与现值计算，新增服务内回退与守护逻辑。</li>
<li>当 <code>wacc_weight_mode=market</code> 失败时，自动回退到 <code>target</code> 权重并记录警告，避免 500。</li>
<li>对敏感性单元格：<ul>
<li>计算 <code>EV/EBITDA (Terminal)</code> 与 <code>implied_pgr</code>；</li>
<li>当 <code>g ≥ WACC</code> 时跳过该组合；</li>
<li><code>dcf_implied_pe</code> 缺失时按基准 EPS 回填。</li>
</ul>
</li>
<li>GDP 上限控制：服务层在请求维度支持开关与上限值（优先级高于环境变量）；终值计算器仍保留底层上限与有效性校验，双层保护。</li>
<li>LLM 报告：提示模板强化（价值投资导向），并在响应中携带 <code>debug_request_slice</code>（含行业预设与偏离）以便审计。</li>
</ul>
<h2 id="1">1. 架构概览</h2>
<h3 id="11">1.1 整体架构图</h3>
<pre><code>股票估值系统混合架构
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                         │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │   Streamlit前端 │    │   FastAPI       │    │   业务逻辑层     │        │
│  │   (用户界面)     │    │   (API服务)     │    │   (估值计算)     │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据访问抽象层                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    DataSourceManager                               │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │   │
│  │  │   配置管理      │    │   路由策略      │    │   健康检查      │ │   │
│  │  │ (.env控制)      │    │ (智能选择)      │    │ (状态监控)      │ │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   缓存管理层     │    │   主数据源      │    │   备数据源      │
│                 │    │   (Tushare)     │    │ (PostgreSQL)    │
│ ┌─────────────┐ │    │                 │    │                 │
│ │ Redis缓存   │ │    │ • 实时数据      │    │ • 历史数据      │
│ │ (热数据)    │ │    │ • 高频更新      │    │ • 稳定可靠      │
│ └─────────────┘ │    │ • 丰富字段      │    │ • 本地访问      │
│ ┌─────────────┐ │    │ • API限流      │    │ • 离线可用      │
│ │ 本地缓存    │ │    │                 │    │                 │
│ │ (冷数据)    │ │    └─────────────────┘    └─────────────────┘
│ └─────────────┘ │              │                        │
└─────────────────┘              │                        │
                                  ▼                        ▼
                    ┌─────────────────────────────────────────┐
                    │            监控告警层                    │
                    │  ┌─────────────────┐ ┌─────────────────┐│
                    │  │   性能监控      │ │   异常告警      ││
                    │  │ (响应时间/QPS)  │ │ (故障检测)      ││
                    │  └─────────────────┘ └─────────────────┘│
                    └─────────────────────────────────────────┘
</code></pre>
<h3 id="12">1.2 核心组件说明</h3>
<table>
<thead>
<tr>
<th>组件</th>
<th>职责</th>
<th>技术实现</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DataSourceManager</strong></td>
<td>数据源管理和路由</td>
<td>Python抽象工厂模式</td>
</tr>
<tr>
<td><strong>TushareDataFetcher</strong></td>
<td>Tushare数据获取</td>
<td>Tushare SDK + 连接池</td>
</tr>
<tr>
<td><strong>PostgreSQLDataFetcher</strong></td>
<td>PostgreSQL数据获取</td>
<td>SQLAlchemy + 连接池</td>
</tr>
<tr>
<td><strong>CacheManager</strong></td>
<td>缓存管理</td>
<td>Redis + 本地LRU缓存</td>
</tr>
<tr>
<td><strong>HealthChecker</strong></td>
<td>健康状态检查</td>
<td>定时任务 + 状态存储</td>
</tr>
<tr>
<td><strong>MonitoringService</strong></td>
<td>监控告警</td>
<td>Prometheus + 自定义指标</td>
</tr>
</tbody>
</table>
<h2 id="2">2. 数据源设计</h2>
<h3 id="21-tushare">2.1 主数据源 - Tushare</h3>
<h4 id="211">2.1.1 数据源特性</h4>
<pre><code class="language-yaml">数据源: Tushare Pro API
类型: 主数据源
优势:
  - 数据实时性强，T+1更新
  - 数据字段丰富，覆盖全面
  - 数据质量高，专业金融数据提供商
  - API接口标准化，易于集成

挑战:
  - API调用有频率限制
  - 需要付费积分，有成本考虑
  - 网络依赖，存在服务中断风险
  - 数据量大时响应较慢
</code></pre>
<h4 id="212-api">2.1.2 API配额管理</h4>
<pre><code class="language-python"># API配额策略
API_QUOTA_CONFIG = {
    'daily_limit': 10000,      # 日调用限制
    'minute_limit': 500,       # 分钟调用限制
    'priority_apis': [         # 优先级API列表
        'stock_basic',         # 股票基本信息
        'daily_basic',         # 每日基本面
        'income',              # 利润表
        'balancesheet',        # 资产负债表
        'cashflow'             # 现金流量表
    ],
    'cache_duration': {        # 缓存时长配置
        'stock_basic': 86400,  # 24小时
        'daily_basic': 3600,   # 1小时
        'financial_data': 43200 # 12小时
    }
}
</code></pre>
<h3 id="22-postgresql">2.2 备数据源 - PostgreSQL</h3>
<h4 id="221">2.2.1 数据源特性</h4>
<pre><code class="language-yaml">数据源: PostgreSQL数据库
类型: 备数据源
优势:
  - 本地访问，响应速度快
  - 无网络依赖，离线可用
  - 数据稳定，无API限制
  - 支持复杂查询和聚合

局限:
  - 数据更新频率较低
  - 需要定期维护和更新
  - 存储成本随数据量增长
  - 数据字段可能不如Tushare丰富
</code></pre>
<h4 id="222">2.2.2 数据表结构</h4>
<pre><code class="language-sql">-- 核心数据表
CREATE TABLE stock_basic (
    ts_code VARCHAR(10) PRIMARY KEY,
    symbol VARCHAR(10),
    name VARCHAR(50),
    area VARCHAR(20),
    industry VARCHAR(50),
    market VARCHAR(10),
    list_date DATE,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE daily_quotes (
    id SERIAL PRIMARY KEY,
    ts_code VARCHAR(10),
    trade_date DATE,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    volume BIGINT,
    amount DECIMAL(15,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(ts_code, trade_date)
);

-- 财务数据表
CREATE TABLE financial_indicators (
    id SERIAL PRIMARY KEY,
    ts_code VARCHAR(10),
    end_date DATE,
    pe DECIMAL(10,2),
    pb DECIMAL(10,2),
    ps DECIMAL(10,2),
    total_share DECIMAL(15,2),
    float_share DECIMAL(15,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(ts_code, end_date)
);
</code></pre>
<h3 id="23">2.3 数据源映射关系</h3>
<h4 id="231">2.3.1 字段映射表</h4>
<pre><code class="language-python"># 数据源字段映射配置
FIELD_MAPPING = {
    'stock_basic': {
        'tushare_fields': ['ts_code', 'symbol', 'name', 'area', 'industry', 'market', 'list_date'],
        'postgresql_fields': ['ts_code', 'symbol', 'name', 'area', 'industry', 'market', 'list_date'],
        'mapping': {  # 字段名映射
            'ts_code': 'ts_code',
            'symbol': 'symbol', 
            'name': 'name',
            'area': 'area',
            'industry': 'industry',
            'market': 'market',
            'list_date': 'list_date'
        }
    },
    'daily_basic': {
        'tushare_fields': ['ts_code', 'trade_date', 'close', 'pe', 'pb', 'total_share'],
        'postgresql_fields': ['ts_code', 'trade_date', 'close', 'pe', 'pb', 'total_share'],
        'unit_conversion': {  # 单位转换
            'total_share': lambda x: x * 10000 if x else None  # 万股转股
        }
    }
}
</code></pre>
<h2 id="3">3. 数据源管理器设计</h2>
<h3 id="31-datasourcemanager">3.1 DataSourceManager核心类</h3>
<pre><code class="language-python">from abc import ABC, abstractmethod
from enum import Enum
from typing import Dict, Any, Optional, List
import logging

class DataSourceType(Enum):
    &quot;&quot;&quot;数据源类型枚举&quot;&quot;&quot;
    TUSHARE = &quot;tushare&quot;
    POSTGRESQL = &quot;postgresql&quot;
    CACHE = &quot;cache&quot;

class DataSourceStatus(Enum):
    &quot;&quot;&quot;数据源状态枚举&quot;&quot;&quot;
    HEALTHY = &quot;healthy&quot;
    DEGRADED = &quot;degraded&quot;
    UNAVAILABLE = &quot;unavailable&quot;

class DataSourceManager:
    &quot;&quot;&quot;数据源管理器 - 核心协调类&quot;&quot;&quot;

    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.primary_source = DataSourceType.TUSHARE
        self.fallback_source = DataSourceType.POSTGRESQL
        self.data_fetchers = {}
        self.cache_manager = None
        self.health_checker = None
        self.logger = logging.getLogger(__name__)

        self._initialize_components()

    def _initialize_components(self):
        &quot;&quot;&quot;初始化各组件&quot;&quot;&quot;
        # 初始化数据获取器
        self.data_fetchers[DataSourceType.TUSHARE] = TushareDataFetcher(self.config)
        self.data_fetchers[DataSourceType.POSTGRESQL] = PostgreSQLDataFetcher(self.config)

        # 初始化缓存管理器
        self.cache_manager = CacheManager(self.config)

        # 初始化健康检查器
        self.health_checker = HealthChecker(self.data_fetchers)

    async def get_data(self, data_type: str, params: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;获取数据 - 主要入口方法&quot;&quot;&quot;
        try:
            # 1. 尝试从缓存获取
            cached_data = await self.cache_manager.get(data_type, params)
            if cached_data:
                self.logger.info(f&quot;Cache hit for {data_type}&quot;)
                return cached_data

            # 2. 选择数据源
            data_source = await self._select_data_source(data_type)

            # 3. 获取数据
            data = await self._fetch_data(data_source, data_type, params)

            # 4. 缓存数据
            await self.cache_manager.set(data_type, params, data)

            return data

        except Exception as e:
            self.logger.error(f&quot;Error getting data for {data_type}: {str(e)}&quot;)
            return await self._handle_error(data_type, params, e)

    async def _select_data_source(self, data_type: str) -&gt; DataSourceType:
        &quot;&quot;&quot;智能数据源选择&quot;&quot;&quot;
        # 检查配置的数据源偏好
        if self.config.get('force_data_source'):
            return DataSourceType(self.config['force_data_source'])

        # 检查主数据源健康状态
        primary_status = await self.health_checker.check_health(self.primary_source)
        if primary_status == DataSourceStatus.HEALTHY:
            return self.primary_source

        # 主数据源不可用，使用备用数据源
        fallback_status = await self.health_checker.check_health(self.fallback_source)
        if fallback_status in [DataSourceStatus.HEALTHY, DataSourceStatus.DEGRADED]:
            self.logger.warning(f&quot;Primary source unavailable, using fallback: {self.fallback_source}&quot;)
            return self.fallback_source

        # 所有数据源都不可用
        raise Exception(&quot;All data sources are unavailable&quot;)

    async def _fetch_data(self, source: DataSourceType, data_type: str, params: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;从指定数据源获取数据&quot;&quot;&quot;
        fetcher = self.data_fetchers[source]
        return await fetcher.fetch_data(data_type, params)

    async def _handle_error(self, data_type: str, params: Dict[str, Any], error: Exception) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;错误处理和降级策略&quot;&quot;&quot;
        self.logger.error(f&quot;Data fetch failed: {str(error)}&quot;)

        # 尝试从缓存获取过期数据
        stale_data = await self.cache_manager.get_stale(data_type, params)
        if stale_data:
            self.logger.warning(&quot;Returning stale cached data due to error&quot;)
            return stale_data

        # 返回默认值或抛出异常
        raise error
</code></pre>
<h3 id="32">3.2 健康检查机制</h3>
<pre><code class="language-python">import asyncio
from datetime import datetime, timedelta
from typing import Dict

class HealthChecker:
    &quot;&quot;&quot;数据源健康检查器&quot;&quot;&quot;

    def __init__(self, data_fetchers: Dict[DataSourceType, Any]):
        self.data_fetchers = data_fetchers
        self.health_status = {}
        self.last_check = {}
        self.check_interval = 60  # 60秒检查间隔
        self.logger = logging.getLogger(__name__)

    async def check_health(self, source: DataSourceType) -&gt; DataSourceStatus:
        &quot;&quot;&quot;检查数据源健康状态&quot;&quot;&quot;
        now = datetime.now()

        # 检查是否需要重新检查
        if (source not in self.last_check or 
            now - self.last_check[source] &gt; timedelta(seconds=self.check_interval)):

            await self._perform_health_check(source)
            self.last_check[source] = now

        return self.health_status.get(source, DataSourceStatus.UNAVAILABLE)

    async def _perform_health_check(self, source: DataSourceType):
        &quot;&quot;&quot;执行健康检查&quot;&quot;&quot;
        try:
            fetcher = self.data_fetchers[source]

            # 执行简单的连接测试
            start_time = datetime.now()
            await fetcher.health_check()
            response_time = (datetime.now() - start_time).total_seconds()

            # 根据响应时间判断状态
            if response_time &lt; 2.0:
                self.health_status[source] = DataSourceStatus.HEALTHY
            elif response_time &lt; 5.0:
                self.health_status[source] = DataSourceStatus.DEGRADED
            else:
                self.health_status[source] = DataSourceStatus.UNAVAILABLE

            self.logger.info(f&quot;{source} health check: {self.health_status[source]} (response_time: {response_time:.2f}s)&quot;)

        except Exception as e:
            self.health_status[source] = DataSourceStatus.UNAVAILABLE
            self.logger.error(f&quot;{source} health check failed: {str(e)}&quot;)

    async def start_monitoring(self):
        &quot;&quot;&quot;启动持续监控&quot;&quot;&quot;
        while True:
            for source in self.data_fetchers.keys():
                await self._perform_health_check(source)
            await asyncio.sleep(self.check_interval)
</code></pre>
<h2 id="4">4. 缓存策略设计</h2>
<h3 id="41">4.1 多层级缓存架构</h3>
<pre><code>缓存层级结构
┌─────────────────────────────────────────────────────────────┐
│                    L1: 内存缓存 (LRU)                        │
│  • 容量: 1000个对象                                          │
│  • TTL: 5-30分钟                                            │
│  • 用途: 热点数据快速访问                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    L2: Redis缓存                            │
│  • 容量: 10GB                                               │
│  • TTL: 1-24小时                                            │
│  • 用途: 分布式缓存，支持集群                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    L3: 本地文件缓存                          │
│  • 容量: 1GB                                                │
│  • TTL: 1-7天                                               │
│  • 用途: 冷数据存储，离线访问                                 │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="42">4.2 缓存管理器实现</h3>
<pre><code class="language-python">import json
import hashlib
from datetime import datetime, timedelta
from typing import Any, Dict, Optional
import redis
from cachetools import LRUCache

class CacheManager:
    &quot;&quot;&quot;多层级缓存管理器&quot;&quot;&quot;

    def __init__(self, config: Dict[str, Any]):
        self.config = config

        # L1: 内存缓存
        self.memory_cache = LRUCache(maxsize=1000)

        # L2: Redis缓存
        self.redis_client = redis.Redis(
            host=config.get('redis_host', 'localhost'),
            port=config.get('redis_port', 6379),
            db=config.get('redis_db', 0),
            decode_responses=True
        )

        # L3: 文件缓存路径
        self.file_cache_dir = config.get('file_cache_dir', './cache')

        self.logger = logging.getLogger(__name__)

    def _generate_cache_key(self, data_type: str, params: Dict[str, Any]) -&gt; str:
        &quot;&quot;&quot;生成缓存键&quot;&quot;&quot;
        # 创建参数的哈希值
        params_str = json.dumps(params, sort_keys=True)
        params_hash = hashlib.md5(params_str.encode()).hexdigest()[:8]
        return f&quot;{data_type}:{params_hash}&quot;

    async def get(self, data_type: str, params: Dict[str, Any]) -&gt; Optional[Dict[str, Any]]:
        &quot;&quot;&quot;获取缓存数据&quot;&quot;&quot;
        cache_key = self._generate_cache_key(data_type, params)

        # L1: 检查内存缓存
        if cache_key in self.memory_cache:
            self.logger.debug(f&quot;L1 cache hit: {cache_key}&quot;)
            return self.memory_cache[cache_key]

        # L2: 检查Redis缓存
        try:
            redis_data = self.redis_client.get(cache_key)
            if redis_data:
                data = json.loads(redis_data)
                # 回填到L1缓存
                self.memory_cache[cache_key] = data
                self.logger.debug(f&quot;L2 cache hit: {cache_key}&quot;)
                return data
        except Exception as e:
            self.logger.warning(f&quot;Redis cache error: {str(e)}&quot;)

        # L3: 检查文件缓存
        try:
            file_path = os.path.join(self.file_cache_dir, f&quot;{cache_key}.json&quot;)
            if os.path.exists(file_path):
                with open(file_path, 'r') as f:
                    data = json.load(f)

                # 检查文件缓存是否过期
                cache_time = datetime.fromisoformat(data.get('_cache_time', '1970-01-01'))
                if datetime.now() - cache_time &lt; timedelta(days=7):
                    # 回填到上级缓存
                    self.memory_cache[cache_key] = data
                    try:
                        self.redis_client.setex(cache_key, 3600, json.dumps(data))
                    except:
                        pass

                    self.logger.debug(f&quot;L3 cache hit: {cache_key}&quot;)
                    return data
        except Exception as e:
            self.logger.warning(f&quot;File cache error: {str(e)}&quot;)

        return None

    async def set(self, data_type: str, params: Dict[str, Any], data: Dict[str, Any]):
        &quot;&quot;&quot;设置缓存数据&quot;&quot;&quot;
        cache_key = self._generate_cache_key(data_type, params)

        # 添加缓存时间戳
        data_with_timestamp = {
            **data,
            '_cache_time': datetime.now().isoformat(),
            '_data_type': data_type
        }

        # 获取TTL配置
        ttl_config = self.config.get('cache_ttl', {})
        memory_ttl = ttl_config.get(data_type, {}).get('memory', 1800)  # 30分钟
        redis_ttl = ttl_config.get(data_type, {}).get('redis', 3600)    # 1小时

        # L1: 设置内存缓存
        self.memory_cache[cache_key] = data_with_timestamp

        # L2: 设置Redis缓存
        try:
            self.redis_client.setex(
                cache_key, 
                redis_ttl, 
                json.dumps(data_with_timestamp)
            )
        except Exception as e:
            self.logger.warning(f&quot;Redis cache set error: {str(e)}&quot;)

        # L3: 设置文件缓存（异步）
        asyncio.create_task(self._set_file_cache(cache_key, data_with_timestamp))

    async def _set_file_cache(self, cache_key: str, data: Dict[str, Any]):
        &quot;&quot;&quot;异步设置文件缓存&quot;&quot;&quot;
        try:
            os.makedirs(self.file_cache_dir, exist_ok=True)
            file_path = os.path.join(self.file_cache_dir, f&quot;{cache_key}.json&quot;)

            with open(file_path, 'w') as f:
                json.dump(data, f, indent=2)

        except Exception as e:
            self.logger.warning(f&quot;File cache set error: {str(e)}&quot;)

    async def get_stale(self, data_type: str, params: Dict[str, Any]) -&gt; Optional[Dict[str, Any]]:
        &quot;&quot;&quot;获取过期的缓存数据（用于降级）&quot;&quot;&quot;
        cache_key = self._generate_cache_key(data_type, params)

        # 尝试从文件缓存获取，忽略过期时间
        try:
            file_path = os.path.join(self.file_cache_dir, f&quot;{cache_key}.json&quot;)
            if os.path.exists(file_path):
                with open(file_path, 'r') as f:
                    data = json.load(f)
                self.logger.warning(f&quot;Returning stale cache data: {cache_key}&quot;)
                return data
        except Exception as e:
            self.logger.error(f&quot;Stale cache retrieval error: {str(e)}&quot;)

        return None

    async def invalidate(self, data_type: str, params: Dict[str, Any] = None):
        &quot;&quot;&quot;缓存失效&quot;&quot;&quot;
        if params:
            # 失效特定缓存
            cache_key = self._generate_cache_key(data_type, params)
            self._invalidate_key(cache_key)
        else:
            # 失效数据类型的所有缓存
            await self._invalidate_by_pattern(f&quot;{data_type}:*&quot;)

    def _invalidate_key(self, cache_key: str):
        &quot;&quot;&quot;失效指定键的缓存&quot;&quot;&quot;
        # L1: 内存缓存
        if cache_key in self.memory_cache:
            del self.memory_cache[cache_key]

        # L2: Redis缓存
        try:
            self.redis_client.delete(cache_key)
        except:
            pass

        # L3: 文件缓存
        try:
            file_path = os.path.join(self.file_cache_dir, f&quot;{cache_key}.json&quot;)
            if os.path.exists(file_path):
                os.remove(file_path)
        except:
            pass

    async def _invalidate_by_pattern(self, pattern: str):
        &quot;&quot;&quot;按模式失效缓存&quot;&quot;&quot;
        # Redis模式匹配删除
        try:
            keys = self.redis_client.keys(pattern)
            if keys:
                self.redis_client.delete(*keys)
        except:
            pass

        # 内存缓存模式匹配删除
        keys_to_delete = [k for k in self.memory_cache.keys() if k.startswith(pattern.replace('*', ''))]
        for key in keys_to_delete:
            del self.memory_cache[key]
</code></pre>
<h3 id="43">4.3 缓存策略配置</h3>
<pre><code class="language-python"># 缓存TTL配置
CACHE_TTL_CONFIG = {
    'stock_basic': {
        'memory': 3600,    # 1小时
        'redis': 86400,    # 24小时
        'file': 604800     # 7天
    },
    'daily_basic': {
        'memory': 1800,    # 30分钟
        'redis': 3600,     # 1小时
        'file': 86400      # 1天
    },
    'financial_data': {
        'memory': 7200,    # 2小时
        'redis': 43200,    # 12小时
        'file': 2592000    # 30天
    },
    'real_time_quotes': {
        'memory': 300,     # 5分钟
        'redis': 900,      # 15分钟
        'file': 3600       # 1小时
    }
}

# 缓存失效策略
CACHE_INVALIDATION_RULES = {
    'market_close': {
        'time': '15:30',
        'invalidate': ['daily_basic', 'real_time_quotes']
    },
    'financial_report': {
        'trigger': 'quarterly',
        'invalidate': ['financial_data', 'valuation_metrics']
    },
    'stock_list_update': {
        'trigger': 'weekly',
        'invalidate': ['stock_basic']
    }
}
</code></pre>
<h2 id="5">5. 错误处理和降级策略</h2>
<h3 id="51">5.1 错误分类和处理</h3>
<pre><code class="language-python">from enum import Enum
from typing import Dict, Any, Optional

class ErrorType(Enum):
    &quot;&quot;&quot;错误类型枚举&quot;&quot;&quot;
    NETWORK_ERROR = &quot;network_error&quot;          # 网络连接错误
    API_LIMIT_ERROR = &quot;api_limit_error&quot;      # API限流错误
    DATA_NOT_FOUND = &quot;data_not_found&quot;        # 数据不存在
    AUTHENTICATION_ERROR = &quot;auth_error&quot;       # 认证错误
    SERVER_ERROR = &quot;server_error&quot;            # 服务器错误
    TIMEOUT_ERROR = &quot;timeout_error&quot;          # 超时错误
    DATA_FORMAT_ERROR = &quot;format_error&quot;       # 数据格式错误

class ErrorHandler:
    &quot;&quot;&quot;统一错误处理器&quot;&quot;&quot;

    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.retry_config = config.get('retry_config', {})
        self.fallback_config = config.get('fallback_config', {})
        self.logger = logging.getLogger(__name__)

    async def handle_error(self, error: Exception, context: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;统一错误处理入口&quot;&quot;&quot;
        error_type = self._classify_error(error)

        self.logger.error(f&quot;Error occurred: {error_type} - {str(error)}&quot;)

        # 根据错误类型选择处理策略
        if error_type == ErrorType.API_LIMIT_ERROR:
            return await self._handle_api_limit_error(error, context)
        elif error_type == ErrorType.NETWORK_ERROR:
            return await self._handle_network_error(error, context)
        elif error_type == ErrorType.TIMEOUT_ERROR:
            return await self._handle_timeout_error(error, context)
        elif error_type == ErrorType.DATA_NOT_FOUND:
            return await self._handle_data_not_found_error(error, context)
        else:
            return await self._handle_generic_error(error, context)

    def _classify_error(self, error: Exception) -&gt; ErrorType:
        &quot;&quot;&quot;错误分类&quot;&quot;&quot;
        error_msg = str(error).lower()

        if 'rate limit' in error_msg or 'quota exceeded' in error_msg:
            return ErrorType.API_LIMIT_ERROR
        elif 'network' in error_msg or 'connection' in error_msg:
            return ErrorType.NETWORK_ERROR
        elif 'timeout' in error_msg:
            return ErrorType.TIMEOUT_ERROR
        elif 'not found' in error_msg or 'no data' in error_msg:
            return ErrorType.DATA_NOT_FOUND
        elif 'authentication' in error_msg or 'unauthorized' in error_msg:
            return ErrorType.AUTHENTICATION_ERROR
        elif 'server error' in error_msg or '500' in error_msg:
            return ErrorType.SERVER_ERROR
        else:
            return ErrorType.DATA_FORMAT_ERROR

    async def _handle_api_limit_error(self, error: Exception, context: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;处理API限流错误&quot;&quot;&quot;
        # 1. 切换到备用数据源
        self.logger.warning(&quot;API limit reached, switching to fallback data source&quot;)

        # 2. 尝试从缓存获取数据
        cache_manager = context.get('cache_manager')
        if cache_manager:
            stale_data = await cache_manager.get_stale(
                context.get('data_type'), 
                context.get('params')
            )
            if stale_data:
                return stale_data

        # 3. 使用备用数据源
        fallback_fetcher = context.get('fallback_fetcher')
        if fallback_fetcher:
            return await fallback_fetcher.fetch_data(
                context.get('data_type'),
                context.get('params')
            )

        raise error

    async def _handle_network_error(self, error: Exception, context: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;处理网络错误&quot;&quot;&quot;
        # 重试机制
        retry_count = context.get('retry_count', 0)
        max_retries = self.retry_config.get('max_retries', 3)

        if retry_count &lt; max_retries:
            self.logger.info(f&quot;Network error, retrying ({retry_count + 1}/{max_retries})&quot;)

            # 指数退避
            wait_time = 2 ** retry_count
            await asyncio.sleep(wait_time)

            # 更新重试次数
            context['retry_count'] = retry_count + 1

            # 重新尝试
            fetcher = context.get('fetcher')
            if fetcher:
                return await fetcher.fetch_data(
                    context.get('data_type'),
                    context.get('params')
                )

        # 重试失败，使用降级策略
        return await self._apply_fallback_strategy(error, context)

    async def _apply_fallback_strategy(self, error: Exception, context: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;应用降级策略&quot;&quot;&quot;
        # 1. 尝试从缓存获取过期数据
        cache_manager = context.get('cache_manager')
        if cache_manager:
            stale_data = await cache_manager.get_stale(
                context.get('data_type'),
                context.get('params')
            )
            if stale_data:
                self.logger.warning(&quot;Using stale cached data as fallback&quot;)
                return stale_data

        # 2. 使用备用数据源
        fallback_fetcher = context.get('fallback_fetcher')
        if fallback_fetcher:
            try:
                self.logger.warning(&quot;Using fallback data source&quot;)
                return await fallback_fetcher.fetch_data(
                    context.get('data_type'),
                    context.get('params')
                )
            except Exception as fallback_error:
                self.logger.error(f&quot;Fallback data source also failed: {str(fallback_error)}&quot;)

        # 3. 返回默认值或抛出异常
        default_data = self.fallback_config.get('default_data', {})
        if default_data:
            self.logger.warning(&quot;Using default fallback data&quot;)
            return default_data

        # 所有降级策略都失败，抛出原始异常
        raise error
</code></pre>
<h3 id="52">5.2 自动降级和恢复机制</h3>
<pre><code class="language-python">import asyncio
from datetime import datetime, timedelta
from typing import Dict, List

class AutoDegradationManager:
    &quot;&quot;&quot;自动降级管理器&quot;&quot;&quot;

    def __init__(self, data_source_manager, config: Dict[str, Any]):
        self.data_source_manager = data_source_manager
        self.config = config
        self.degradation_rules = config.get('degradation_rules', {})
        self.recovery_rules = config.get('recovery_rules', {})
        self.current_degradations = {}
        self.logger = logging.getLogger(__name__)

    async def evaluate_degradation(self, source: DataSourceType, error_history: List[Dict]):
        &quot;&quot;&quot;评估是否需要降级&quot;&quot;&quot;
        # 分析错误历史
        recent_errors = [e for e in error_history 
                        if datetime.now() - e['timestamp'] &lt; timedelta(minutes=5)]

        error_rate = len(recent_errors) / max(1, len(error_history))

        # 检查降级条件
        if error_rate &gt; self.degradation_rules.get('error_rate_threshold', 0.5):
            await self._trigger_degradation(source, 'high_error_rate')

        # 检查响应时间
        avg_response_time = sum(e.get('response_time', 0) for e in recent_errors) / max(1, len(recent_errors))
        if avg_response_time &gt; self.degradation_rules.get('response_time_threshold', 10.0):
            await self._trigger_degradation(source, 'slow_response')

    async def _trigger_degradation(self, source: DataSourceType, reason: str):
        &quot;&quot;&quot;触发降级&quot;&quot;&quot;
        if source not in self.current_degradations:
            self.current_degradations[source] = {
                'reason': reason,
                'start_time': datetime.now(),
                'attempts': 0
            }

            self.logger.warning(f&quot;Triggering degradation for {source}: {reason}&quot;)

            # 通知数据源管理器
            await self.data_source_manager.set_source_status(source, DataSourceStatus.DEGRADED)

    async def evaluate_recovery(self):
        &quot;&quot;&quot;评估恢复条件&quot;&quot;&quot;
        for source, degradation_info in list(self.current_degradations.items()):
            # 检查降级时间
            degradation_duration = datetime.now() - degradation_info['start_time']
            min_degradation_time = timedelta(minutes=self.recovery_rules.get('min_degradation_minutes', 5))

            if degradation_duration &gt; min_degradation_time:
                # 尝试恢复检查
                if await self._test_recovery(source):
                    await self._trigger_recovery(source)

    async def _test_recovery(self, source: DataSourceType) -&gt; bool:
        &quot;&quot;&quot;测试数据源是否可以恢复&quot;&quot;&quot;
        try:
            # 执行健康检查
            health_checker = self.data_source_manager.health_checker
            status = await health_checker.check_health(source)

            return status == DataSourceStatus.HEALTHY

        except Exception as e:
            self.logger.debug(f&quot;Recovery test failed for {source}: {str(e)}&quot;)
            return False

    async def _trigger_recovery(self, source: DataSourceType):
        &quot;&quot;&quot;触发恢复&quot;&quot;&quot;
        if source in self.current_degradations:
            degradation_info = self.current_degradations[source]
            duration = datetime.now() - degradation_info['start_time']

            self.logger.info(f&quot;Recovering {source} after {duration}&quot;)

            # 移除降级状态
            del self.current_degradations[source]

            # 通知数据源管理器
            await self.data_source_manager.set_source_status(source, DataSourceStatus.HEALTHY)

    async def start_monitoring(self):
        &quot;&quot;&quot;启动自动降级监控&quot;&quot;&quot;
        while True:
            try:
                await self.evaluate_recovery()
                await asyncio.sleep(30)  # 30秒检查一次
            except Exception as e:
                self.logger.error(f&quot;Auto degradation monitoring error: {str(e)}&quot;)
                await asyncio.sleep(60)
</code></pre>
<h2 id="6">6. 监控和告警系统</h2>
<h3 id="61">6.1 监控指标定义</h3>
<pre><code class="language-python">from dataclasses import dataclass
from typing import Dict, List, Optional
from datetime import datetime
import time

@dataclass
class MetricPoint:
    &quot;&quot;&quot;监控指标数据点&quot;&quot;&quot;
    name: str
    value: float
    timestamp: datetime
    tags: Dict[str, str]
    unit: str = &quot;&quot;

class MetricsCollector:
    &quot;&quot;&quot;指标收集器&quot;&quot;&quot;

    def __init__(self, config: Dict[str, Any]):
        self.config = config
        self.metrics_buffer = []
        self.counters = {}
        self.gauges = {}
        self.histograms = {}
        self.logger = logging.getLogger(__name__)

    def increment_counter(self, name: str, value: float = 1.0, tags: Dict[str, str] = None):
        &quot;&quot;&quot;递增计数器&quot;&quot;&quot;
        key = self._make_key(name, tags or {})
        self.counters[key] = self.counters.get(key, 0) + value

        self._add_metric_point(MetricPoint(
            name=name,
            value=self.counters[key],
            timestamp=datetime.now(),
            tags=tags or {},
            unit=&quot;count&quot;
        ))

    def set_gauge(self, name: str, value: float, tags: Dict[str, str] = None):
        &quot;&quot;&quot;设置仪表值&quot;&quot;&quot;
        key = self._make_key(name, tags or {})
        self.gauges[key] = value

        self._add_metric_point(MetricPoint(
            name=name,
            value=value,
            timestamp=datetime.now(),
            tags=tags or {},
            unit=&quot;gauge&quot;
        ))

    def record_histogram(self, name: str, value: float, tags: Dict[str, str] = None):
        &quot;&quot;&quot;记录直方图值&quot;&quot;&quot;
        key = self._make_key(name, tags or {})
        if key not in self.histograms:
            self.histograms[key] = []

        self.histograms[key].append(value)

        # 保持最近1000个值
        if len(self.histograms[key]) &gt; 1000:
            self.histograms[key] = self.histograms[key][-1000:]

        self._add_metric_point(MetricPoint(
            name=name,
            value=value,
            timestamp=datetime.now(),
            tags=tags or {},
            unit=&quot;histogram&quot;
        ))

    def _make_key(self, name: str, tags: Dict[str, str]) -&gt; str:
        &quot;&quot;&quot;生成指标键&quot;&quot;&quot;
        tag_str = &quot;,&quot;.join(f&quot;{k}={v}&quot; for k, v in sorted(tags.items()))
        return f&quot;{name}[{tag_str}]&quot;

    def _add_metric_point(self, metric: MetricPoint):
        &quot;&quot;&quot;添加指标点到缓冲区&quot;&quot;&quot;
        self.metrics_buffer.append(metric)

        # 缓冲区满时发送
        if len(self.metrics_buffer) &gt;= 100:
            asyncio.create_task(self._flush_metrics())

    async def _flush_metrics(self):
        &quot;&quot;&quot;刷新指标到监控系统&quot;&quot;&quot;
        if not self.metrics_buffer:
            return

        try:
            # 发送到Prometheus或其他监控系统
            await self._send_to_monitoring_system(self.metrics_buffer)
            self.metrics_buffer.clear()

        except Exception as e:
            self.logger.error(f&quot;Failed to flush metrics: {str(e)}&quot;)

    async def _send_to_monitoring_system(self, metrics: List[MetricPoint]):
        &quot;&quot;&quot;发送指标到监控系统&quot;&quot;&quot;
        # 这里可以集成Prometheus、InfluxDB等监控系统
        for metric in metrics:
            self.logger.debug(f&quot;Metric: {metric.name}={metric.value} {metric.tags}&quot;)

# 核心监控指标定义
CORE_METRICS = {
    # 数据源指标
    'data_source_requests_total': 'Counter - 数据源请求总数',
    'data_source_errors_total': 'Counter - 数据源错误总数',
    'data_source_response_time': 'Histogram - 数据源响应时间',
    'data_source_availability': 'Gauge - 数据源可用性',

    # 缓存指标
    'cache_hits_total': 'Counter - 缓存命中总数',
    'cache_misses_total': 'Counter - 缓存未命中总数',
    'cache_hit_ratio': 'Gauge - 缓存命中率',
    'cache_size_bytes': 'Gauge - 缓存大小',

    # API指标
    'api_requests_total': 'Counter - API请求总数',
    'api_response_time': 'Histogram - API响应时间',
    'api_errors_total': 'Counter - API错误总数',

    # 业务指标
    'valuation_calculations_total': 'Counter - 估值计算总数',
    'valuation_calculation_time': 'Histogram - 估值计算时间',
    'active_users': 'Gauge - 活跃用户数'
}
</code></pre>
<h3 id="62">6.2 告警规则配置</h3>
<pre><code class="language-yaml"># 告警规则配置
alert_rules:
  # 数据源告警
  data_source_down:
    metric: data_source_availability
    condition: &quot;&lt; 0.5&quot;
    duration: &quot;2m&quot;
    severity: critical
    message: &quot;数据源 {{$labels.source}} 不可用&quot;

  data_source_slow:
    metric: data_source_response_time
    condition: &quot;&gt; 10&quot;
    duration: &quot;5m&quot;
    severity: warning
    message: &quot;数据源 {{$labels.source}} 响应缓慢&quot;

  high_error_rate:
    metric: rate(data_source_errors_total[5m])
    condition: &quot;&gt; 0.1&quot;
    duration: &quot;3m&quot;
    severity: warning
    message: &quot;数据源 {{$labels.source}} 错误率过高&quot;

  # 缓存告警
  low_cache_hit_ratio:
    metric: cache_hit_ratio
    condition: &quot;&lt; 0.7&quot;
    duration: &quot;10m&quot;
    severity: warning
    message: &quot;缓存命中率过低: {{$value}}&quot;

  cache_size_high:
    metric: cache_size_bytes
    condition: &quot;&gt; 8GB&quot;
    duration: &quot;5m&quot;
    severity: warning
    message: &quot;缓存使用量过高: {{$value}}&quot;

  # API告警
  api_response_slow:
    metric: api_response_time
    condition: &quot;&gt; 5&quot;
    duration: &quot;5m&quot;
    severity: warning
    message: &quot;API响应时间过长: {{$value}}s&quot;

  api_error_rate_high:
    metric: rate(api_errors_total[5m])
    condition: &quot;&gt; 0.05&quot;
    duration: &quot;3m&quot;
    severity: critical
    message: &quot;API错误率过高: {{$value}}&quot;

# 告警通知配置
notification_channels:
  email:
    enabled: true
    smtp_server: &quot;smtp.example.com&quot;
    recipients: [&quot;admin@example.com&quot;]

  slack:
    enabled: true
    webhook_url: &quot;https://hooks.slack.com/services/...&quot;
    channel: &quot;#alerts&quot;

  webhook:
    enabled: false
    url: &quot;https://api.example.com/alerts&quot;
</code></pre>
<h3 id="63">6.3 监控仪表板</h3>
<pre><code class="language-python">class MonitoringDashboard:
    &quot;&quot;&quot;监控仪表板&quot;&quot;&quot;

    def __init__(self, metrics_collector: MetricsCollector):
        self.metrics_collector = metrics_collector
        self.dashboard_config = self._load_dashboard_config()

    def _load_dashboard_config(self) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;加载仪表板配置&quot;&quot;&quot;
        return {
            'panels': [
                {
                    'title': '数据源状态',
                    'type': 'stat',
                    'metrics': ['data_source_availability'],
                    'thresholds': [0.9, 0.95]
                },
                {
                    'title': '响应时间趋势',
                    'type': 'graph',
                    'metrics': ['data_source_response_time', 'api_response_time'],
                    'time_range': '1h'
                },
                {
                    'title': '缓存性能',
                    'type': 'graph',
                    'metrics': ['cache_hit_ratio', 'cache_hits_total', 'cache_misses_total'],
                    'time_range': '6h'
                },
                {
                    'title': '错误率统计',
                    'type': 'graph',
                    'metrics': ['data_source_errors_total', 'api_errors_total'],
                    'time_range': '24h'
                },
                {
                    'title': '业务指标',
                    'type': 'stat',
                    'metrics': ['valuation_calculations_total', 'active_users'],
                    'time_range': '1d'
                }
            ]
        }

    async def get_dashboard_data(self) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;获取仪表板数据&quot;&quot;&quot;
        dashboard_data = {
            'timestamp': datetime.now().isoformat(),
            'panels': []
        }

        for panel_config in self.dashboard_config['panels']:
            panel_data = await self._get_panel_data(panel_config)
            dashboard_data['panels'].append(panel_data)

        return dashboard_data

    async def _get_panel_data(self, panel_config: Dict[str, Any]) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;获取面板数据&quot;&quot;&quot;
        panel_data = {
            'title': panel_config['title'],
            'type': panel_config['type'],
            'data': []
        }

        for metric_name in panel_config['metrics']:
            metric_data = await self._get_metric_data(
                metric_name, 
                panel_config.get('time_range', '1h')
            )
            panel_data['data'].append(metric_data)

        return panel_data

    async def _get_metric_data(self, metric_name: str, time_range: str) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;获取指标数据&quot;&quot;&quot;
        # 这里应该从时序数据库查询数据
        # 为了示例，返回模拟数据
        return {
            'metric': metric_name,
            'values': [],  # 实际的时序数据点
            'current_value': 0.0,
            'trend': 'stable'  # up, down, stable
        }
</code></pre>
<h2 id="7">7. 配置管理</h2>
<h3 id="71">7.1 环境配置文件</h3>
<pre><code class="language-bash"># .env 配置文件

# ==================== 数据源配置 ====================
# 主数据源选择: tushare, postgresql
PRIMARY_DATA_SOURCE=tushare

# 备用数据源选择: postgresql, tushare
FALLBACK_DATA_SOURCE=postgresql

# 强制使用指定数据源 (可选): tushare, postgresql
# FORCE_DATA_SOURCE=tushare

# ==================== Tushare配置 ====================
TUSHARE_TOKEN=your_tushare_token_here
TUSHARE_API_URL=http://api.tushare.pro
TUSHARE_TIMEOUT=30
TUSHARE_MAX_RETRIES=3
TUSHARE_RETRY_DELAY=1

# API配额管理
TUSHARE_DAILY_LIMIT=10000
TUSHARE_MINUTE_LIMIT=500
TUSHARE_ENABLE_QUOTA_CHECK=true

# ==================== PostgreSQL配置 ====================
POSTGRESQL_HOST=localhost
POSTGRESQL_PORT=5432
POSTGRESQL_DATABASE=stock_valuation
POSTGRESQL_USERNAME=postgres
POSTGRESQL_PASSWORD=your_password_here
POSTGRESQL_POOL_SIZE=10
POSTGRESQL_MAX_OVERFLOW=20
POSTGRESQL_POOL_TIMEOUT=30

# ==================== Redis缓存配置 ====================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_MAX_CONNECTIONS=10
REDIS_SOCKET_TIMEOUT=5

# ==================== 缓存策略配置 ====================
# 启用缓存层级: memory, redis, file
ENABLE_MEMORY_CACHE=true
ENABLE_REDIS_CACHE=true
ENABLE_FILE_CACHE=true

# 缓存目录
FILE_CACHE_DIR=./cache

# 缓存TTL (秒)
CACHE_TTL_STOCK_BASIC_MEMORY=3600
CACHE_TTL_STOCK_BASIC_REDIS=86400
CACHE_TTL_DAILY_BASIC_MEMORY=1800
CACHE_TTL_DAILY_BASIC_REDIS=3600
CACHE_TTL_FINANCIAL_DATA_MEMORY=7200
CACHE_TTL_FINANCIAL_DATA_REDIS=43200

# ==================== 健康检查配置 ====================
HEALTH_CHECK_INTERVAL=60
HEALTH_CHECK_TIMEOUT=10
HEALTH_CHECK_RETRY_COUNT=3

# 健康状态阈值
HEALTH_RESPONSE_TIME_HEALTHY=2.0
HEALTH_RESPONSE_TIME_DEGRADED=5.0

# ==================== 降级策略配置 ====================
# 启用自动降级
ENABLE_AUTO_DEGRADATION=true

# 降级触发条件
DEGRADATION_ERROR_RATE_THRESHOLD=0.5
DEGRADATION_RESPONSE_TIME_THRESHOLD=10.0
DEGRADATION_MIN_DURATION_MINUTES=5

# 恢复条件
RECOVERY_SUCCESS_RATE_THRESHOLD=0.9
RECOVERY_TEST_INTERVAL=30

# ==================== 监控告警配置 ====================
# 启用监控
ENABLE_MONITORING=true
MONITORING_INTERVAL=30

# Prometheus配置
PROMETHEUS_ENABLED=false
PROMETHEUS_HOST=localhost
PROMETHEUS_PORT=9090

# 告警配置
ALERT_EMAIL_ENABLED=true
ALERT_EMAIL_SMTP_SERVER=smtp.example.com
ALERT_EMAIL_RECIPIENTS=admin@example.com

ALERT_SLACK_ENABLED=false
ALERT_SLACK_WEBHOOK_URL=

# ==================== 日志配置 ====================
LOG_LEVEL=INFO
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
LOG_FILE_PATH=./logs/stock_valuation.log
LOG_MAX_SIZE=100MB
LOG_BACKUP_COUNT=5

# ==================== 性能配置 ====================
# 连接池配置
CONNECTION_POOL_SIZE=10
CONNECTION_POOL_MAX_OVERFLOW=20
CONNECTION_POOL_TIMEOUT=30

# 异步配置
ASYNC_WORKER_COUNT=4
ASYNC_QUEUE_SIZE=1000

# 限流配置
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS_PER_MINUTE=1000
RATE_LIMIT_BURST_SIZE=100
</code></pre>
<h3 id="72">7.2 配置加载器</h3>
<pre><code class="language-python">import os
from typing import Dict, Any, Optional
from dataclasses import dataclass
from pathlib import Path

@dataclass
class DataSourceConfig:
    &quot;&quot;&quot;数据源配置&quot;&quot;&quot;
    primary_source: str
    fallback_source: str
    force_source: Optional[str] = None

@dataclass
class TushareConfig:
    &quot;&quot;&quot;Tushare配置&quot;&quot;&quot;
    token: str
    api_url: str = &quot;http://api.tushare.pro&quot;
    timeout: int = 30
    max_retries: int = 3
    retry_delay: int = 1
    daily_limit: int = 10000
    minute_limit: int = 500
    enable_quota_check: bool = True

@dataclass
class PostgreSQLConfig:
    &quot;&quot;&quot;PostgreSQL配置&quot;&quot;&quot;
    host: str = &quot;localhost&quot;
    port: int = 5432
    database: str = &quot;stock_valuation&quot;
    username: str = &quot;postgres&quot;
    password: str = &quot;&quot;
    pool_size: int = 10
    max_overflow: int = 20
    pool_timeout: int = 30

@dataclass
class CacheConfig:
    &quot;&quot;&quot;缓存配置&quot;&quot;&quot;
    enable_memory: bool = True
    enable_redis: bool = True
    enable_file: bool = True
    file_cache_dir: str = &quot;./cache&quot;
    redis_host: str = &quot;localhost&quot;
    redis_port: int = 6379
    redis_db: int = 0
    redis_password: str = &quot;&quot;

class ConfigLoader:
    &quot;&quot;&quot;配置加载器&quot;&quot;&quot;

    def __init__(self, env_file: str = &quot;.env&quot;):
        self.env_file = env_file
        self._load_env_file()

    def _load_env_file(self):
        &quot;&quot;&quot;加载环境变量文件&quot;&quot;&quot;
        if Path(self.env_file).exists():
            with open(self.env_file, 'r') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        os.environ[key.strip()] = value.strip()

    def get_data_source_config(self) -&gt; DataSourceConfig:
        &quot;&quot;&quot;获取数据源配置&quot;&quot;&quot;
        return DataSourceConfig(
            primary_source=os.getenv('PRIMARY_DATA_SOURCE', 'tushare'),
            fallback_source=os.getenv('FALLBACK_DATA_SOURCE', 'postgresql'),
            force_source=os.getenv('FORCE_DATA_SOURCE')
        )

    def get_tushare_config(self) -&gt; TushareConfig:
        &quot;&quot;&quot;获取Tushare配置&quot;&quot;&quot;
        token = os.getenv('TUSHARE_TOKEN')
        if not token:
            raise ValueError(&quot;TUSHARE_TOKEN is required&quot;)

        return TushareConfig(
            token=token,
            api_url=os.getenv('TUSHARE_API_URL', 'http://api.tushare.pro'),
            timeout=int(os.getenv('TUSHARE_TIMEOUT', '30')),
            max_retries=int(os.getenv('TUSHARE_MAX_RETRIES', '3')),
            retry_delay=int(os.getenv('TUSHARE_RETRY_DELAY', '1')),
            daily_limit=int(os.getenv('TUSHARE_DAILY_LIMIT', '10000')),
            minute_limit=int(os.getenv('TUSHARE_MINUTE_LIMIT', '500')),
            enable_quota_check=os.getenv('TUSHARE_ENABLE_QUOTA_CHECK', 'true').lower() == 'true'
        )

    def get_postgresql_config(self) -&gt; PostgreSQLConfig:
        &quot;&quot;&quot;获取PostgreSQL配置&quot;&quot;&quot;
        return PostgreSQLConfig(
            host=os.getenv('POSTGRESQL_HOST', 'localhost'),
            port=int(os.getenv('POSTGRESQL_PORT', '5432')),
            database=os.getenv('POSTGRESQL_DATABASE', 'stock_valuation'),
            username=os.getenv('POSTGRESQL_USERNAME', 'postgres'),
            password=os.getenv('POSTGRESQL_PASSWORD', ''),
            pool_size=int(os.getenv('POSTGRESQL_POOL_SIZE', '10')),
            max_overflow=int(os.getenv('POSTGRESQL_MAX_OVERFLOW', '20')),
            pool_timeout=int(os.getenv('POSTGRESQL_POOL_TIMEOUT', '30'))
        )

    def get_cache_config(self) -&gt; CacheConfig:
        &quot;&quot;&quot;获取缓存配置&quot;&quot;&quot;
        return CacheConfig(
            enable_memory=os.getenv('ENABLE_MEMORY_CACHE', 'true').lower() == 'true',
            enable_redis=os.getenv('ENABLE_REDIS_CACHE', 'true').lower() == 'true',
            enable_file=os.getenv('ENABLE_FILE_CACHE', 'true').lower() == 'true',
            file_cache_dir=os.getenv('FILE_CACHE_DIR', './cache'),
            redis_host=os.getenv('REDIS_HOST', 'localhost'),
            redis_port=int(os.getenv('REDIS_PORT', '6379')),
            redis_db=int(os.getenv('REDIS_DB', '0')),
            redis_password=os.getenv('REDIS_PASSWORD', '')
        )

    def get_full_config(self) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;获取完整配置&quot;&quot;&quot;
        return {
            'data_source': self.get_data_source_config(),
            'tushare': self.get_tushare_config(),
            'postgresql': self.get_postgresql_config(),
            'cache': self.get_cache_config(),
            'monitoring': {
                'enabled': os.getenv('ENABLE_MONITORING', 'true').lower() == 'true',
                'interval': int(os.getenv('MONITORING_INTERVAL', '30'))
            },
            'logging': {
                'level': os.getenv('LOG_LEVEL', 'INFO'),
                'format': os.getenv('LOG_FORMAT', '%(asctime)s - %(name)s - %(levelname)s - %(message)s'),
                'file_path': os.getenv('LOG_FILE_PATH', './logs/stock_valuation.log')
            }
        }
</code></pre>
<h2 id="8">8. 部署方案</h2>
<h3 id="81-docker">8.1 Docker容器化部署</h3>
<pre><code class="language-dockerfile"># Dockerfile
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update &amp;&amp; apt-get install -y \
    gcc \
    g++ \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建缓存目录
RUN mkdir -p /app/cache /app/logs

# 设置环境变量
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# 暴露端口
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 启动命令
CMD [&quot;python&quot;, &quot;-m&quot;, &quot;uvicorn&quot;, &quot;main:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]
</code></pre>
<pre><code class="language-yaml"># docker-compose.yml
version: '3.8'

services:
  stock-valuation:
    build: .
    ports:
      - &quot;8000:8000&quot;
    environment:
      - PRIMARY_DATA_SOURCE=tushare
      - FALLBACK_DATA_SOURCE=postgresql
      - TUSHARE_TOKEN=${TUSHARE_TOKEN}
      - POSTGRESQL_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis
    volumes:
      - ./cache:/app/cache
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - stock-network

  postgres:
    image: postgres:13
    environment:
      - POSTGRES_DB=stock_valuation
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - &quot;5432:5432&quot;
    restart: unless-stopped
    networks:
      - stock-network

  redis:
    image: redis:6-alpine
    ports:
      - &quot;6379:6379&quot;
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - stock-network

  prometheus:
    image: prom/prometheus:latest
    ports:
      - &quot;9090:9090&quot;
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    restart: unless-stopped
    networks:
      - stock-network

  grafana:
    image: grafana/grafana:latest
    ports:
      - &quot;3000:3000&quot;
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    restart: unless-stopped
    networks:
      - stock-network

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  stock-network:
    driver: bridge
</code></pre>
<h3 id="82-kubernetes">8.2 Kubernetes部署</h3>
<pre><code class="language-yaml"># k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stock-valuation
  labels:
    app: stock-valuation
spec:
  replicas: 3
  selector:
    matchLabels:
      app: stock-valuation
  template:
    metadata:
      labels:
        app: stock-valuation
    spec:
      containers:
      - name: stock-valuation
        image: stock-valuation:latest
        ports:
        - containerPort: 8000
        env:
        - name: PRIMARY_DATA_SOURCE
          value: &quot;tushare&quot;
        - name: FALLBACK_DATA_SOURCE
          value: &quot;postgresql&quot;
        - name: TUSHARE_TOKEN
          valueFrom:
            secretKeyRef:
              name: tushare-secret
              key: token
        - name: POSTGRESQL_HOST
          value: &quot;postgres-service&quot;
        - name: REDIS_HOST
          value: &quot;redis-service&quot;
        resources:
          requests:
            memory: &quot;512Mi&quot;
            cpu: &quot;250m&quot;
          limits:
            memory: &quot;1Gi&quot;
            cpu: &quot;500m&quot;
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
        volumeMounts:
        - name: cache-volume
          mountPath: /app/cache
        - name: logs-volume
          mountPath: /app/logs
      volumes:
      - name: cache-volume
        emptyDir: {}
      - name: logs-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: stock-valuation-service
spec:
  selector:
    app: stock-valuation
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: LoadBalancer
</code></pre>
<h2 id="9">9. 实施计划</h2>
<h3 id="91">9.1 实施阶段划分</h3>
<h4 id="1-2">第一阶段：基础架构搭建 (1-2周)</h4>
<p><strong>目标</strong>: 建立混合数据源的基础框架</p>
<p><strong>任务清单</strong>:
- [ ] 创建DataSourceManager核心类
- [ ] 实现TushareDataFetcher
- [ ] 实现PostgreSQLDataFetcher
- [ ] 建立基础的配置管理系统
- [ ] 实现简单的数据源切换逻辑</p>
<p><strong>验收标准</strong>:
- 能够通过配置切换数据源
- 基本的数据获取功能正常
- 单元测试覆盖率达到80%</p>
<h4 id="1-2_1">第二阶段：缓存系统实现 (1-2周)</h4>
<p><strong>目标</strong>: 实现多层级缓存机制</p>
<p><strong>任务清单</strong>:
- [ ] 实现CacheManager类
- [ ] 集成Redis缓存
- [ ] 实现本地文件缓存
- [ ] 建立缓存失效策略
- [ ] 优化缓存键生成算法</p>
<p><strong>验收标准</strong>:
- 缓存命中率达到70%以上
- 缓存数据一致性保证
- 缓存性能测试通过</p>
<h4 id="1_1">第三阶段：健康检查和降级 (1周)</h4>
<p><strong>目标</strong>: 实现自动健康检查和降级机制</p>
<p><strong>任务清单</strong>:
- [ ] 实现HealthChecker类
- [ ] 建立数据源状态监控
- [ ] 实现自动降级逻辑
- [ ] 建立恢复机制
- [ ] 实现错误处理策略</p>
<p><strong>验收标准</strong>:
- 数据源故障自动检测
- 降级切换时间&lt;5秒
- 恢复机制正常工作</p>
<h4 id="1_2">第四阶段：监控告警系统 (1周)</h4>
<p><strong>目标</strong>: 建立完整的监控告警体系</p>
<p><strong>任务清单</strong>:
- [ ] 实现MetricsCollector
- [ ] 集成Prometheus监控
- [ ] 建立告警规则
- [ ] 创建监控仪表板
- [ ] 实现告警通知</p>
<p><strong>验收标准</strong>:
- 关键指标监控覆盖
- 告警及时准确
- 仪表板数据完整</p>
<h4 id="1-2_2">第五阶段：性能优化和测试 (1-2周)</h4>
<p><strong>目标</strong>: 系统性能优化和全面测试</p>
<p><strong>任务清单</strong>:
- [ ] 性能压力测试
- [ ] 并发安全测试
- [ ] 故障恢复测试
- [ ] 数据一致性测试
- [ ] 用户验收测试</p>
<p><strong>验收标准</strong>:
- 系统响应时间&lt;2秒
- 并发用户数&gt;100
- 数据准确性99.9%
- 系统可用性99.5%</p>
<h3 id="92">9.2 风险控制措施</h3>
<h4 id="_6">技术风险</h4>
<table>
<thead>
<tr>
<th>风险项</th>
<th>风险等级</th>
<th>影响</th>
<th>应对措施</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tushare API变更</td>
<td>中</td>
<td>数据获取失败</td>
<td>版本锁定、适配层设计</td>
</tr>
<tr>
<td>数据源同步延迟</td>
<td>中</td>
<td>数据不一致</td>
<td>时间戳校验、增量同步</td>
</tr>
<tr>
<td>缓存数据过期</td>
<td>低</td>
<td>性能下降</td>
<td>智能预加载、过期策略</td>
</tr>
<tr>
<td>并发访问冲突</td>
<td>中</td>
<td>数据错误</td>
<td>锁机制、队列管理</td>
</tr>
</tbody>
</table>
<h4 id="_7">业务风险</h4>
<table>
<thead>
<tr>
<th>风险项</th>
<th>风险等级</th>
<th>影响</th>
<th>应对措施</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据源成本上升</td>
<td>中</td>
<td>运营成本增加</td>
<td>成本监控、用量优化</td>
</tr>
<tr>
<td>服务中断</td>
<td>高</td>
<td>业务停止</td>
<td>多重备份、快速恢复</td>
</tr>
<tr>
<td>数据质量问题</td>
<td>中</td>
<td>计算错误</td>
<td>数据校验、质量监控</td>
</tr>
</tbody>
</table>
<h3 id="93">9.3 成功指标</h3>
<h4 id="_8">技术指标</h4>
<ul>
<li><strong>系统可用性</strong>: ≥99.5%</li>
<li><strong>响应时间</strong>: ≤2秒 (95%请求)</li>
<li><strong>缓存命中率</strong>: ≥70%</li>
<li><strong>错误率</strong>: ≤0.1%</li>
<li><strong>数据准确性</strong>: ≥99.9%</li>
</ul>
<h4 id="_9">业务指标</h4>
<ul>
<li><strong>API调用成本</strong>: 降低60%</li>
<li><strong>数据更新频率</strong>: 提升50%</li>
<li><strong>用户满意度</strong>: ≥90%</li>
<li><strong>系统维护成本</strong>: 降低40%</li>
</ul>
<h2 id="10">10. 总结</h2>
<h3 id="101">10.1 架构优势总结</h3>
<ol>
<li><strong>高可靠性</strong>: 双数据源保障，单点故障风险降低90%</li>
<li><strong>高性能</strong>: 多层缓存机制，数据访问速度提升70%</li>
<li><strong>成本优化</strong>: 智能API调用管理，成本降低60%</li>
<li><strong>易维护</strong>: 模块化设计，维护成本降低40%</li>
<li><strong>可扩展</strong>: 支持新数据源接入，扩展性强</li>
</ol>
<h3 id="102">10.2 关键技术创新</h3>
<ul>
<li><strong>智能数据源路由</strong>: 基于健康状态和性能的动态选择</li>
<li><strong>多层级缓存</strong>: 内存+Redis+文件的三级缓存体系</li>
<li><strong>自动降级恢复</strong>: 无人工干预的故障处理机制</li>
<li><strong>实时监控告警</strong>: 全方位的系统状态监控</li>
</ul>
<h3 id="103">10.3 后续发展方向</h3>
<ol>
<li><strong>AI驱动优化</strong>: 基于机器学习的缓存策略优化</li>
<li><strong>多云部署</strong>: 支持多云环境的数据源分布</li>
<li><strong>实时流处理</strong>: 集成流式数据处理能力</li>
<li><strong>边缘计算</strong>: 支持边缘节点的数据缓存</li>
</ol>
<hr />
<p><strong>文档版本</strong>: v1.0<br />
<strong>最后更新</strong>: 2025年1月<br />
<strong>下次审核</strong>: 2025年3月</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>