<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>部署运维指南 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">01 project overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01_project_overview/" class="dropdown-item">项目概览文档</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_analysis_report/" class="dropdown-item">股票估值系统项目分析报告</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_status_2025_09_latest/" class="dropdown-item">股票估值系统项目状态报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">02 architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../02_architecture/" class="dropdown-item">架构设计文档</a>
</li>
                                    
<li>
    <a href="../../02_architecture/dcf_architecture/" class="dropdown-item">DCF 核心业务逻辑与架构</a>
</li>
                                    
<li>
    <a href="../../02_architecture/hybrid_architecture_design/" class="dropdown-item">股票估值系统混合架构设计文档</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">03 development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../03_development/" class="dropdown-item">开发文档</a>
</li>
                                    
<li>
    <a href="../../03_development/development_guide_2025_09/" class="dropdown-item">股票估值系统开发指南</a>
</li>
                                    
<li>
    <a href="../../03_development/testing_strategy_2025_09/" class="dropdown-item">测试策略与质量保障指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">04 deployment</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">部署运维文档</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">部署运维指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">05 data sources</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../05_data_sources/" class="dropdown-item">数据源专题文档</a>
</li>
                                    
<li>
    <a href="../../05_data_sources/tushare_alignment/" class="dropdown-item">TuShare数据源对齐与生产部署报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Archived</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../archived/" class="dropdown-item">归档文档</a>
</li>
                                    
<li>
    <a href="../../archived/Stock_investment_decision_making_process/" class="dropdown-item">Stock investment decision making process</a>
</li>
                                    
<li>
    <a href="../../archived/api_backend_comprehensive_analysis/" class="dropdown-item">Stock Valuation API 后端接口详细分析文档</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_industry_standards_comprehensive_analysis/" class="dropdown-item">DCF估值项目与行业标准深度对比分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_optimization_plan/" class="dropdown-item">DCF 核心业务逻辑优化方案（v1）</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_rolling_revaluation_guide/" class="dropdown-item">DCF 滚动重评实践指南（季度/中报更新版）</a>
</li>
                                    
<li>
    <a href="../../archived/directory_optimization_plan/" class="dropdown-item">项目目录结构优化方案</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_financial_ratios_and_forecasting_analysis/" class="dropdown-item">Stock Vale Valuation 3.0 财务比率与预测逻辑 McKinsey 标准合规性专题分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_standards_compliance_report/" class="dropdown-item">Stock Vale Valuation 3.0 项目 McKinsey 标准合规性分析报告</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../05_data_sources/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#_1" class="nav-link">部署运维指南</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">概述</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">部署架构</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_5" class="nav-link">环境要求</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_8" class="nav-link">部署方式</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_14" class="nav-link">配置管理</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_19" class="nav-link">监控和日志</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_26" class="nav-link">备份和恢复</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_34" class="nav-link">安全配置</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_36" class="nav-link">故障排查</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_40" class="nav-link">扩展和优化</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_46" class="nav-link">维护计划</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">部署运维指南</h1>
<p><em>最后更新: 2025-09-26</em></p>
<h2 id="_2">概述</h2>
<p>本指南提供股票估值系统的完整部署、运维和监控方案。项目已达到生产级标准，支持多种部署方式和运维策略。</p>
<h3 id="v3002025-09-26">v3.0.0重要更新(2025-09-26)</h3>
<ul>
<li><strong>用户认证系统</strong>: 数据库架构从SQLite迁移至PostgreSQL/Supabase，支持高并发生产环境</li>
<li><strong>智能缓存系统</strong>: 估值结果持久化缓存，大幅提升用户体验和系统性能</li>
<li><strong>会话管理</strong>: 用户登录状态和数据会话恢复功能</li>
<li><strong>安全增强</strong>: 认证中间件、密码哈希、会话令牌等完整安全体系</li>
<li><strong>UI/UX优化</strong>: 前端界面和用户体验重大改进</li>
</ul>
<h2 id="_3">部署架构</h2>
<h3 id="_4">系统组件</h3>
<pre><code>┌─────────────────────────────────────────────────────┐
│                  Load Balancer                      │
├─────────────────────────────────────────────────────┤
│              Frontend Layer                         │
│  ┌─────────────────────────────────────────────────┐│
│  │         Streamlit App                           ││
│  │         Port: 8501                              ││
│  └─────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────┤
│              API Layer                              │
│  ┌─────────────────────────────────────────────────┐│
│  │         FastAPI Service                         ││
│  │         Port: 8124                              ││
│  └─────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────┤
│              Data Layer                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐│
│  │ TuShare API │ │ PostgreSQL  │ │ Redis (Cache)   ││
│  │ (External)  │ │ Port: 5432  │ │ Port: 6379      ││
│  └─────────────┘ └─────────────┘ └─────────────────┘│
└─────────────────────────────────────────────────────┘
</code></pre>
<h2 id="_5">环境要求</h2>
<h3 id="_6">硬件要求</h3>
<p><strong>生产环境</strong>:
- CPU: 4核心以上
- 内存: 8GB以上
- 磁盘: 50GB SSD
- 网络: 100Mbps带宽</p>
<p><strong>开发环境</strong>:
- CPU: 2核心以上
- 内存: 4GB以上
- 磁盘: 20GB可用空间</p>
<h3 id="_7">软件依赖</h3>
<ul>
<li>Python 3.9+</li>
<li>uv包管理器 (推荐) 或 pip</li>
<li>PostgreSQL 12+ (可选)</li>
<li>Redis 6+ (可选)</li>
<li>Nginx (生产环境)</li>
<li>Docker &amp; Docker Compose (容器化部署)</li>
</ul>
<h2 id="_8">部署方式</h2>
<h3 id="1">1. 本地开发部署</h3>
<h4 id="_9">快速启动</h4>
<pre><code class="language-bash"># 1. 环境准备
git clone &lt;repository-url&gt;
cd stock_vale_valuation_3.0
uv venv &amp;&amp; source .venv/bin/activate
uv pip install -e &quot;.[dev]&quot;

# 2. 配置环境
cp .env.example .env
# 编辑.env文件配置必要参数

# 3. 启动服务
# 启动API服务
uvicorn src.api.main:app --reload --port 8124 &amp;

# 启动Streamlit前端
streamlit run frontend-streamlit/streamlit_app.py --server.port 8501 &amp;
</code></pre>
<h4 id="_10">服务验证</h4>
<pre><code class="language-bash"># 检查API服务
curl http://localhost:8124/

# 检查Streamlit前端
curl http://localhost:8501/

# 运行健康检查
curl http://localhost:8124/health
</code></pre>
<h3 id="2-docker">2. Docker容器化部署</h3>
<h4 id="dockerfile">Dockerfile示例</h4>
<pre><code class="language-dockerfile">FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update &amp;&amp; apt-get install -y \
    gcc \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# 安装uv包管理器
RUN pip install uv

# 复制项目文件
COPY . .

# 安装Python依赖
RUN uv pip install --system -e &quot;.[prod]&quot;

# 暴露端口
EXPOSE 8124 8501

# 启动脚本
CMD [&quot;bash&quot;, &quot;scripts/start.sh&quot;]
</code></pre>
<h4 id="docker-compose">Docker Compose配置</h4>
<pre><code class="language-yaml">version: '3.8'

services:
  api:
    build: .
    ports:
      - &quot;8124:8124&quot;
    environment:
      - DATA_SOURCE=tushare
      - TUSHARE_TOKEN=${TUSHARE_TOKEN}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    depends_on:
      - redis
    restart: unless-stopped

  streamlit:
    build: .
    ports:
      - &quot;8501:8501&quot;
    environment:
      - API_BASE_URL=http://api:8124
    depends_on:
      - api
    restart: unless-stopped
    command: [&quot;streamlit&quot;, &quot;run&quot;, &quot;frontend-streamlit/streamlit_app.py&quot;, &quot;--server.port&quot;, &quot;8501&quot;, &quot;--server.address&quot;, &quot;0.0.0.0&quot;]

  redis:
    image: redis:6-alpine
    ports:
      - &quot;6379:6379&quot;
    restart: unless-stopped

  postgres:
    image: postgres:13-alpine
    environment:
      - POSTGRES_DB=stock_valuation
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - &quot;5432:5432&quot;
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - &quot;80:80&quot;
      - &quot;443:443&quot;
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
      - streamlit
    restart: unless-stopped

volumes:
  postgres_data:
</code></pre>
<h4 id="_11">启动容器服务</h4>
<pre><code class="language-bash"># 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f api

# 停止服务
docker-compose down
</code></pre>
<h3 id="3-kubernetes">3. Kubernetes部署</h3>
<h4 id="_12">命名空间和配置</h4>
<pre><code class="language-yaml"># namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: stock-valuation

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: stock-valuation
data:
  DATA_SOURCE: &quot;tushare&quot;
  OCL_AGGREGATION_MODE: &quot;standard&quot;
  API_BASE_URL: &quot;http://api-service:8124&quot;

---
# secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: stock-valuation
type: Opaque
data:
  TUSHARE_TOKEN: &lt;base64-encoded-token&gt;
  DEEPSEEK_API_KEY: &lt;base64-encoded-key&gt;
</code></pre>
<h4 id="_13">应用部署</h4>
<pre><code class="language-yaml"># api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-deployment
  namespace: stock-valuation
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      containers:
      - name: api
        image: stock-valuation:latest
        ports:
        - containerPort: 8124
        env:
        - name: DATA_SOURCE
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DATA_SOURCE
        - name: TUSHARE_TOKEN
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: TUSHARE_TOKEN
        resources:
          requests:
            memory: &quot;1Gi&quot;
            cpu: &quot;500m&quot;
          limits:
            memory: &quot;2Gi&quot;
            cpu: &quot;1000m&quot;
        livenessProbe:
          httpGet:
            path: /health
            port: 8124
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8124
          initialDelaySeconds: 5
          periodSeconds: 5

---
# api-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: api-service
  namespace: stock-valuation
spec:
  selector:
    app: api
  ports:
  - protocol: TCP
    port: 8124
    targetPort: 8124
  type: ClusterIP
</code></pre>
<h3 id="4">4. 云服务部署</h3>
<h4 id="aws">AWS部署</h4>
<pre><code class="language-bash"># 使用AWS ECS
aws ecs create-cluster --cluster-name stock-valuation

# 创建任务定义
aws ecs register-task-definition --cli-input-json file://task-definition.json

# 创建服务
aws ecs create-service \
  --cluster stock-valuation \
  --service-name api-service \
  --task-definition stock-valuation-api:1 \
  --desired-count 2
</code></pre>
<h4 id="azure">Azure部署</h4>
<pre><code class="language-bash"># 创建容器实例
az container create \
  --resource-group myResourceGroup \
  --name stock-valuation-api \
  --image stock-valuation:latest \
  --ports 8124 \
  --environment-variables DATA_SOURCE=tushare
</code></pre>
<h2 id="_14">配置管理</h2>
<h3 id="_15">环境变量配置</h3>
<h4 id="_16">核心配置</h4>
<pre><code class="language-bash"># 数据源配置
DATA_SOURCE=tushare  # tushare/postgres/hybrid
TUSHARE_TOKEN=your_token
OCL_AGGREGATION_MODE=standard

# LLM配置
LLM_PROVIDER=deepseek
DEEPSEEK_API_KEY=your_key
DEEPSEEK_MODEL_NAME=deepseek-chat

# 数据库配置(可选)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=stock_valuation
DB_USER=admin
DB_PASSWORD=password

# Redis配置(可选)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# API配置
API_BASE_URL=http://localhost:8124
CORS_ORIGINS=[&quot;http://localhost:8501&quot;]

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
</code></pre>
<h4 id="_17">环境特定配置</h4>
<pre><code class="language-bash"># 开发环境
cp .env.example .env.dev
# 编辑开发配置

# 测试环境
cp .env.example .env.test
# 编辑测试配置

# 生产环境
cp .env.example .env.prod
# 编辑生产配置
</code></pre>
<h3 id="_18">配置验证</h3>
<pre><code class="language-bash"># 验证配置完整性
python scripts/validate_config.py

# 测试数据源连接
python scripts/test_data_source.py

# 验证API可达性
python scripts/health_check.py
</code></pre>
<h2 id="_19">监控和日志</h2>
<h3 id="_20">健康检查</h3>
<h4 id="api">API健康检查</h4>
<pre><code class="language-python"># 自定义健康检查端点
@app.get(&quot;/health&quot;)
async def health_check():
    return {
        &quot;status&quot;: &quot;healthy&quot;,
        &quot;timestamp&quot;: datetime.now().isoformat(),
        &quot;version&quot;: &quot;3.0.0&quot;,
        &quot;data_source&quot;: os.getenv(&quot;DATA_SOURCE&quot;),
        &quot;dependencies&quot;: {
            &quot;tushare&quot;: check_tushare_connection(),
            &quot;database&quot;: check_database_connection(),
            &quot;redis&quot;: check_redis_connection()
        }
    }
</code></pre>
<h4 id="_21">基础监控脚本</h4>
<pre><code class="language-bash">#!/bin/bash
# health_monitor.sh

API_URL=&quot;http://localhost:8124&quot;
STREAMLIT_URL=&quot;http://localhost:8501&quot;

# 检查API服务
api_status=$(curl -s -o /dev/null -w &quot;%{http_code}&quot; $API_URL/health)
if [ $api_status -eq 200 ]; then
    echo &quot;✅ API service is healthy&quot;
else
    echo &quot;❌ API service is down (HTTP: $api_status)&quot;
fi

# 检查Streamlit服务
streamlit_status=$(curl -s -o /dev/null -w &quot;%{http_code}&quot; $STREAMLIT_URL)
if [ $streamlit_status -eq 200 ]; then
    echo &quot;✅ Streamlit service is healthy&quot;
else
    echo &quot;❌ Streamlit service is down (HTTP: $streamlit_status)&quot;
fi
</code></pre>
<h3 id="_22">日志管理</h3>
<h4 id="_23">日志配置</h4>
<pre><code class="language-python">import logging
import logging.handlers

# 配置结构化日志
def setup_logging():
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

    # 文件日志
    file_handler = logging.handlers.RotatingFileHandler(
        'logs/app.log',
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(formatter)

    # 控制台日志
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)

    # 根日志器
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(file_handler)
    root_logger.addHandler(console_handler)
</code></pre>
<h4 id="elk-stack">日志聚合(ELK Stack)</h4>
<pre><code class="language-yaml"># logstash.conf
input {
  file {
    path =&gt; &quot;/app/logs/*.log&quot;
    start_position =&gt; &quot;beginning&quot;
  }
}

filter {
  grok {
    match =&gt; {
      &quot;message&quot; =&gt; &quot;%{TIMESTAMP_ISO8601:timestamp} - %{DATA:logger} - %{LOGLEVEL:level} - %{GREEDYDATA:message}&quot;
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; [&quot;elasticsearch:9200&quot;]
    index =&gt; &quot;stock-valuation-%{+YYYY.MM.dd}&quot;
  }
}
</code></pre>
<h3 id="_24">性能监控</h3>
<h4 id="_25">关键指标</h4>
<pre><code class="language-python"># 使用Prometheus监控
from prometheus_client import Counter, Histogram, generate_latest

# 请求计数器
REQUEST_COUNT = Counter('api_requests_total', 'Total API requests', ['method', 'endpoint'])

# 响应时间直方图
REQUEST_LATENCY = Histogram('api_request_duration_seconds', 'API request latency')

# 业务指标
VALUATION_SUCCESS = Counter('valuations_successful_total', 'Successful valuations')
VALUATION_ERRORS = Counter('valuations_failed_total', 'Failed valuations', ['error_type'])

@app.middleware(&quot;http&quot;)
async def monitor_requests(request: Request, call_next):
    start_time = time.time()

    response = await call_next(request)

    # 记录指标
    REQUEST_COUNT.labels(
        method=request.method,
        endpoint=request.url.path
    ).inc()

    REQUEST_LATENCY.observe(time.time() - start_time)

    return response
</code></pre>
<h4 id="grafana">Grafana仪表板</h4>
<pre><code class="language-json">{
  &quot;dashboard&quot;: {
    &quot;title&quot;: &quot;Stock Valuation System&quot;,
    &quot;panels&quot;: [
      {
        &quot;title&quot;: &quot;API Request Rate&quot;,
        &quot;type&quot;: &quot;graph&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;rate(api_requests_total[5m])&quot;,
            &quot;legendFormat&quot;: &quot;{{method}} {{endpoint}}&quot;
          }
        ]
      },
      {
        &quot;title&quot;: &quot;Response Time&quot;,
        &quot;type&quot;: &quot;graph&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;histogram_quantile(0.95, api_request_duration_seconds_bucket)&quot;,
            &quot;legendFormat&quot;: &quot;95th percentile&quot;
          }
        ]
      },
      {
        &quot;title&quot;: &quot;Error Rate&quot;,
        &quot;type&quot;: &quot;singlestat&quot;,
        &quot;targets&quot;: [
          {
            &quot;expr&quot;: &quot;rate(valuations_failed_total[5m]) / rate(api_requests_total[5m])&quot;
          }
        ]
      }
    ]
  }
}
</code></pre>
<h2 id="_26">备份和恢复</h2>
<h3 id="_27">数据备份策略</h3>
<h4 id="_28">配置文件备份</h4>
<pre><code class="language-bash">#!/bin/bash
# backup_config.sh

BACKUP_DIR=&quot;/backup/config&quot;
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR/$DATE

# 备份环境配置
cp .env* $BACKUP_DIR/$DATE/
cp -r config/ $BACKUP_DIR/$DATE/
cp docker-compose.yml $BACKUP_DIR/$DATE/

# 压缩备份
tar -czf $BACKUP_DIR/config_backup_$DATE.tar.gz -C $BACKUP_DIR $DATE

# 清理旧备份(保留30天)
find $BACKUP_DIR -name &quot;config_backup_*.tar.gz&quot; -mtime +30 -delete
</code></pre>
<h4 id="_29">数据库备份</h4>
<pre><code class="language-bash">#!/bin/bash
# backup_database.sh

DB_HOST=&quot;localhost&quot;
DB_NAME=&quot;stock_valuation&quot;
DB_USER=&quot;admin&quot;
BACKUP_DIR=&quot;/backup/database&quot;
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME \
  | gzip &gt; $BACKUP_DIR/db_backup_$DATE.sql.gz

# 上传到云存储(可选)
aws s3 cp $BACKUP_DIR/db_backup_$DATE.sql.gz \
  s3://your-backup-bucket/database/
</code></pre>
<h3 id="_30">恢复流程</h3>
<h4 id="_31">配置恢复</h4>
<pre><code class="language-bash"># 恢复配置文件
tar -xzf config_backup_20251222_140000.tar.gz
cp 20251222_140000/.env* ./
cp -r 20251222_140000/config/ ./
</code></pre>
<h4 id="_32">数据库恢复</h4>
<pre><code class="language-bash"># 恢复数据库
gunzip -c db_backup_20251222_140000.sql.gz | \
  psql -h localhost -U admin -d stock_valuation
</code></pre>
<h4 id="_33">服务恢复</h4>
<pre><code class="language-bash"># 重启服务
docker-compose down
docker-compose up -d

# 验证恢复
./scripts/health_check.sh
</code></pre>
<h2 id="_34">安全配置</h2>
<h3 id="ssltls">SSL/TLS配置</h3>
<h4 id="nginx-ssl">Nginx SSL配置</h4>
<pre><code class="language-nginx">server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    location /api/ {
        proxy_pass http://api:8124/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://streamlit:8501/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &quot;upgrade&quot;;
    }
}
</code></pre>
<h3 id="_35">访问控制</h3>
<h4 id="api_1">API密钥认证</h4>
<pre><code class="language-python">from fastapi import HTTPException, Depends
from fastapi.security import HTTPBearer

security = HTTPBearer()

async def verify_api_key(token: str = Depends(security)):
    if token.credentials != os.getenv(&quot;API_SECRET_KEY&quot;):
        raise HTTPException(
            status_code=401,
            detail=&quot;Invalid API key&quot;
        )
    return token
</code></pre>
<h4 id="ip">IP白名单</h4>
<pre><code class="language-python">from fastapi import Request, HTTPException

ALLOWED_IPS = [&quot;127.0.0.1&quot;, &quot;10.0.0.0/8&quot;, &quot;192.168.0.0/16&quot;]

async def ip_whitelist(request: Request):
    client_ip = request.client.host
    if not any(ipaddress.ip_address(client_ip) in ipaddress.ip_network(allowed)
              for allowed in ALLOWED_IPS):
        raise HTTPException(status_code=403, detail=&quot;IP not allowed&quot;)
</code></pre>
<h2 id="_36">故障排查</h2>
<h3 id="_37">常见问题</h3>
<h4 id="1-api">1. API服务无法启动</h4>
<pre><code class="language-bash"># 检查端口占用
lsof -i :8124

# 检查日志
tail -f logs/app.log

# 检查配置
python scripts/validate_config.py

# 重启服务
systemctl restart stock-valuation-api
</code></pre>
<h4 id="2">2. 数据源连接失败</h4>
<pre><code class="language-bash"># 检查TuShare连接
python -c &quot;
import tushare as ts
ts.set_token('$TUSHARE_TOKEN')
pro = ts.pro_api()
print(pro.stock_basic().head())
&quot;

# 检查数据库连接
pg_isready -h $DB_HOST -p $DB_PORT

# 检查网络连接
ping api.tushare.pro
</code></pre>
<h4 id="3">3. 内存使用过高</h4>
<pre><code class="language-bash"># 检查进程内存使用
ps aux | grep python | grep valuation

# 检查系统内存
free -h

# 重启服务释放内存
docker-compose restart api
</code></pre>
<h4 id="4_1">4. 估值计算错误</h4>
<pre><code class="language-bash"># 运行诊断脚本
python scripts/diagnose_valuation.py --ts_code 600519.SH

# 检查输入数据质量
python scripts/data_quality_check.py

# 对比数据源结果
python scripts/e2e_compare_sources.py --ts 600519.SH
</code></pre>
<h3 id="_38">日志分析</h3>
<h4 id="_39">错误模式识别</h4>
<pre><code class="language-bash"># 查找API错误
grep &quot;ERROR&quot; logs/app.log | tail -20

# 查找数据获取失败
grep &quot;Failed to fetch&quot; logs/app.log

# 查找计算异常
grep &quot;Calculation error&quot; logs/app.log

# 统计错误类型
grep &quot;ERROR&quot; logs/app.log | awk '{print $5}' | sort | uniq -c
</code></pre>
<h2 id="_40">扩展和优化</h2>
<h3 id="_41">水平扩展</h3>
<h4 id="_42">负载均衡配置</h4>
<pre><code class="language-nginx">upstream api_backend {
    server api1:8124;
    server api2:8124;
    server api3:8124;
}

server {
    location /api/ {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
</code></pre>
<h4 id="kubernetes">自动扩展(Kubernetes)</h4>
<pre><code class="language-yaml">apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-hpa
  namespace: stock-valuation
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-deployment
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
</code></pre>
<h3 id="_43">性能优化</h3>
<h4 id="_44">缓存策略</h4>
<pre><code class="language-python">import redis
from functools import wraps

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cache_result(expiration=3600):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 生成缓存键
            cache_key = f&quot;{func.__name__}:{hash(str(args) + str(kwargs))}&quot;

            # 尝试从缓存获取
            cached_result = redis_client.get(cache_key)
            if cached_result:
                return json.loads(cached_result)

            # 执行函数并缓存结果
            result = await func(*args, **kwargs)
            redis_client.setex(
                cache_key,
                expiration,
                json.dumps(result, default=str)
            )

            return result
        return wrapper
    return decorator
</code></pre>
<h4 id="_45">数据库优化</h4>
<pre><code class="language-sql">-- 添加索引优化查询
CREATE INDEX idx_stock_basic_ts_code ON stock_basic(ts_code);
CREATE INDEX idx_income_end_date ON income_statement(end_date);
CREATE INDEX idx_balance_end_date ON balance_sheet(end_date);

-- 分区表优化大数据量
CREATE TABLE income_statement_2024 PARTITION OF income_statement
FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
</code></pre>
<h2 id="_46">维护计划</h2>
<h3 id="_47">日常维护</h3>
<h4 id="_48">每日任务</h4>
<ul>
<li>检查服务健康状态</li>
<li>监控API响应时间和错误率</li>
<li>检查磁盘空间使用情况</li>
<li>备份重要配置文件</li>
</ul>
<h4 id="_49">每周任务</h4>
<ul>
<li>清理过期日志文件</li>
<li>更新系统补丁</li>
<li>检查数据质量</li>
<li>性能报告生成</li>
</ul>
<h4 id="_50">每月任务</h4>
<ul>
<li>完整备份验证</li>
<li>安全审计</li>
<li>依赖包更新</li>
<li>容量规划评估</li>
</ul>
<h3 id="_51">更新流程</h3>
<h4 id="_52">滚动更新</h4>
<pre><code class="language-bash"># 1. 构建新版本镜像
docker build -t stock-valuation:v3.1.0 .

# 2. 更新docker-compose.yml
sed -i 's/stock-valuation:latest/stock-valuation:v3.1.0/g' docker-compose.yml

# 3. 滚动更新服务
docker-compose up -d --no-deps api

# 4. 验证更新
./scripts/health_check.sh

# 5. 更新其他服务
docker-compose up -d
</code></pre>
<h4 id="_53">回滚计划</h4>
<pre><code class="language-bash"># 如果更新失败，快速回滚
docker-compose down
git checkout previous-stable-tag
docker-compose up -d

# 恢复数据(如需要)
./scripts/restore_backup.sh
</code></pre>
<hr />
<p><em>本部署运维指南提供了完整的生产级部署方案，建议根据实际环境调整具体配置。</em></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
