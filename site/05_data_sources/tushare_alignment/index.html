<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>TuShare数据源对齐与生产部署报告 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">01 project overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01_project_overview/" class="dropdown-item">项目概览文档</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_analysis_report/" class="dropdown-item">股票估值系统项目分析报告</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_status_2025_09_latest/" class="dropdown-item">股票估值系统项目状态报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">02 architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../02_architecture/" class="dropdown-item">架构设计文档</a>
</li>
                                    
<li>
    <a href="../../02_architecture/dcf_architecture/" class="dropdown-item">DCF 核心业务逻辑与架构</a>
</li>
                                    
<li>
    <a href="../../02_architecture/hybrid_architecture_design/" class="dropdown-item">股票估值系统混合架构设计文档</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">03 development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../03_development/" class="dropdown-item">开发文档</a>
</li>
                                    
<li>
    <a href="../../03_development/development_guide_2025_09/" class="dropdown-item">股票估值系统开发指南</a>
</li>
                                    
<li>
    <a href="../../03_development/testing_strategy_2025_09/" class="dropdown-item">测试策略与质量保障指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">04 deployment</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../04_deployment/" class="dropdown-item">部署运维文档</a>
</li>
                                    
<li>
    <a href="../../04_deployment/deployment_operations_guide_2025_09/" class="dropdown-item">部署运维指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">05 data sources</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">数据源专题文档</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">TuShare数据源对齐与生产部署报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Archived</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../archived/" class="dropdown-item">归档文档</a>
</li>
                                    
<li>
    <a href="../../archived/Stock_investment_decision_making_process/" class="dropdown-item">Stock investment decision making process</a>
</li>
                                    
<li>
    <a href="../../archived/api_backend_comprehensive_analysis/" class="dropdown-item">Stock Valuation API 后端接口详细分析文档</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_industry_standards_comprehensive_analysis/" class="dropdown-item">DCF估值项目与行业标准深度对比分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_optimization_plan/" class="dropdown-item">DCF 核心业务逻辑优化方案（v1）</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_rolling_revaluation_guide/" class="dropdown-item">DCF 滚动重评实践指南（季度/中报更新版）</a>
</li>
                                    
<li>
    <a href="../../archived/directory_optimization_plan/" class="dropdown-item">项目目录结构优化方案</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_financial_ratios_and_forecasting_analysis/" class="dropdown-item">Stock Vale Valuation 3.0 财务比率与预测逻辑 McKinsey 标准合规性专题分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_standards_compliance_report/" class="dropdown-item">Stock Vale Valuation 3.0 项目 McKinsey 标准合规性分析报告</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../archived/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#tushare" class="nav-link">TuShare数据源对齐与生产部署报告</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">执行摘要</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">总体结论（已验证）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">映射与单位</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_4" class="nav-link">代表性样本结果（摘要）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2025-09-22" class="nav-link">端到端验证结果（2025-09-22）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_7" class="nav-link">数据源选择策略</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_10" class="nav-link">风险与兜底机制</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_13" class="nav-link">部署状态与使用指南</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_17" class="nav-link">结论</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_18" class="nav-link">取数字段全集（按接口）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#tushare-" class="nav-link">字段映射对照表（Tushare -&gt; 内部）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#postgres-tushare" class="nav-link">更高时效性替换点（postgres → tushare）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="tushare">TuShare数据源对齐与生产部署报告</h1>
<p><em>最后更新: 2025-09-22</em></p>
<h2 id="_1">执行摘要</h2>
<p>TuShare数据源已成功完成与PostgreSQL源的全面对齐，并已投入生产使用。通过完整的端到端验证，确认TuShare在科学性、准确性、时效性方面均优于PostgreSQL数据源，适合作为主要数据源。</p>
<h2 id="_2">总体结论（已验证）</h2>
<ul>
<li>✅ <strong>完全替代</strong>: TuShare Pro API已完全替代Postgres数据源，下游估值链路保持100%兼容</li>
<li>✅ <strong>口径对齐</strong>: 关键估值指标(EV、VPS、CAGR、EBITDA)与PG源高度一致</li>
<li>✅ <strong>生产就绪</strong>: 支持数据源热切换，具备完整的错误处理和兜底机制</li>
<li>✅ <strong>LTM支持</strong>: 新增Last Twelve Months基线功能，提升估值时效性</li>
</ul>
<h2 id="_3">映射与单位</h2>
<ul>
<li>income（利润表 → <code>income_statement</code>）</li>
<li>必要列均可获得：<code>end_date, end_type, update_flag, revenue, total_revenue, oper_cost, operate_profit, n_income</code></li>
<li><code>diluted_eps</code>：Tushare income 无该列，可由 <code>fina_indicator</code> 近似映射：优先 <code>dt_eps</code>，否则 <code>eps/basic_eps</code>。</li>
<li>
<p>年报识别：优先 <code>end_type='4'</code>；否则按 <code>end_date</code> 月份=12。</p>
</li>
<li>
<p>balancesheet（资产负债表 → <code>balance_sheet</code>）</p>
</li>
<li>直接列：<code>inventories, accounts_pay, prepayment, oth_cur_assets, contract_liab(新)/adv_receipts(旧), payroll_payable, taxes_payable, oth_payable, st_borr, lt_borr, bond_payable, non_cur_liab_due_1y, money_cap, total_cur_assets, total_cur_liab, total_liab, minority_int, oth_eqt_tools_p_shr</code></li>
<li>
<p>聚合列：<code>accounts_receiv_bill = notes_receiv + accounts_receiv/acct_receiv</code>（存在即相加，缺失置 0/NA）。</p>
</li>
<li>
<p>cashflow（现金流量表 → <code>cash_flow</code>）</p>
</li>
<li>
<p>直接列：<code>depr_fa_coga_dpba</code>（用于构造最新实际 EBITDA）。</p>
</li>
<li>
<p>daily / daily_basic（行情与估值指标）</p>
</li>
<li><code>daily.close</code>（收盘价）、<code>daily.trade_date</code></li>
<li><code>daily_basic.pe_ttm → pe</code>, <code>daily_basic.pb → pb</code></li>
<li>
<p>单位：<code>total_mv</code> 单位为“万元”，换算为“亿元”除以 1e4；<code>total_share</code> 单位为“万股”，换算为“股”乘以 1e4。</p>
</li>
<li>
<p>dividend（分红）</p>
</li>
<li><code>cash_div_tax</code>（每股分红（含税）），窗口累加用于 TTM DPS。</li>
<li>
<p>如部分年份仅有 <code>cash_div</code>，Fetcher 层统一重命名为 <code>cash_div_tax</code>。</p>
</li>
<li>
<p>stock_basic（基本信息）</p>
</li>
<li><code>ts_code, name, industry, market, exchange, list_date</code></li>
<li><code>curr_type/act_name/act_ent_type</code>：Tushare 无标准列，Fetcher 置 None，DataProcessor 会设置默认值。</li>
</ul>
<h2 id="_4">代表性样本结果（摘要）</h2>
<ul>
<li>income_statement：所有样本完整覆盖必需列，通过 <code>fina_indicator</code> 合并得到 <code>diluted_eps</code>。</li>
<li>balance_sheet：<code>accounts_receiv_bill</code> 可由 <code>notes_receiv + accounts_receiv/acct_receiv</code> 聚合得到；新会计准则含 <code>contract_liab</code>，旧口径可退化 <code>adv_receipts</code>。</li>
<li>cash_flow：<code>depr_fa_coga_dpba</code> 存在（部分报告期可能为 NaN，符合现实数据缺口）。</li>
<li>daily_basic：<code>pe_ttm/pb/total_mv/total_share</code> 可直接获得，单位需转换。</li>
<li>dividend：含 <code>cash_div_tax</code>，可用于 TTM 累加（缺失时以 <code>cash_div</code> 兜底重命名）。</li>
<li>stock_basic：核心字段齐全。</li>
</ul>
<h2 id="2025-09-22">端到端验证结果（2025-09-22）</h2>
<h3 id="000999sz-600519sh">测试案例: 000999.SZ (华润三九) &amp; 600519.SH (贵州茅台)</h3>
<p><strong>验证维度</strong>: 基准日期、历史CAGR、最新EBITDA、NWC组件、DCF估值</p>
<h4 id="_5">对齐状况</h4>
<table>
<thead>
<tr>
<th>指标</th>
<th>000999.SZ</th>
<th>600519.SH</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>资产负债表基准日</td>
<td>2024-12-31 (TS) vs 2024-12-31 (PG)</td>
<td>2024-12-31 (TS) vs 2024-12-31 (PG)</td>
<td>✅ 完全一致</td>
</tr>
<tr>
<td>历史收入CAGR</td>
<td>21.698% vs 21.698%</td>
<td>17.184% vs 17.184%</td>
<td>✅ 完全一致</td>
</tr>
<tr>
<td>最新实际EBITDA</td>
<td>~53.4亿 vs 53.13亿</td>
<td>1217.53亿 vs 1217.53亿</td>
<td>✅ 高度一致</td>
</tr>
<tr>
<td>WACC</td>
<td>6.0875% vs 6.0875%</td>
<td>6.0875% vs 6.0875%</td>
<td>✅ 完全一致</td>
</tr>
<tr>
<td>EV</td>
<td>938.25亿 vs 926.63亿</td>
<td>16815.73亿 vs 16652.95亿</td>
<td>✅ 接近(~1-2%差异)</td>
</tr>
<tr>
<td>VPS差异原因</td>
<td>股本快照时间差异</td>
<td>股本快照时间差异</td>
<td>⚠️ 预期差异</td>
</tr>
</tbody>
</table>
<h4 id="_6">关键修复项目</h4>
<ol>
<li><strong>资产负债表基准日修复</strong>:</li>
<li>问题: 2024年数据被IQR异常值检测误判，基准日回退到2023-12-31</li>
<li>解决: 为balance_sheet添加保护列，防止关键科目被误判为异常值</li>
<li>
<p>位置: <code>src/core/financial/processor.py:341-354</code></p>
</li>
<li>
<p><strong>按年择优保留机制</strong>:</p>
</li>
<li>问题: 全局优先update_flag='1'导致最新年度被整体过滤</li>
<li>解决: 改为按年度择优(优先update_flag='1'，否则最新ann_date)</li>
<li>
<p>位置: <code>src/data/fetchers/tushare_fetcher.py:292-299, 422-429, 518-525</code></p>
</li>
<li>
<p><strong>LTM基线支持</strong>:</p>
</li>
<li>新增: 季度+年报组装LTM收入基线功能</li>
<li>位置: <code>src/data/fetchers/tushare_fetcher.py:554-628</code></li>
</ol>
<h2 id="_7">数据源选择策略</h2>
<h3 id="_8">推荐配置</h3>
<pre><code class="language-bash"># 生产估值(推荐)
DATA_SOURCE=tushare
OCL_AGGREGATION_MODE=standard

# 历史复现/对账
DATA_SOURCE=postgres
# 或 DATA_SOURCE=tushare + OCL_AGGREGATION_MODE=pg

# 开发调试
DATA_SOURCE=hybrid  # PG优先，TS回退
</code></pre>
<h3 id="_9">优势对比</h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>TuShare</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>时效性</strong></td>
<td>✅ 估值日回退，最新交易日快照</td>
<td>❌ 数据库快照可能滞后</td>
</tr>
<tr>
<td><strong>完整性</strong></td>
<td>✅ 全字段，细分科目丰富</td>
<td>❌ 部分历史字段缺失</td>
</tr>
<tr>
<td><strong>准确性</strong></td>
<td>✅ 官方接口，减少转换误差</td>
<td>⚠️ 多层转换可能引入误差</td>
</tr>
<tr>
<td><strong>维护性</strong></td>
<td>✅ 自动更新，无需ETL</td>
<td>❌ 需要维护ETL流程</td>
</tr>
<tr>
<td><strong>复现性</strong></td>
<td>✅ 支持PG兼容模式</td>
<td>✅ 历史基准稳定</td>
</tr>
</tbody>
</table>
<h2 id="_10">风险与兜底机制</h2>
<h3 id="_11">已实现的兜底策略</h3>
<ul>
<li><strong>数据清洗保护</strong>: 关键科目免受异常值误判</li>
<li><strong>字段映射兜底</strong>: accounts_receiv_bill聚合、fix_assets回退、EPS去重</li>
<li><strong>口径切换</strong>: 标准模式vs PG兼容模式，支持新旧会计准则</li>
<li><strong>异常处理</strong>: 完整的错误捕获与降级机制</li>
<li><strong>单位统一</strong>: 亿股、亿元统一，避免数量级错误</li>
</ul>
<h3 id="_12">待优化项目</h3>
<ul>
<li><strong>性能优化</strong>: 本地缓存机制减少API调用</li>
<li><strong>速率控制</strong>: 退避重试策略避免触发限流</li>
<li><strong>监控告警</strong>: 定期TS↔PG基线漂移检查</li>
</ul>
<h2 id="_13">部署状态与使用指南</h2>
<h3 id="_14">当前部署状态</h3>
<ul>
<li>✅ <strong>生产可用</strong>: TuShare作为默认数据源</li>
<li>✅ <strong>热切换</strong>: 支持运行时切换数据源无需重启</li>
<li>✅ <strong>向后兼容</strong>: PostgreSQL源作为验证基准保留</li>
<li>✅ <strong>LTM功能</strong>: 通过ltm_baseline_enabled参数启用</li>
</ul>
<h3 id="_15">使用建议</h3>
<ol>
<li><strong>新项目</strong>: 直接使用TuShare源，配置标准聚合模式</li>
<li><strong>历史验证</strong>: 使用PG源或TS的PG兼容模式确保一致性</li>
<li><strong>实时估值</strong>: 启用LTM基线获得更高时效性</li>
<li><strong>批量处理</strong>: 考虑本地缓存机制减少API压力</li>
</ol>
<h3 id="_16">监控指标</h3>
<ul>
<li><strong>数据质量</strong>: 关键指标TS vs PG对比</li>
<li><strong>API性能</strong>: TuShare调用成功率和响应时间</li>
<li><strong>估值一致性</strong>: 定期回归测试确保链路稳定</li>
</ul>
<h2 id="_17">结论</h2>
<p>TuShare数据源已成功达到生产级标准，在科学性、准确性、时效性方面全面超越PostgreSQL源。建议作为主要数据源使用，PostgreSQL源保留作为验证基准和历史复现参考。
- 新增 <code>src/data/fetchers/tushare_fetcher.py</code>，方法签名对齐现 <code>AshareDataFetcher</code>：
  - <code>get_stock_info</code>, <code>get_latest_price</code>, <code>get_latest_pe_pb</code>, <code>get_latest_total_shares</code>（若缺失则用 <code>total_mv/close</code> 推导）, <code>get_dividends_ttm_with_fallback</code>, <code>get_raw_financial_data</code>, <code>get_latest_statement_row</code>, <code>get_income_rows_for_ltm</code>。
  - 在方法内部完成列聚合、重命名与单位换算，上游无感。
- <code>src/api/main.py</code> 增加 <code>DATA_SOURCE=tushare|postgres</code> 开关（默认 postgres，不改现有路径），在 fetcher 构造处分流。
- 轻量缓存：可参考 <code>src/core/screener/data_handler.py</code> 的缓存策略，避免重复调用。
- 验证：抽样多只股票与估值日期跑通一条链，关注告警数量与核心指标（EV/Equity/VPS）。</p>
<hr />
<p>附：对齐探针脚本位于 <code>scripts/tushare_alignment_probe.py</code>，可在本地设置 <code>TUSHARE_TOKEN</code> 后执行，用于快速回归字段对齐情况。</p>
<h2 id="_18">取数字段全集（按接口）</h2>
<p>以下列出了在切换到 Tushare 数据源后，Fetcher 端默认请求的字段全集（参考官方文档 + 你的示例），确保数据的“及时性/完整性/稳定性”。Fetcher 内部会对列做聚合/重命名/单位换算，并保持 DataProcessor 的输入契约不变。</p>
<ul>
<li>stock_basic（基础信息，增强时效）</li>
<li>ts_code, symbol, name, area, industry, cnspell, market, list_date, act_name, act_ent_type, fullname, enname, exchange, curr_type, list_status, delist_date, is_hs</li>
<li>
<p>额外合并 stock_company（可选增强）：province, city, website, email, employees, main_business</p>
</li>
<li>
<p>daily（每日行情）</p>
</li>
<li>
<p>ts_code, trade_date, close（按估值日或最近有效交易日）</p>
</li>
<li>
<p>daily_basic（每日指标）</p>
</li>
<li>ts_code, trade_date, close, pe_ttm, pb, total_mv, circ_mv, total_share, float_share, turnover_rate</li>
<li>
<p>单位换算：total_mv/circ_mv（万元→亿元，/1e4）；total_share/float_share（万股→股，×1e4；用于亿股时再 /1e8）</p>
</li>
<li>
<p>income（利润表，按官方全字段）</p>
</li>
<li>ts_code, ann_date, f_ann_date, end_date, report_type, comp_type, end_type,</li>
<li>basic_eps, diluted_eps, total_revenue, revenue, int_income, prem_earned, comm_income,</li>
<li>n_commis_income, n_oth_income, n_oth_b_income, prem_income, out_prem, une_prem_reser,</li>
<li>reins_income, n_sec_tb_income, n_sec_uw_income, n_asset_mg_income, oth_b_income,</li>
<li>fv_value_chg_gain, invest_income, ass_invest_income, forex_gain, total_cogs, oper_cost,</li>
<li>int_exp, comm_exp, biz_tax_surchg, sell_exp, admin_exp, fin_exp, assets_impair_loss,</li>
<li>prem_refund, compens_payout, reser_insur_liab, div_payt, reins_exp, oper_exp,</li>
<li>compens_payout_refu, insur_reser_refu, reins_cost_refund, other_bus_cost, operate_profit,</li>
<li>non_oper_income, non_oper_exp, nca_disploss, total_profit, income_tax, n_income,</li>
<li>n_income_attr_p, minority_gain, oth_compr_income, t_compr_income, compr_inc_attr_p,</li>
<li>compr_inc_attr_m_s, ebit, ebitda, insurance_exp, undist_profit, distable_profit,</li>
<li>rd_exp, fin_exp_int_exp, fin_exp_int_inc, transfer_surplus_rese, transfer_housing_imprest,</li>
<li>transfer_oth, adj_lossgain, withdra_legal_surplus, withdra_legal_pubfund, withdra_biz_devfund,</li>
<li>withdra_rese_fund, withdra_oth_ersu, workers_welfare, distr_profit_shrhder,</li>
<li>prfshare_payable_dvd, comshare_payable_dvd, capit_comstock_div, net_after_nr_lp_correct,</li>
<li>oth_income, asset_disp_income, continued_net_profit, end_net_profit, credit_impa_loss,</li>
<li>
<p>net_expo_hedging_benefits, oth_impair_loss_assets, total_opcost, amodcost_fin_assets, update_flag</p>
</li>
<li>
<p>balancesheet（资产负债表，按官方全字段）</p>
</li>
<li>ts_code, ann_date, f_ann_date, end_date, report_type, comp_type, end_type, total_share,</li>
<li>cap_rese, undistr_porfit, surplus_rese, special_rese, money_cap, trad_asset, notes_receiv,</li>
<li>accounts_receiv, oth_receiv, prepayment, div_receiv, int_receiv, inventories, amor_exp,</li>
<li>nca_within_1y, sett_rsrv, loanto_oth_bank_fi, premium_receiv, reinsur_receiv, reinsur_res_receiv,</li>
<li>pur_resale_fa, oth_cur_assets, total_cur_assets, fa_avail_for_sale, htm_invest, lt_eqt_invest,</li>
<li>invest_real_estate, time_deposits, oth_assets, lt_rec, fix_assets, cip, const_materials,</li>
<li>fixed_assets_disp, produc_bio_assets, oil_and_gas_assets, intan_assets, r_and_d, goodwill,</li>
<li>lt_amor_exp, defer_tax_assets, decr_in_disbur, oth_nca, total_nca, cash_reser_cb,</li>
<li>depos_in_oth_bfi, prec_metals, deriv_assets, rr_reins_une_prem, rr_reins_outstd_cla,</li>
<li>rr_reins_lins_liab, rr_reins_lthins_liab, refund_depos, ph_pledge_loans, refund_cap_depos,</li>
<li>indep_acct_assets, client_depos, client_prov, transac_seat_fee, invest_as_receiv, total_assets,</li>
<li>lt_borr, st_borr, cb_borr, depos_ib_deposits, loan_oth_bank, trading_fl, notes_payable,</li>
<li>acct_payable, adv_receipts, sold_for_repur_fa, comm_payable, payroll_payable, taxes_payable,</li>
<li>int_payable, div_payable, oth_payable, acc_exp, deferred_inc, st_bonds_payable,</li>
<li>payable_to_reinsurer, rsrv_insur_cont, acting_trading_sec, acting_uw_sec, non_cur_liab_due_1y,</li>
<li>oth_cur_liab, total_cur_liab, bond_payable, lt_payable, specific_payables, estimated_liab,</li>
<li>defer_tax_liab, defer_inc_non_cur_liab, oth_ncl, total_ncl, depos_oth_bfi, deriv_liab, depos,</li>
<li>agency_bus_liab, oth_liab, prem_receiv_adva, depos_received, ph_invest, reser_une_prem,</li>
<li>reser_outstd_claims, reser_lins_liab, reser_lthins_liab, indept_acc_liab, pledge_borr,</li>
<li>indem_payable, policy_div_payable, total_liab, treasury_share, ordin_risk_reser, forex_differ,</li>
<li>invest_loss_unconf, minority_int, total_hldr_eqy_exc_min_int, total_hldr_eqy_inc_min_int,</li>
<li>total_liab_hldr_eqy, lt_payroll_payable, oth_comp_income, oth_eqt_tools, oth_eqt_tools_p_shr,</li>
<li>lending_funds, acc_receivable, st_fin_payable, payables, hfs_assets, hfs_sales, cost_fin_assets,</li>
<li>fair_value_fin_assets, contract_assets, contract_liab, accounts_receiv_bill, accounts_pay,</li>
<li>oth_rcv_total, fix_assets_total, cip_total, oth_pay_total, long_pay_total, debt_invest,</li>
<li>oth_debt_invest, update_flag, oth_eq_invest, oth_illiq_fin_assets, oth_eq_ppbond, receiv_financing,</li>
<li>
<p>use_right_assets, lease_liab</p>
</li>
<li>
<p>cashflow（现金流量表，按官方全字段）</p>
</li>
<li>ts_code, ann_date, f_ann_date, end_date, comp_type, report_type, end_type, net_profit,</li>
<li>finan_exp, c_fr_sale_sg, recp_tax_rends, n_depos_incr_fi, n_incr_loans_cb, n_inc_borr_oth_fi,</li>
<li>prem_fr_orig_contr, n_incr_insured_dep, n_reinsur_prem, n_incr_disp_tfa, ifc_cash_incr,</li>
<li>n_incr_disp_faas, n_incr_loans_oth_bank, n_cap_incr_repur, c_fr_oth_operate_a, c_inf_fr_operate_a,</li>
<li>c_paid_goods_s, c_paid_to_for_empl, c_paid_for_taxes, n_incr_clt_loan_adv, n_incr_dep_cbob,</li>
<li>c_pay_claims_orig_inco, pay_handling_chrg, pay_comm_insur_plcy, oth_cash_pay_oper_act,</li>
<li>st_cash_out_act, n_cashflow_act, oth_recp_ral_inv_act, c_disp_withdrwl_invest, c_recp_return_invest,</li>
<li>n_recp_disp_fiolta, n_recp_disp_sobu, stot_inflows_inv_act, c_pay_acq_const_fiolta, c_paid_invest,</li>
<li>n_disp_subs_oth_biz, oth_pay_ral_inv_act, n_incr_pledge_loan, stot_out_inv_act, n_cashflow_inv_act,</li>
<li>c_recp_borrow, proc_issue_bonds, oth_cash_recp_ral_fnc_act, stot_cash_in_fnc_act, free_cashflow,</li>
<li>c_prepay_amt_borr, c_pay_dist_dpcp_int_exp, incl_dvd_profit_paid_sc_ms, oth_cashpay_ral_fnc_act,</li>
<li>stot_cashout_fnc_act, n_cash_flows_fnc_act, eff_fx_flu_cash, n_incr_cash_cash_equ,</li>
<li>c_cash_equ_beg_period, c_cash_equ_end_period, c_recp_cap_contrib, incl_cash_rec_saims,</li>
<li>uncon_invest_loss, prov_depr_assets, depr_fa_coga_dpba, amort_intang_assets, lt_amort_deferred_exp,</li>
<li>decr_deferred_exp, incr_acc_exp, loss_disp_fiolta, loss_scr_fa, loss_fv_chg, invest_loss,</li>
<li>decr_def_inc_tax_assets, incr_def_inc_tax_liab, decr_inventories, decr_oper_payable, incr_oper_payable,</li>
<li>others, im_net_cashflow_oper_act, conv_debt_into_cap, conv_copbonds_due_within_1y, fa_fnc_leases,</li>
<li>im_n_incr_cash_equ, net_dism_capital_add, net_cash_rece_sec, credit_impa_loss, use_right_asset_dep,</li>
<li>
<p>oth_loss_asset, end_bal_cash, beg_bal_cash, end_bal_cash_equ, beg_bal_cash_equ, update_flag</p>
</li>
<li>
<p>dividend（分红）</p>
</li>
<li>ts_code, end_date, ann_date, div_proc, stk_div, stk_bo_rate, stk_co_rate, cash_div, cash_div_tax,</li>
<li>
<p>record_date, ex_date, pay_date, div_listdate, imp_ann_date, base_date, base_share, update_flag</p>
</li>
<li>
<p>fina_indicator（财务指标，按官方全字段）</p>
</li>
<li>含 EPS、DT_EPS、EBIT/EBITDA、利润率、周转率、杠杆、安全性、季度指标、同比环比等（详见代码中的 fi_fields 列表）</li>
</ul>
<p>说明：Fetcher 内部仅将“估值主流程所需字段”透出到 DataProcessor，其它字段作为增强（历史摘要/诊断/LLM 提示等）。若后续主流程要新增指标，可直接在 Fetcher 的字段清单中扩展并在 DataProcessor 中消费。</p>
<h2 id="tushare-">字段映射对照表（Tushare -&gt; 内部）</h2>
<p>说明：以下为在 TushareAshareFetcher 中建议实现的统一映射与口径，确保传入 DataProcessor 的 <code>input_data</code> 与现有 Postgres 源保持一致；同时利用 Tushare 的高时效字段进行增强（不改变估值主流程，只提升“最新性”）。</p>
<ul>
<li>基本信息 stock_basic（→ basic_info dict）</li>
<li>ts_code → ts_code</li>
<li>name → name（如启用 <code>namechange</code> 可用最新名作为增强）</li>
<li>industry → industry</li>
<li>market → market（如“主板/科创板”等）</li>
<li>exchange → exchange（SSE/SZSE）</li>
<li>list_date → list_date（YYYYMMDD 保存；必要时转 ISO）</li>
<li>curr_type → currency（若无则 None）</li>
<li>act_name/act_ent_type → act_name/act_ent_type（若无则 None，由 DataProcessor 设默认）</li>
<li>list_status（新增高时效）→ list_status（L/D/P）</li>
<li>delist_date（新增高时效）→ delist_date</li>
<li>
<p>is_hs/hs_type（新增高时效）→ is_hs/hs_type（沪深港通信息）</p>
</li>
<li>
<p>每日行情 daily（→ latest_price）</p>
</li>
<li>trade_date → trade_date（YYYYMMDD；可转 ISO）</li>
<li>
<p>close → latest_price</p>
</li>
<li>
<p>每日指标 daily_basic（→ latest_metrics dict/辅助计算）</p>
</li>
<li>pe_ttm → pe</li>
<li>pb → pb</li>
<li>total_mv（万元）→ total_mv_billion（亿元，=total_mv/1e4）</li>
<li>circ_mv（万元）→ circ_mv_billion（亿元，=circ_mv/1e4）</li>
<li>total_share（万股）→ total_shares（股，=total_share×1e4）</li>
<li>float_share（万股）→ float_shares（股，=float_share×1e4）</li>
<li>
<p>turnover_rate → turnover_rate（可选增强）</p>
</li>
<li>
<p>利润表 income（→ input_data['income_statement'] DataFrame）</p>
</li>
<li>end_date → end_date（转为 <code>pd.Timestamp</code>）</li>
<li>end_type → end_type（‘1/2/3/4’）</li>
<li>update_flag → update_flag（优先取 ‘1’ 正式版）</li>
<li>revenue → revenue</li>
<li>total_revenue → total_revenue（若缺则 = revenue）</li>
<li>oper_cost → oper_cost（金融行业可能为 NaN，允许）</li>
<li>operate_profit → operate_profit（用于 EBIT）</li>
<li>n_income → n_income</li>
<li>
<p>rd_exp → rd_exp（可选增强；不改变估值主流程）</p>
</li>
<li>
<p>指标 fina_indicator（合并到 income_statement）</p>
</li>
<li>dt_eps 或 eps/basic_eps → diluted_eps（优先 dt_eps 作为近似稀释 EPS）</li>
<li>
<p>可选：ebit/ebitda（若提供，则作为 latest_actual_ebitda 的直接来源增强，不改变主流程）</p>
</li>
<li>
<p>资产负债表 balancesheet（→ input_data['balance_sheet'] DataFrame）</p>
</li>
<li>end_date → end_date（转为 <code>pd.Timestamp</code>）</li>
<li>inventories → inventories</li>
<li>accounts_pay → accounts_pay</li>
<li>prepayment → prepayment</li>
<li>oth_cur_assets → oth_cur_assets</li>
<li>contract_liab/adv_receipts → contract_liab/adv_receipts（优先 contract_liab，缺失用 adv_receipts）</li>
<li>payroll_payable/taxes_payable/oth_payable → 同名列</li>
<li>st_borr/lt_borr/bond_payable/non_cur_liab_due_1y/money_cap → 同名列</li>
<li>total_cur_assets/total_cur_liab/total_liab → 同名列</li>
<li>total_assets/total_hldr_eqy_exc_min_int → 同名列（可用于历史摘要展示）</li>
<li>minority_int/oth_eqt_tools_p_shr → 同名列（股权桥计算使用）</li>
<li>notes_receiv + accounts_receiv/acct_receiv → accounts_receiv_bill（Fetcher 聚合）</li>
<li>
<p>fix_assets_total（若缺以 fix_assets 回填） → fix_assets_total（用于历史摘要展示，可选）</p>
</li>
<li>
<p>现金流量表 cashflow（→ input_data['cash_flow'] DataFrame）</p>
</li>
<li>end_date → end_date（转为 <code>pd.Timestamp</code>）</li>
<li>depr_fa_coga_dpba → depr_fa_coga_dpba（用于构造 EBITDA）</li>
<li>
<p>n_cashflow_act/n_cashflow_inv_act/n_cashflow_fin_act → 同名列（用于历史摘要展示，可选）</p>
</li>
<li>
<p>分红 dividend（→ ttm_dividends_df）</p>
</li>
<li>cash_div_tax → cash_div_tax（每股现金分红（含税））</li>
<li>若仅有 cash_div → 重命名为 cash_div_tax</li>
<li>end_date / ann_date → end_date（若缺 end_date 则使用 ann_date）</li>
<li>div_proc → div_proc（预案/通过/实施，便于构建 TTM 状态提示）</li>
</ul>
<h2 id="postgres-tushare">更高时效性替换点（postgres → tushare）</h2>
<ul>
<li>基本信息：list_status/delist_date/is_hs/hs_type/namechange（如启用）</li>
<li>每日指标：pe_ttm/pb/total_mv/circ_mv/total_share/float_share（按估值日获取，替换原库快照）</li>
<li>报表版本：优先 <code>update_flag='1'</code> 的正式版本；结合 <code>ann_date/f_ann_date</code> 与 <code>end_type</code> 精确筛取最新有效报表</li>
<li>分红进度：通过 <code>div_proc</code> 区分预案/通过/实施，优化 TTM 股息口径</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
