<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>DCF 核心业务逻辑与架构 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">01 project overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01_project_overview/" class="dropdown-item">项目概览文档</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_analysis_report/" class="dropdown-item">股票估值系统项目分析报告</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_status_2025_09_latest/" class="dropdown-item">股票估值系统项目状态报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">02 architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">架构设计文档</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">DCF 核心业务逻辑与架构</a>
</li>
                                    
<li>
    <a href="../hybrid_architecture_design/" class="dropdown-item">股票估值系统混合架构设计文档</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">03 development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../03_development/" class="dropdown-item">开发文档</a>
</li>
                                    
<li>
    <a href="../../03_development/development_guide_2025_09/" class="dropdown-item">股票估值系统开发指南</a>
</li>
                                    
<li>
    <a href="../../03_development/testing_strategy_2025_09/" class="dropdown-item">测试策略与质量保障指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">04 deployment</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../04_deployment/" class="dropdown-item">部署运维文档</a>
</li>
                                    
<li>
    <a href="../../04_deployment/deployment_operations_guide_2025_09/" class="dropdown-item">部署运维指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">05 data sources</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../05_data_sources/" class="dropdown-item">数据源专题文档</a>
</li>
                                    
<li>
    <a href="../../05_data_sources/tushare_alignment/" class="dropdown-item">TuShare数据源对齐与生产部署报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Archived</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../archived/" class="dropdown-item">归档文档</a>
</li>
                                    
<li>
    <a href="../../archived/Stock_investment_decision_making_process/" class="dropdown-item">Stock investment decision making process</a>
</li>
                                    
<li>
    <a href="../../archived/api_backend_comprehensive_analysis/" class="dropdown-item">Stock Valuation API 后端接口详细分析文档</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_industry_standards_comprehensive_analysis/" class="dropdown-item">DCF估值项目与行业标准深度对比分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_optimization_plan/" class="dropdown-item">DCF 核心业务逻辑优化方案（v1）</a>
</li>
                                    
<li>
    <a href="../../archived/dcf_rolling_revaluation_guide/" class="dropdown-item">DCF 滚动重评实践指南（季度/中报更新版）</a>
</li>
                                    
<li>
    <a href="../../archived/directory_optimization_plan/" class="dropdown-item">项目目录结构优化方案</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_financial_ratios_and_forecasting_analysis/" class="dropdown-item">Stock Vale Valuation 3.0 财务比率与预测逻辑 McKinsey 标准合规性专题分析报告</a>
</li>
                                    
<li>
    <a href="../../archived/mckinsey_standards_compliance_report/" class="dropdown-item">Stock Vale Valuation 3.0 项目 McKinsey 标准合规性分析报告</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../hybrid_architecture_design/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#dcf" class="nav-link">DCF 核心业务逻辑与架构</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">总体架构</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#wacc" class="nav-link">WACC 计算子流程</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">关键模块职责与输入/输出</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">环境变量与默认</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_4" class="nav-link">主要数据流与产出</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_5" class="nav-link">参考代码位置</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="dcf">DCF 核心业务逻辑与架构</h1>
<p>本文档概述本项目中 DCF 估值的核心业务流程、关键模块与数据流，并给出整体与子模块的架构图（Mermaid）。</p>
<h2 id="_1">总体架构</h2>
<pre><code class="language-mermaid">flowchart TD
    %% API 层与服务编排
    A[API 请求\n`src/api/main.py`\n`StockValuationRequest`] --&gt; B[DataProcessor\n清洗/比率/最新指标\n`src/core/financial/processor.py`]
    A --&gt;|估值参数| S[ValuationService\n编排 DCF 步骤\n`src/services/valuation_service.py`]

    %% 数据准备
    B --&gt;|historical_ratios\nlatest_metrics\nlatest_balance_sheet| S

    %% 预测与UFCF
    S --&gt; C[FinancialForecaster\n生成逐年预测DF\n`src/core/financial/forecaster.py`]
    C --&gt;|DataFrame: year, revenue, ebit, nopat, d_a, capex, NWC项, delta_nwc, ebitda, ufcf| S

    %% 资本成本
    S --&gt; D[WaccCalculator\n计算 WACC/Ke\n`src/core/calculators/dcf/wacc_calculator.py`]
    D --&gt;|wacc, ke| S

    %% 终值计算
    S --&gt; E[TerminalValueCalculator\n终值: 退出乘数/永续增长\n`src/core/calculators/dcf/terminal_value_calculator.py`]
    E --&gt;|terminal_value| S

    %% 现值折现
    S --&gt; F[PresentValueCalculator\n折现UFCF与TV\n`src/core/calculators/dcf/present_value_calculator.py`]
    F --&gt;|pv_ufcf, pv_tv| S

    %% 股权桥梁
    S --&gt; G[EquityBridgeCalculator\nEV-&gt;Equity-&gt;VPS\n`src/core/calculators/equity_bridge_calculator.py`]
    G --&gt;|net_debt, equity_value, value_per_share| S

    %% 输出
    S --&gt; H[DcfForecastDetails\n`src/api/models.py`]
    H --&gt; R[API 响应/前端]
</code></pre>
<h2 id="wacc">WACC 计算子流程</h2>
<pre><code class="language-mermaid">flowchart LR
    subgraph Inputs
    P1[参数: risk_free_rate, beta, market_risk_premium, size_premium, country_risk_premium, industry_risk_premium, cost_of_debt, tax_rate]
    P2[权重模式: target 或 market]
    P3[目标债务比例 target_debt_ratio]
    P4[最新市值 market_cap &amp; 资产负债表]
    end

    P1 --&gt; W{WaccCalculator}
    P2 --&gt; W
    P3 --&gt; W
    P4 --&gt;|market 模式\n债务市值近似账面| W

    W --&gt;|Ke = Rf + β*(MRP+CRP) + Size + Industry| Ke[Ke]
    W --&gt;|Kd(AT) = Kd*(1-T)| Kd[税后债务成本]
    W --&gt;|权重: target 或 market| WT[Equity/ Debt 比例]
    Ke --&gt; X[WACC = E*Ke + D*Kd(AT)]
    Kd --&gt; X
    WT --&gt; X
</code></pre>
<h2 id="_2">关键模块职责与输入/输出</h2>
<ul>
<li><code>DataProcessor</code>（数据准备）</li>
<li>输入：原始三大报表、基本信息、PE/PB、股息、价格等</li>
<li>输出：<code>processed_data</code>（清洗后的报表）、<code>historical_ratios</code>（中位数/天数）、<code>latest_metrics</code>、<code>latest_balance_sheet</code></li>
<li><code>FinancialForecaster</code>（财务预测）</li>
<li>输入：上一年度收入、历史比率、预测假设（利润率/各项比率与天数/过渡年数等）</li>
<li>输出：含逐年 <code>year, revenue, ebit, nopat, d_a, capex, NWC 分项, delta_nwc, ebitda, ufcf</code> 的 DataFrame</li>
<li><code>FcfCalculator</code>（UFCF）</li>
<li>公式：<code>ufcf = nopat + d_a - capex - delta_nwc</code></li>
<li>就地回填 <code>ufcf</code> 列（Decimal 计算，异常/NaN 防护）</li>
<li><code>WaccCalculator</code>（WACC/Ke）</li>
<li>Ke（增强 CAPM）：<code>Ke = Rf + β*(MRP + CRP) + Size + Industry</code></li>
<li>债务成本税后：<code>Kd(AT) = Kd*(1 - Tax)</code></li>
<li>权重：<code>target</code>（<code>target_debt_ratio</code>）或 <code>market</code>（以市值/账面债务近似求权重）</li>
<li>返回：<code>(wacc, ke)</code>；含大量类型/范围校验与回退</li>
<li><code>TerminalValueCalculator</code>（终值）</li>
<li>Exit Multiple：<code>TV = EBITDA_T * ExitMultiple</code></li>
<li>Perpetual Growth：若启用 GDP 上限，<code>g = min(g_input, GDP_CAP)</code>；要求 <code>g &lt; wacc</code><ul>
<li>公式：<code>TV = UFCF_T * (1 + g) / (wacc - g)</code></li>
</ul>
</li>
<li><code>PresentValueCalculator</code>（现值折现）</li>
<li>年中折现可选：指数 <code>t-0.5</code></li>
<li>输出：<code>pv_ufcf</code> 与 <code>pv_tv</code>（Decimal 逐期折现并汇总）</li>
<li><code>EquityBridgeCalculator</code>（股权桥）</li>
<li><code>NetDebt = (LT/ST 借款 + 债券 + 一年内到期非流动负债) - 货币资金</code></li>
<li><code>EquityValue = EV - NetDebt - MinorityInterest - PreferredEquity</code></li>
<li><code>Value/Share = EquityValue / TotalShares</code></li>
<li><code>ValuationService</code>（编排与防护）</li>
<li>顺序：预测 -&gt; WACC -&gt; 终值 -&gt; 现值 -&gt; 股权桥 -&gt; 汇总 <code>DcfForecastDetails</code></li>
<li>逻辑：API 假设键映射、市场权重失败回退目标权重、默认 ExitMultiple/PGR、<code>g&lt;w</code> 守护、调试快照、敏感性分析</li>
</ul>
<h2 id="_3">环境变量与默认</h2>
<ul>
<li><code>WaccCalculator</code>：<code>DEFAULT_BETA</code>, <code>RISK_FREE_RATE</code>, <code>MARKET_RISK_PREMIUM</code>, <code>COUNTRY_RISK_PREMIUM</code>, <code>INDUSTRY_RISK_PREMIUM</code>, <code>DEFAULT_COST_OF_DEBT</code>, <code>DEFAULT_TARGET_TAX_RATE</code>, <code>DEFAULT_SIZE_PREMIUM</code>, <code>TARGET_DEBT_RATIO</code></li>
<li><code>TerminalValueCalculator</code>：<code>USE_GDP_CAP</code>（默认为 true），<code>GDP_NOMINAL_CAP</code>（默认 0.05）</li>
<li><code>ValuationService</code>：<code>DEFAULT_EXIT_MULTIPLE</code>（默认 8.0），<code>DEFAULT_PERPETUAL_GROWTH_RATE</code>（默认 0.025）</li>
</ul>
<h2 id="_4">主要数据流与产出</h2>
<ol>
<li>DataProcessor 清洗数据、计算历史中位数/天数与最新指标</li>
<li>FinancialForecaster 基于历史与假设生成逐年预测，<code>FcfCalculator</code> 填充 <code>ufcf</code></li>
<li>WaccCalculator 计算 <code>wacc, ke</code>（支持 market/target 权重）</li>
<li>TerminalValueCalculator 计算终值（Exit Multiple 或 Perpetual Growth，含 GDP 上限与 <code>g&lt;w</code> 校验）</li>
<li>PresentValueCalculator 将 UFCF 与 TV 折现为现值（可年中折现）</li>
<li>EquityBridgeCalculator 计算净债务、股权价值、每股价值</li>
<li>汇总为 <code>DcfForecastDetails</code> 返回 API/前端</li>
</ol>
<h2 id="_5">参考代码位置</h2>
<ul>
<li>Valuation 编排：<code>src/services/valuation_service.py</code></li>
<li>WACC/终值/现值/UFCF/股权桥：</li>
<li><code>src/core/calculators/dcf/wacc_calculator.py</code></li>
<li><code>src/core/calculators/dcf/terminal_value_calculator.py</code></li>
<li><code>src/core/calculators/dcf/present_value_calculator.py</code></li>
<li><code>src/core/calculators/dcf/fcf_calculator.py</code></li>
<li><code>src/core/calculators/equity_bridge_calculator.py</code></li>
<li>预测器/数据处理：</li>
<li><code>src/core/financial/forecaster.py</code></li>
<li><code>src/core/financial/processor.py</code></li>
<li>DCF 结果模型：<code>src/api/models.py</code>
```</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
