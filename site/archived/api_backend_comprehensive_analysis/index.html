<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Stock Valuation API 后端接口详细分析文档 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">01 project overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01_project_overview/" class="dropdown-item">项目概览文档</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_analysis_report/" class="dropdown-item">股票估值系统项目分析报告</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_status_2025_09_latest/" class="dropdown-item">股票估值系统项目状态报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">02 architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../02_architecture/" class="dropdown-item">架构设计文档</a>
</li>
                                    
<li>
    <a href="../../02_architecture/dcf_architecture/" class="dropdown-item">DCF 核心业务逻辑与架构</a>
</li>
                                    
<li>
    <a href="../../02_architecture/hybrid_architecture_design/" class="dropdown-item">股票估值系统混合架构设计文档</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">03 development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../03_development/" class="dropdown-item">开发文档</a>
</li>
                                    
<li>
    <a href="../../03_development/development_guide_2025_09/" class="dropdown-item">股票估值系统开发指南</a>
</li>
                                    
<li>
    <a href="../../03_development/testing_strategy_2025_09/" class="dropdown-item">测试策略与质量保障指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">04 deployment</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../04_deployment/" class="dropdown-item">部署运维文档</a>
</li>
                                    
<li>
    <a href="../../04_deployment/deployment_operations_guide_2025_09/" class="dropdown-item">部署运维指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">05 data sources</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../05_data_sources/" class="dropdown-item">数据源专题文档</a>
</li>
                                    
<li>
    <a href="../../05_data_sources/tushare_alignment/" class="dropdown-item">TuShare数据源对齐与生产部署报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Archived</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">归档文档</a>
</li>
                                    
<li>
    <a href="../Stock_investment_decision_making_process/" class="dropdown-item">Stock investment decision making process</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Stock Valuation API 后端接口详细分析文档</a>
</li>
                                    
<li>
    <a href="../dcf_industry_standards_comprehensive_analysis/" class="dropdown-item">DCF估值项目与行业标准深度对比分析报告</a>
</li>
                                    
<li>
    <a href="../dcf_optimization_plan/" class="dropdown-item">DCF 核心业务逻辑优化方案（v1）</a>
</li>
                                    
<li>
    <a href="../dcf_rolling_revaluation_guide/" class="dropdown-item">DCF 滚动重评实践指南（季度/中报更新版）</a>
</li>
                                    
<li>
    <a href="../directory_optimization_plan/" class="dropdown-item">项目目录结构优化方案</a>
</li>
                                    
<li>
    <a href="../mckinsey_financial_ratios_and_forecasting_analysis/" class="dropdown-item">Stock Vale Valuation 3.0 财务比率与预测逻辑 McKinsey 标准合规性专题分析报告</a>
</li>
                                    
<li>
    <a href="../mckinsey_standards_compliance_report/" class="dropdown-item">Stock Vale Valuation 3.0 项目 McKinsey 标准合规性分析报告</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Stock_investment_decision_making_process/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../dcf_industry_standards_comprehensive_analysis/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#stock-valuation-api" class="nav-link">Stock Valuation API 后端接口详细分析文档</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">📋 目录</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#api" class="nav-link">🌐 API概览</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_5" class="nav-link">🔗 接口详情</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_10" class="nav-link">📋 参数约束条件总结表</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_21" class="nav-link">📊 数据模型</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_24" class="nav-link">⚠️ 错误处理</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_31" class="nav-link">🚀 部署和测试</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_49" class="nav-link">💡 使用示例</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_51" class="nav-link">📝 最佳实践</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_52" class="nav-link">🔧 故障排除</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_55" class="nav-link">📊 监控和运维</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_60" class="nav-link">📅 最新更新记录</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="stock-valuation-api">Stock Valuation API 后端接口详细分析文档</h1>
<p><em>最后更新: 2025-09-22</em></p>
<h2 id="_1">📋 目录</h2>
<ul>
<li><a href="#api概览">API概览</a></li>
<li><a href="#接口详情">接口详情</a></li>
<li><a href="#1-根路径接口">1. 根路径接口</a></li>
<li><a href="#2-股票估值接口">2. 股票估值接口</a></li>
<li><a href="#3-敏感性分析接口">3. 敏感性分析接口</a></li>
<li><a href="#4-股票筛选接口">4. 股票筛选接口</a></li>
<li><a href="#数据模型">数据模型</a></li>
<li><a href="#错误处理">错误处理</a></li>
<li><a href="#部署和测试">部署和测试</a></li>
<li><a href="#使用示例">使用示例</a></li>
<li><a href="#最新更新记录">最新更新记录</a></li>
</ul>
<hr />
<h2 id="api">🌐 API概览</h2>
<h3 id="_2">基本信息</h3>
<ul>
<li><strong>服务名称</strong>: Stock Valuation API</li>
<li><strong>版本</strong>: 3.0.0</li>
<li><strong>框架</strong>: FastAPI</li>
<li><strong>端口</strong>: 8124</li>
<li><strong>协议</strong>: HTTP/HTTPS</li>
<li><strong>数据格式</strong>: JSON</li>
<li><strong>数据源</strong>: TuShare(主要) + PostgreSQL(验证)</li>
</ul>
<h3 id="_3">核心功能</h3>
<ol>
<li><strong>DCF估值计算</strong>: 基于折现现金流的企业估值分析，支持退出倍数法和永续增长法</li>
<li><strong>敏感性分析</strong>: 多维度参数敏感性分析，生成sensitivity table</li>
<li><strong>股票筛选</strong>: 基于财务指标的多条件股票筛选器</li>
<li><strong>LLM智能分析</strong>: 集成DeepSeek/OpenAI兼容模型生成投资分析报告</li>
<li><strong>LTM基线</strong>: 支持Last Twelve Months收入基期，提升时效性</li>
<li><strong>LLM智能分析</strong>: 集成大语言模型的投资建议</li>
<li><strong>数据管理</strong>: 股票基本信息和行情数据更新</li>
<li><strong>股票筛选</strong>: 基于财务指标的股票筛选器</li>
</ol>
<h3 id="_4">技术架构</h3>
<pre><code>FastAPI App
├── CORS Middleware (跨域支持)
├── Routes (路由层)
│   ├── Main Routes (主要业务接口)
│   ├── Data Update Routes (数据更新接口)
│   └── Stock Screener Routes (股票筛选接口)
├── Services (业务服务层)
│   ├── ValuationService (估值服务)
│   ├── DataProcessor (数据处理服务)
│   └── LLM Utils (LLM调用工具)
├── Core Calculators (核心计算器)
│   ├── WACC Calculator (资本成本计算)
│   ├── DCF Calculators (DCF计算器集群)
│   └── Financial Forecaster (财务预测器)
└── Data Layer (数据层)
    ├── AshareDataFetcher (数据获取器)
    └── PostgreSQL (数据库)
</code></pre>
<h3 id="2025-09-10">2025-09-10 变更要点（新增/调整字段与行为）</h3>
<ul>
<li>请求新增/强调</li>
<li><code>industry_preset_key</code>：行业模板键（模板加载，不限编辑）</li>
<li><code>use_gdp_cap</code> / <code>gdp_nominal_cap</code>：名义 GDP 上限控制（PGR clamp）</li>
<li><code>ltm_baseline_enabled</code>：启用 LTM/Interim 经营基期</li>
<li>响应新增（StockBasicInfoModel）</li>
<li><code>latest_price_as_of_date</code>：价格 as-of（trade_date ≤ 估值日）</li>
<li><code>eps_annual_as_of_year</code>：EPS（年报）年份（end_date ≤ 估值日）</li>
<li><code>ttm_dps_source</code>：TTM 股息来源（implemented/proposal/latest_annual）</li>
<li><code>ttm_window_start</code>/<code>ttm_window_end</code>：TTM 窗口（若适用）</li>
<li>响应 Debug（ValuationResultsContainer.debug_request_slice）</li>
<li><code>baseline_debug</code>：Annual/LTM 模式与 LTM 组成</li>
<li><code>applied_preset</code> 与 <code>applied_preset_diff</code>：已应用行业模板与偏离情况（within/warn/alert）</li>
<li>终值与隐含指标</li>
<li>永续增长：按 <code>min(pg_rate, GDP_cap)</code> 夹持（来源提示）</li>
<li>退出乘数：计算隐含 PGR 并与 GDP 上限对比提示</li>
<li>数据层行为</li>
<li>最新价格按估值日回退（<code>trade_date ≤ 估值日</code>）</li>
<li>股息 TTM：实施/完成 → 无则 TTM·预案 → 仍无则 年度最近一次</li>
</ul>
<h3 id="2025-09-11">2025-09-11 变更要点（敏感性与稳健性增强）</h3>
<ul>
<li>敏感性输出扩展</li>
<li>新增 <code>result_tables.ev_ebitda_terminal</code>：基于“末期预测 EBITDA”的 EV/EBITDA（与 LTM 口径区分）。</li>
<li>新增 <code>result_tables.implied_pgr</code>：当采用退出乘数法时，逐格计算隐含永续增长率 <code>g = (TV*WACC − FCF_T) / (TV + FCF_T)</code>。</li>
<li><code>result_tables.dcf_implied_pe</code> 支持按格回退：若单元格未返回 <code>dcf_implied_diluted_pe</code>，将用基准 EPS（最近年报）和该格每股价值计算回填。</li>
<li>物理可行性约束</li>
<li>当单元格采用永续增长法且 <code>g ≥ WACC</code> 时直接跳过计算，单元格置为 <code>null</code>，同时在 <code>data_warnings</code> 中追加提示。</li>
<li>WACC 计算稳健性</li>
<li>当 <code>wacc_weight_mode = market</code> 且市场权重路径失败时，自动回退至 <code>target</code> 权重并记录警告，不再导致 500。</li>
<li>文档澄清</li>
<li>明确区分 <code>result_tables.ev_ebitda</code>（LTM 口径）与 <code>result_tables.ev_ebitda_terminal</code>（末期口径）；默认继续输出 LTM 以便对标现实口径，末期口径为补充表。</li>
<li>轴再生策略：WACC 轴在提供 <code>step+points</code> 时总是围绕基准再生；其他轴仅在 <code>values</code> 空且提供 <code>step+points</code> 时再生（后续可统一）。</li>
</ul>
<hr />
<h2 id="_5">🔗 接口详情</h2>
<h3 id="1">1. 根路径接口</h3>
<h4 id="get">GET <code>/</code></h4>
<p><strong>接口描述</strong>: API健康检查和基本信息</p>
<p><strong>请求参数</strong>: 无</p>
<p><strong>响应格式</strong>:</p>
<pre><code class="language-json">{
    &quot;message&quot;: &quot;Welcome to the Stock Valuation API (Streamlit Backend)&quot;
}
</code></pre>
<p>注（口径说明，2025-09-10 更新）：
- LTM/基期收入选择统一“优先营业收入 revenue，回退 total_revenue”。
- <code>baseline_debug</code> 中仍保留 <code>ytd_curr_total_revenue</code>、<code>ytd_prev_total_revenue</code>、<code>prev_annual_total_revenue</code> 等字段以便审计；但实际用于基期选择的优先级为 <code>revenue</code> 对应字段，其次才是 <code>total_revenue</code> 对应字段。</p>
<p><strong>状态码</strong>:
- <code>200</code>: 成功</p>
<p><strong>使用场景</strong>: 
- API健康检查
- 服务可用性验证</p>
<hr />
<h3 id="2">2. 股票估值接口</h3>
<h4 id="post-apiv1valuation">POST <code>/api/v1/valuation</code></h4>
<p><strong>接口描述</strong>: 计算股票DCF估值，支持敏感性分析和LLM智能分析</p>
<p><strong>请求模型</strong>: StockValuationRequest</p>
<p><strong>请求参数详解</strong>:</p>
<h5 id="_6">基础参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
<th>约束条件</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ts_code</code></td>
<td>string</td>
<td>是</td>
<td>无</td>
<td>股票代码</td>
<td>符合A股格式(6数字.SH/SZ)</td>
<td>"600519.SH"</td>
</tr>
<tr>
<td><code>market</code></td>
<td>string</td>
<td>否</td>
<td>"A"</td>
<td>市场标识</td>
<td>枚举值: "A", "HK"</td>
<td>"A"</td>
</tr>
<tr>
<td><code>valuation_date</code></td>
<td>string</td>
<td>否</td>
<td>最新日期</td>
<td>估值基准日期</td>
<td>YYYY-MM-DD格式</td>
<td>"2024-12-31"</td>
</tr>
<tr>
<td><code>ltm_baseline_enabled</code></td>
<td>bool</td>
<td>否</td>
<td>false</td>
<td>是否使用LTM/Interim基期</td>
<td>布尔值</td>
<td>true, false</td>
</tr>
</tbody>
</table>
<h5 id="dcf">DCF核心假设参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
<th>约束条件</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>forecast_years</code></td>
<td>int</td>
<td>否</td>
<td>5</td>
<td>预测期年数</td>
<td>1-20年整数</td>
<td>5, 10, 15</td>
</tr>
<tr>
<td><code>cagr_decay_rate</code></td>
<td>float</td>
<td>否</td>
<td>系统计算</td>
<td>历史CAGR年衰减率</td>
<td>0-1之间</td>
<td>0.1, 0.2</td>
</tr>
<tr>
<td><code>op_margin_forecast_mode</code></td>
<td>string</td>
<td>否</td>
<td>"historical_median"</td>
<td>营业利润率预测模式</td>
<td>枚举值: "historical_median", "transition_to_target"</td>
<td>"historical_median"</td>
</tr>
<tr>
<td><code>target_operating_margin</code></td>
<td>float</td>
<td>否</td>
<td>无</td>
<td>目标营业利润率</td>
<td>0-1之间，transition模式必需</td>
<td>0.25, 0.30</td>
</tr>
<tr>
<td><code>op_margin_transition_years</code></td>
<td>int</td>
<td>否</td>
<td>无</td>
<td>利润率过渡年数</td>
<td>&gt;=1，transition模式必需</td>
<td>3, 5</td>
</tr>
</tbody>
</table>
<h5 id="wacc">WACC计算参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
<th>约束条件</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>wacc_weight_mode</code></td>
<td>string</td>
<td>否</td>
<td>"target"</td>
<td>WACC权重计算模式</td>
<td>正则: <code>^(target\|market)$</code></td>
<td>"target"</td>
</tr>
<tr>
<td><code>target_debt_ratio</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>目标债务比例</td>
<td>0-1之间，target模式必需</td>
<td>0.3, 0.4</td>
</tr>
<tr>
<td><code>cost_of_debt</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>税前债务成本</td>
<td>&gt;=0</td>
<td>0.05, 0.08</td>
</tr>
<tr>
<td><code>risk_free_rate</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>无风险利率</td>
<td>&gt;=0</td>
<td>0.03, 0.035</td>
</tr>
<tr>
<td><code>beta</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>贝塔系数</td>
<td>任意实数</td>
<td>1.2, 0.8</td>
</tr>
<tr>
<td><code>market_risk_premium</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>市场风险溢价</td>
<td>&gt;=0</td>
<td>0.05, 0.06</td>
</tr>
<tr>
<td><code>size_premium</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>规模溢价</td>
<td>任意实数</td>
<td>0.02, -0.01</td>
</tr>
</tbody>
</table>
<h5 id="_7">终值计算参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
<th>约束条件</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>terminal_value_method</code></td>
<td>string</td>
<td>否</td>
<td>"exit_multiple"</td>
<td>终值计算方法</td>
<td>枚举值: "exit_multiple", "perpetual_growth"</td>
<td>"exit_multiple"</td>
</tr>
<tr>
<td><code>exit_multiple</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>退出乘数</td>
<td>&gt;=0，exit_multiple模式必需</td>
<td>15.0, 18.0</td>
</tr>
<tr>
<td><code>perpetual_growth_rate</code></td>
<td>float</td>
<td>否</td>
<td>系统默认</td>
<td>永续增长率</td>
<td>&gt;=0，perpetual_growth模式必需</td>
<td>0.03, 0.035</td>
</tr>
</tbody>
</table>
<h5 id="llm">LLM控制参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>默认值</th>
<th>说明</th>
<th>约束条件</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>request_llm_summary</code></td>
<td>bool</td>
<td>否</td>
<td>false</td>
<td>是否请求LLM分析</td>
<td>布尔值</td>
<td>true, false</td>
</tr>
<tr>
<td><code>llm_provider</code></td>
<td>string</td>
<td>否</td>
<td>系统默认</td>
<td>LLM提供商</td>
<td>字符串</td>
<td>"deepseek", "openai"</td>
</tr>
<tr>
<td><code>llm_model_id</code></td>
<td>string</td>
<td>否</td>
<td>系统默认</td>
<td>LLM模型ID</td>
<td>字符串</td>
<td>"deepseek-chat", "gpt-4"</td>
</tr>
<tr>
<td><code>llm_api_base_url</code></td>
<td>string</td>
<td>否</td>
<td>系统默认</td>
<td>自定义API地址</td>
<td>URL格式</td>
<td>"https://api.deepseek.com"</td>
</tr>
<tr>
<td><code>llm_temperature</code></td>
<td>float</td>
<td>否</td>
<td>0.7</td>
<td>生成温度参数</td>
<td>0.0-2.0之间</td>
<td>0.5, 1.0, 1.5</td>
</tr>
<tr>
<td><code>llm_top_p</code></td>
<td>float</td>
<td>否</td>
<td>0.9</td>
<td>Top-P参数</td>
<td>0.0-1.0之间</td>
<td>0.8, 0.95</td>
</tr>
<tr>
<td><code>llm_max_tokens</code></td>
<td>int</td>
<td>否</td>
<td>4000</td>
<td>最大Token数</td>
<td>&gt;=1</td>
<td>2000, 4096</td>
</tr>
</tbody>
</table>
<h5 id="_8">敏感性分析参数</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>必填</th>
<th>说明</th>
<th>约束条件</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sensitivity_analysis</code></td>
<td>SensitivityAnalysisRequest</td>
<td>否</td>
<td>敏感性分析配置</td>
<td>复杂对象结构</td>
</tr>
</tbody>
</table>
<p><strong>详细请求体示例</strong>:</p>
<h5 id="1_1">1. 基础估值请求</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 5,
    &quot;request_llm_summary&quot;: false,
    &quot;ltm_baseline_enabled&quot;: false
}
</code></pre>
<h5 id="2_1">2. 完整参数请求（包含所有约束条件示例）</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;market&quot;: &quot;A&quot;,
    &quot;valuation_date&quot;: &quot;2024-12-31&quot;,

    &quot;forecast_years&quot;: 10,
    &quot;cagr_decay_rate&quot;: 0.15,
    &quot;op_margin_forecast_mode&quot;: &quot;transition_to_target&quot;,
    &quot;target_operating_margin&quot;: 0.30,
    &quot;op_margin_transition_years&quot;: 5,

    &quot;wacc_weight_mode&quot;: &quot;target&quot;,
    &quot;target_debt_ratio&quot;: 0.35,
    &quot;cost_of_debt&quot;: 0.045,
    &quot;risk_free_rate&quot;: 0.03,
    &quot;beta&quot;: 1.1,
    &quot;market_risk_premium&quot;: 0.055,
    &quot;size_premium&quot;: 0.015,

    &quot;terminal_value_method&quot;: &quot;exit_multiple&quot;,
    &quot;exit_multiple&quot;: 16.5,
    &quot;ltm_baseline_enabled&quot;: true,

    &quot;request_llm_summary&quot;: true,
    &quot;llm_provider&quot;: &quot;deepseek&quot;,
    &quot;llm_model_id&quot;: &quot;deepseek-chat&quot;,
    &quot;llm_api_base_url&quot;: &quot;https://api.deepseek.com&quot;,
    &quot;llm_temperature&quot;: 0.8,
    &quot;llm_top_p&quot;: 0.9,
    &quot;llm_max_tokens&quot;: 3000
}
</code></pre>
<h5 id="3">3. 边界值测试请求</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 20,
    &quot;cagr_decay_rate&quot;: 0.99,
    &quot;target_operating_margin&quot;: 0.99,
    &quot;op_margin_transition_years&quot;: 1,
    &quot;target_debt_ratio&quot;: 0.99,
    &quot;cost_of_debt&quot;: 0.20,
    &quot;risk_free_rate&quot;: 0.15,
    &quot;llm_temperature&quot;: 2.0,
    &quot;llm_top_p&quot;: 1.0,
    &quot;llm_max_tokens&quot;: 1
}
</code></pre>
<h5 id="4">4. 敏感性分析请求</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 5,
    &quot;sensitivity_analysis&quot;: {
        &quot;row_axis&quot;: {
            &quot;parameter_name&quot;: &quot;wacc&quot;,
            &quot;values&quot;: [0.08, 0.09, 0.10, 0.11],
            &quot;step&quot;: 0.01,
            &quot;points&quot;: 4
        },
        &quot;column_axis&quot;: {
            &quot;parameter_name&quot;: &quot;exit_multiple&quot;,
            &quot;values&quot;: [14, 16, 18, 20],
            &quot;step&quot;: 2,
            &quot;points&quot;: 4
        }
    }
}
</code></pre>
<h5 id="5">5. 永续增长法请求</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 8,
    &quot;terminal_value_method&quot;: &quot;perpetual_growth&quot;,
    &quot;perpetual_growth_rate&quot;: 0.035,
    &quot;wacc_weight_mode&quot;: &quot;market&quot;,
    &quot;ltm_baseline_enabled&quot;: true,
    &quot;request_llm_summary&quot;: true
}
</code></pre>
<h5 id="6">6. 错误请求示例（违反约束条件）</h5>
<pre><code class="language-json">{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 25,  // 错误：超过最大值20
    &quot;cagr_decay_rate&quot;: 1.5,  // 错误：超过最大值1
    &quot;target_operating_margin&quot;: -0.1,  // 错误：负值
    &quot;llm_temperature&quot;: 3.0,  // 错误：超过最大值2.0
    &quot;llm_top_p&quot;: 1.5,  // 错误：超过最大值1.0
    &quot;wacc_weight_mode&quot;: &quot;invalid_mode&quot;  // 错误：不在枚举值中
}
</code></pre>
<p><strong>响应模型</strong>: StockValuationResponse</p>
<p><strong>响应格式详解</strong>:</p>
<h5 id="1-">1. 成功响应 - 基础估值</h5>
<pre><code class="language-json">{
    &quot;stock_info&quot;: {
        &quot;ts_code&quot;: &quot;600519.SH&quot;,
        &quot;name&quot;: &quot;贵州茅台&quot;,
        &quot;industry&quot;: &quot;白酒&quot;,
        &quot;list_date&quot;: &quot;2001-08-27&quot;,
        &quot;exchange&quot;: &quot;上交所&quot;,
        &quot;currency&quot;: &quot;CNY&quot;,
        &quot;market&quot;: &quot;A&quot;,
        &quot;latest_pe_ttm&quot;: 45.2,
        &quot;latest_pb_mrq&quot;: 12.8,
        &quot;total_shares&quot;: 1256197800,
        &quot;free_float_shares&quot;: 1256197800,
        &quot;ttm_dps&quot;: 25.91,
        &quot;dividend_yield&quot;: 0.0158,
        &quot;act_name&quot;: &quot;贵州省人民政府国有资产监督管理委员会&quot;,
        &quot;act_ent_type&quot;: &quot;国企&quot;,
        &quot;latest_annual_diluted_eps&quot;: 49.32,
        &quot;base_report_date&quot;: &quot;2024-09-30&quot;
    },
    &quot;valuation_results&quot;: {
        &quot;latest_price&quot;: 1725.0,
        &quot;current_pe&quot;: 45.2,
        &quot;current_pb&quot;: 12.8,
        &quot;dcf_forecast_details&quot;: {
            &quot;enterprise_value&quot;: 2150000000000,
            &quot;equity_value&quot;: 2100000000000,
            &quot;value_per_share&quot;: 1675.5,
            &quot;net_debt&quot;: 50000000000,
            &quot;pv_forecast_ufcf&quot;: 800000000000,
            &quot;pv_terminal_value&quot;: 1350000000000,
            &quot;terminal_value&quot;: 2500000000000,
            &quot;wacc_used&quot;: 0.085,
            &quot;cost_of_equity_used&quot;: 0.12,
            &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
            &quot;exit_multiple_used&quot;: 15.2,
            &quot;perpetual_growth_rate_used&quot;: null,
            &quot;forecast_period_years&quot;: 5,
            &quot;dcf_implied_diluted_pe&quot;: 33.97,
            &quot;base_ev_ebitda&quot;: 18.5,
            &quot;implied_perpetual_growth_rate&quot;: 0.035
        },
        &quot;other_analysis&quot;: {
            &quot;dividend_analysis&quot;: {
                &quot;current_yield_pct&quot;: 1.58,
                &quot;avg_dividend_3y&quot;: 22.5,
                &quot;payout_ratio_pct&quot;: 52.5
            },
            &quot;growth_analysis&quot;: {
                &quot;net_income_cagr_3y&quot;: 15.2,
                &quot;revenue_cagr_3y&quot;: 18.7
            }
        },
        &quot;detailed_forecast_table&quot;: [
            {
                &quot;year&quot;: 2024,
                &quot;revenue&quot;: 150000000000,
                &quot;revenue_growth&quot;: 0.18,
                &quot;gross_profit&quot;: 120000000000,
                &quot;operating_profit&quot;: 75000000000,
                &quot;operating_margin&quot;: 0.50,
                &quot;ebit&quot;: 75000000000,
                &quot;tax_rate&quot;: 0.25,
                &quot;nopat&quot;: 56250000000,
                &quot;da&quot;: 8000000000,
                &quot;capex&quot;: 12000000000,
                &quot;nwc_change&quot;: 5000000000,
                &quot;ufcf&quot;: 47250000000,
                &quot;nwc&quot;: 30000000000,
                &quot;nwc_days&quot;: 73
            },
            {
                &quot;year&quot;: 2025,
                &quot;revenue&quot;: 168000000000,
                &quot;revenue_growth&quot;: 0.12,
                &quot;gross_profit&quot;: 134400000000,
                &quot;operating_profit&quot;: 84000000000,
                &quot;operating_margin&quot;: 0.50,
                &quot;ebit&quot;: 84000000000,
                &quot;tax_rate&quot;: 0.25,
                &quot;nopat&quot;: 63000000000,
                &quot;da&quot;: 8960000000,
                &quot;capex&quot;: 13440000000,
                &quot;nwc_change&quot;: 5600000000,
                &quot;ufcf&quot;: 52960000000,
                &quot;nwc&quot;: 35600000000,
                &quot;nwc_days&quot;: 73
            }
        ],
        &quot;sensitivity_analysis_result&quot;: null,
        &quot;llm_analysis_summary&quot;: null,
        &quot;data_warnings&quot;: [
            &quot;2024年数据为基于前三个季度的预测值&quot;,
            &quot;部分历史数据缺失，使用行业平均值替代&quot;
        ],
        &quot;historical_financial_summary&quot;: [
            {
                &quot;year&quot;: 2023,
                &quot;revenue&quot;: 129700000000,
                &quot;operating_profit&quot;: 64850000000,
                &quot;net_income&quot;: 48550000000,
                &quot;total_assets&quot;: 185000000000,
                &quot;total_liabilities&quot;: 45000000000
            }
        ],
        &quot;historical_ratios_summary&quot;: [
            {
                &quot;year&quot;: 2023,
                &quot;operating_margin&quot;: 0.50,
                &quot;roic&quot;: 0.28,
                &quot;asset_turnover&quot;: 0.70,
                &quot;debt_to_equity&quot;: 0.32
            }
        ],
        &quot;special_industry_warning&quot;: null
    },
    &quot;error&quot;: null
}
</code></pre>
<h5 id="_9">调试字段说明（片段）</h5>
<p>响应中还包含用于审计/调试的片段：</p>
<pre><code class="language-json">{
  &quot;valuation_results&quot;: {
    &quot;debug_request_slice&quot;: {
      &quot;forecast_years&quot;: 5,
      &quot;ltm_baseline_enabled&quot;: true,
      &quot;nwc_baseline_mode&quot;: &quot;component&quot;,
      &quot;baseline_debug&quot;: { &quot;mode&quot;: &quot;LTM&quot;, &quot;curr_end_date&quot;: &quot;2025-06-30&quot;, &quot;curr_end_type&quot;: &quot;2&quot; }
    }
  }
}
</code></pre>
<p>其中 <code>baseline_debug</code> 会在 LTM 模式下包含 YTD/LTM 的分解；在 Annual 模式为 <code>{ "mode": "Annual" }</code>。</p>
<h6 id="vs">对照说明（最小节选 vs 完整版）</h6>
<ul>
<li>最小节选：仅返回前端最常用的快取字段（<code>value_per_share</code>、<code>wacc_used</code>、<code>exit_multiple_used</code>、价格与TTM分红口径等），<code>debug_request_slice</code> 仅含 <code>baseline_debug</code>。</li>
<li>完整版：在最小节选基础上，补充 <code>detailed_forecast_table</code>、<code>historical_*</code>、LLM摘要、以及 <code>debug_request_slice.applied_preset</code> 与 <code>applied_preset_diff</code>（含区间与偏离状态）。</li>
<li>该对照用于 UI 快速加载与审计深挖两种路径，接口一致，字段可选返回。</li>
</ul>
<h6 id="11-">1.1 成功响应 - 最小节选（便于前端快速取用）</h6>
<pre><code class="language-json">{
  &quot;stock_info&quot;: {
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;name&quot;: &quot;贵州茅台&quot;,
    &quot;market&quot;: &quot;主板&quot;,
    &quot;latest_annual_diluted_eps&quot;: 68.64,
    &quot;base_report_date&quot;: &quot;2023-12-31&quot;,
    &quot;latest_price_as_of_date&quot;: &quot;2024-10-15&quot;,
    &quot;eps_annual_as_of_year&quot;: 2023,
    &quot;ttm_dps&quot;: 49.982,
    &quot;dividend_yield&quot;: 0.0349,
    &quot;ttm_dps_source&quot;: &quot;implemented&quot;
  },
  &quot;valuation_results&quot;: {
    &quot;latest_price&quot;: 1476.1,
    &quot;current_pe&quot;: 28.08,
    &quot;current_pb&quot;: 9.73,
    &quot;dcf_forecast_details&quot;: {
      &quot;value_per_share&quot;: 2318.05,
      &quot;wacc_used&quot;: 0.0609,
      &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
      &quot;exit_multiple_used&quot;: 15.0,
      &quot;implied_perpetual_growth_rate&quot;: 0.0169
    },
    &quot;debug_request_slice&quot;: {
      &quot;baseline_debug&quot;: { &quot;mode&quot;: &quot;LTM&quot;, &quot;curr_end_date&quot;: &quot;2024-09-30&quot; }
    }
  }
}
</code></pre>
<h6 id="12-debugapplied_presetdiff">1.2 成功响应 - 完整版（含 debug/applied_preset/diff）</h6>
<pre><code class="language-json">{
  &quot;stock_info&quot;: {
    &quot;ts_code&quot;: &quot;601717.SH&quot;,
    &quot;name&quot;: &quot;郑煤机&quot;,
    &quot;market&quot;: &quot;主板&quot;,
    &quot;latest_annual_diluted_eps&quot;: 2.2120,
    &quot;base_report_date&quot;: &quot;2023-12-31&quot;,
    &quot;latest_price_as_of_date&quot;: &quot;2025-09-10&quot;,
    &quot;eps_annual_as_of_year&quot;: 2024,
    &quot;ttm_dps&quot;: 1.12,
    &quot;dividend_yield&quot;: 0.0516,
    &quot;ttm_dps_source&quot;: &quot;proposal&quot;,
    &quot;ttm_window_start&quot;: &quot;2024-09-10&quot;,
    &quot;ttm_window_end&quot;: &quot;2025-09-10&quot;
  },
  &quot;valuation_results&quot;: {
    &quot;latest_price&quot;: 21.71,
    &quot;current_pe&quot;: 9.23,
    &quot;current_pb&quot;: 1.48,
    &quot;dcf_forecast_details&quot;: {
      &quot;value_per_share&quot;: 26.86,
      &quot;wacc_used&quot;: 0.0609,
      &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
      &quot;exit_multiple_used&quot;: 8.0,
      &quot;implied_perpetual_growth_rate&quot;: 0.0045
    },
    &quot;detailed_forecast_table&quot;: [ { &quot;year&quot;: 1, &quot;revenue&quot;: 3.70e10, &quot;ufcf&quot;: 1.23e9 } ],
    &quot;data_warnings&quot;: [],
    &quot;debug_request_slice&quot;: {
      &quot;baseline_debug&quot;: {
        &quot;mode&quot;: &quot;LTM&quot;,
        &quot;curr_end_date&quot;: &quot;2025-06-30&quot;,
        &quot;curr_end_type&quot;: &quot;2&quot;,
        &quot;ytd_curr_total_revenue&quot;: 2.786e10,
        &quot;ytd_prev_total_revenue&quot;: 2.726e10,
        &quot;prev_annual_total_revenue&quot;: 3.642e10
      },
      &quot;applied_preset&quot;: {
        &quot;key&quot;: &quot;industrials&quot;,
        &quot;beta&quot;: { &quot;default&quot;: 1.0, &quot;range&quot;: [0.8, 1.3] },
        &quot;forecast_years&quot;: { &quot;default&quot;: 5, &quot;range&quot;: [4, 7] },
        &quot;pgr_cap&quot;: { &quot;default&quot;: 0.045, &quot;range&quot;: [0.03, 0.05] },
        &quot;exit_multiple_ev_ebitda&quot;: { &quot;default&quot;: 9.0, &quot;range&quot;: [6.0, 12.0] },
        &quot;turnover_days&quot;: {
          &quot;ar&quot;: { &quot;median&quot;: 60, &quot;range&quot;: [20, 120] },
          &quot;inv&quot;: { &quot;median&quot;: 80, &quot;range&quot;: [40, 180] },
          &quot;ap&quot;: { &quot;median&quot;: 55, &quot;range&quot;: [25, 110] }
        }
      },
      &quot;applied_preset_diff&quot;: {
        &quot;beta&quot;: { &quot;value&quot;: 1.0, &quot;default&quot;: 1.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
        &quot;forecast_years&quot;: { &quot;value&quot;: 5.0, &quot;default&quot;: 5.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
        &quot;pgr_cap&quot;: { &quot;value&quot;: 0.045, &quot;default&quot;: 0.045, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
        &quot;exit_multiple_ev_ebitda&quot;: { &quot;value&quot;: 9.0, &quot;default&quot;: 9.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
        &quot;turnover_days&quot;: {
          &quot;ar&quot;: { &quot;value&quot;: 60.0, &quot;default&quot;: 60.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
          &quot;inv&quot;: { &quot;value&quot;: 80.0, &quot;default&quot;: 80.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false },
          &quot;ap&quot;: { &quot;value&quot;: 55.0, &quot;default&quot;: 55.0, &quot;range_status&quot;: &quot;within&quot;, &quot;modified&quot;: false }
        }
      }
    }
  },
  &quot;error&quot;: null
}
</code></pre>
<h5 id="1x">1.x 三情景分析（乐观/基准/悲观）（提案）</h5>
<p>为补足“区间输出、关键驱动排序”的需求，建议在现有估值接口中引入可选字段 <code>scenarios</code>，由客户端提交三套参数调整，服务端按三套假设各自跑一遍估值，并给出汇总区间与驱动排序。</p>
<p>请求模型扩展（新增，可选）：</p>
<pre><code class="language-json">{
  &quot;ts_code&quot;: &quot;600519.SH&quot;,
  &quot;forecast_years&quot;: 5,
  &quot;terminal_value_method&quot;: &quot;exit_multiple&quot;,
  &quot;exit_multiple&quot;: 15,
  &quot;scenarios&quot;: {
    &quot;base&quot;: {
      &quot;label&quot;: &quot;基准&quot;,
      &quot;weight&quot;: 0.5,
      &quot;overrides&quot;: {},
      &quot;multipliers&quot;: {}
    },
    &quot;bull&quot;: {
      &quot;label&quot;: &quot;乐观&quot;,
      &quot;weight&quot;: 0.25,
      &quot;overrides&quot;: { &quot;wacc&quot;: 0.07, &quot;exit_multiple&quot;: 17 },
      &quot;multipliers&quot;: { &quot;target_operating_margin&quot;: 1.05, &quot;target_inventory_days&quot;: 0.9 }
    },
    &quot;bear&quot;: {
      &quot;label&quot;: &quot;悲观&quot;,
      &quot;weight&quot;: 0.25,
      &quot;overrides&quot;: { &quot;wacc&quot;: 0.10, &quot;exit_multiple&quot;: 13 },
      &quot;multipliers&quot;: { &quot;target_operating_margin&quot;: 0.95, &quot;target_inventory_days&quot;: 1.1 }
    }
  }
}
</code></pre>
<p>字段约定：
- <code>overrides</code>：按请求模型同名字段进行替换（如 <code>wacc</code>、<code>exit_multiple</code>、<code>perpetual_growth_rate</code>、<code>target_operating_margin</code>、<code>target_*_days</code> 等）。
- <code>multipliers</code>：按请求模型同名字段进行乘数调整（先乘后截断到有效区间，优先级低于 <code>overrides</code>）。
- <code>weight</code>：用于加权均值/分位的权重（可选，默认各 1/3）。</p>
<p>响应扩展（新增，可选）：</p>
<pre><code class="language-json">{
  &quot;valuation_results&quot;: {
    &quot;scenario_results&quot;: {
      &quot;base&quot;: {
        &quot;dcf_forecast_details&quot;: { &quot;value_per_share&quot;: 1675.5, &quot;wacc_used&quot;: 0.085 },
        &quot;ev_ebitda&quot;: 18.5
      },
      &quot;bull&quot;: {
        &quot;dcf_forecast_details&quot;: { &quot;value_per_share&quot;: 1850.2, &quot;wacc_used&quot;: 0.078 },
        &quot;ev_ebitda&quot;: 19.8
      },
      &quot;bear&quot;: {
        &quot;dcf_forecast_details&quot;: { &quot;value_per_share&quot;: 1498.3, &quot;wacc_used&quot;: 0.094 },
        &quot;ev_ebitda&quot;: 17.2
      },
      &quot;summary&quot;: {
        &quot;value_per_share&quot;: { &quot;min&quot;: 1498.3, &quot;p10&quot;: 1510.0, &quot;p50&quot;: 1675.5, &quot;p90&quot;: 1830.0, &quot;max&quot;: 1850.2, &quot;weighted_mean&quot;: 1674.9 },
        &quot;enterprise_value&quot;: { &quot;min&quot;: 1.76e12, &quot;p50&quot;: 2.10e12, &quot;max&quot;: 2.32e12 },
        &quot;key_drivers_ranking&quot;: [
          { &quot;name&quot;: &quot;wacc&quot;, &quot;contribution&quot;: 0.46 },
          { &quot;name&quot;: &quot;exit_multiple&quot;, &quot;contribution&quot;: 0.31 },
          { &quot;name&quot;: &quot;target_operating_margin&quot;, &quot;contribution&quot;: 0.15 },
          { &quot;name&quot;: &quot;nwc_days&quot;, &quot;contribution&quot;: 0.08 }
        ],
        &quot;note&quot;: &quot;排名基于基准点周边一因子弹性/方差贡献的近似分解（提案）。&quot;
      }
    }
  }
}
</code></pre>
<p>实现备注：
- 当前代码尚未返回 <code>scenario_results</code> 字段，此为接口提案；落地需在 <code>StockValuationRequest</code> 增加 <code>scenarios</code>，并在 <code>ValuationService</code> 逐情景重跑并汇总。
- <code>key_drivers_ranking</code> 可基于一因子扰动（OFAT）或 Sobol 近似（轻量）计算相对贡献，先实现 OFAT 版以保证性能与可解释性。
- UI 建议：
  - 情景面板：为“收入增速/利润率/NWC/WACC/终值参数”提供“覆盖/乘数”两种输入，支持权重；提供“重置为行业预设”的按钮。
  - 结果汇总：展示估值区间（条形/胡须图）、权重均值、与基准差异；绘制“关键驱动排序”（Tornado chart）。</p>
<h5 id="2-">2. 成功响应 - 包含敏感性分析</h5>
<pre><code class="language-json">{
    &quot;stock_info&quot;: {
        &quot;ts_code&quot;: &quot;600519.SH&quot;,
        &quot;name&quot;: &quot;贵州茅台&quot;,
        &quot;industry&quot;: &quot;白酒&quot;,
        &quot;market&quot;: &quot;A&quot;,
        &quot;latest_pe_ttm&quot;: 45.2,
        &quot;latest_pb_mrq&quot;: 12.8,
        &quot;total_shares&quot;: 1256197800,
        &quot;base_report_date&quot;: &quot;2024-09-30&quot;
    },
    &quot;valuation_results&quot;: {
        &quot;latest_price&quot;: 1725.0,
        &quot;current_pe&quot;: 45.2,
        &quot;current_pb&quot;: 12.8,
        &quot;dcf_forecast_details&quot;: {
            &quot;enterprise_value&quot;: 2150000000000,
            &quot;equity_value&quot;: 2100000000000,
            &quot;value_per_share&quot;: 1675.5,
            &quot;wacc_used&quot;: 0.085,
            &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
            &quot;exit_multiple_used&quot;: 15.2,
            &quot;forecast_period_years&quot;: 5,
            &quot;dcf_implied_diluted_pe&quot;: 33.97
        },
        &quot;sensitivity_analysis_result&quot;: {
            &quot;row_parameter&quot;: &quot;wacc&quot;,
            &quot;column_parameter&quot;: &quot;exit_multiple&quot;,
            &quot;row_values&quot;: [0.08, 0.09, 0.10, 0.11],
            &quot;column_values&quot;: [14, 16, 18, 20],
            &quot;result_tables&quot;: {
                &quot;value_per_share&quot;: [
                    [1850.5, 1675.5, 1520.3, 1380.2],
                    [1680.3, 1520.8, 1380.5, 1255.2],
                    [1535.2, 1388.6, 1260.4, 1148.3],
                    [1408.1, 1274.2, 1157.8, 1054.6]
                ],
                &quot;enterprise_value&quot;: [
                    [2325000000000, 2100000000000, 1900000000000, 1720000000000],
                    [2110000000000, 1910000000000, 1730000000000, 1570000000000],
                    [1925000000000, 1740000000000, 1580000000000, 1430000000000],
                    [1760000000000, 1590000000000, 1440000000000, 1310000000000]
                ],
                &quot;dcf_implied_pe&quot;: [
                    [37.5, 33.97, 30.8, 27.9],
                    [34.0, 30.8, 27.9, 25.3],
                    [31.1, 28.1, 25.5, 23.2],
                    [28.5, 25.8, 23.4, 21.3]
                ],
                &quot;tv_ev_ratio&quot;: [
                    [0.68, 0.65, 0.62, 0.60],
                    [0.70, 0.66, 0.63, 0.61],
                    [0.71, 0.67, 0.64, 0.62],
                    [0.72, 0.68, 0.65, 0.63]
                ],
                &quot;ev_ebitda&quot;: [
                    [18.9, 17.8, 16.7, 15.9],
                    [18.3, 17.2, 16.3, 15.5],
                    [17.7, 16.7, 15.8, 15.1],
                    [17.2, 16.2, 15.4, 14.8]
                ],
                &quot;ev_ebitda_terminal&quot;: [
                    [16.2, 15.1, 14.3, 13.7],
                    [15.7, 14.7, 13.9, 13.3],
                    [15.3, 14.3, 13.6, 13.0],
                    [14.9, 14.0, 13.3, 12.8]
                ],
                &quot;implied_pgr&quot;: [
                    [0.017, 0.013, 0.011, 0.009],
                    [0.019, 0.015, 0.012, 0.010],
                    [0.021, 0.017, 0.014, 0.011],
                    [0.022, 0.018, 0.015, 0.012]
                ]
            }
        },
        &quot;data_warnings&quot;: [],
        &quot;historical_financial_summary&quot;: [...],
        &quot;historical_ratios_summary&quot;: [...]
    },
    &quot;error&quot;: null
}
</code></pre>
<p>说明：
- 若列参数为 <code>perpetual_growth_rate</code> 且出现 <code>g ≥ WACC</code> 的行/列组合，该单元格返回 <code>null</code>；同时 <code>valuation_results.data_warnings</code> 会包含“组合被跳过”的提示，便于 UI 标注空白的合理性。
- <code>dcf_implied_pe</code> 的单元格数值优先取模型返回；缺失时以基准 EPS（最近年报）与该格每股价值计算回填。
- <code>ev_ebitda</code> 以 LTM 实际 EBITDA 为分母；<code>ev_ebitda_terminal</code> 以末期预测 EBITDA 为分母。两者口径不同，使用场景不同（LTM 便于与市场口径对标，Terminal 便于校验退出倍数假设）。</p>
<h5 id="3-llm">3. 成功响应 - 包含LLM分析</h5>
<pre><code class="language-json">{
    &quot;stock_info&quot;: {
        &quot;ts_code&quot;: &quot;600519.SH&quot;,
        &quot;name&quot;: &quot;贵州茅台&quot;,
        &quot;industry&quot;: &quot;白酒&quot;,
        &quot;market&quot;: &quot;A&quot;,
        &quot;latest_pe_ttm&quot;: 45.2,
        &quot;base_report_date&quot;: &quot;2024-09-30&quot;
    },
    &quot;valuation_results&quot;: {
        &quot;latest_price&quot;: 1725.0,
        &quot;current_pe&quot;: 45.2,
        &quot;dcf_forecast_details&quot;: {
            &quot;value_per_share&quot;: 1675.5,
            &quot;wacc_used&quot;: 0.085,
            &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
            &quot;exit_multiple_used&quot;: 15.2,
            &quot;dcf_implied_diluted_pe&quot;: 33.97
        },
        &quot;llm_analysis_summary&quot;: &quot;# 贵州茅台(600519.SH)投资分析报告\n\n## 估值摘要\n- **当前股价**: 1,725.0元\n- **DCF估值**: 1,675.5元\n- **估值差异**: -2.9% (略微低估)\n- **建议评级**: 持有\n\n## 投资亮点\n1. **品牌护城河**: 茅台拥有强大的品牌价值和定价权\n2. **财务表现**: 毛利率高达50%，ROE超过25%\n3. **增长稳定**: 收入和利润保持稳健增长\n4. **现金流**: 产生强劲的自由现金流\n\n## 风险因素\n1. **估值偏高**: 当前PE_TTM为45.2倍，高于历史平均\n2. **政策风险**: 白酒行业面临消费政策变化风险\n3. **竞争加剧**: 高端白酒市场竞争加剧\n\n## 投资建议\n基于DCF估值结果，当前股价略微高估，建议投资者等待更好的买入时机。长期来看，茅台依然是优质的核心资产。\n\n&gt; *分析基于DCF估值模型，存在模型假设风险，投资需谨慎。*&quot;,
        &quot;data_warnings&quot;: [
            &quot;LLM分析基于历史数据，未来表现可能存在差异&quot;
        ]
    },
    &quot;error&quot;: null
}
</code></pre>
<h5 id="4-">4. 错误响应 - 参数验证失败</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: [
        {
            &quot;loc&quot;: [&quot;body&quot;, &quot;forecast_years&quot;],
            &quot;msg&quot;: &quot;ensure this value is less than or equal to 20&quot;,
            &quot;type&quot;: &quot;value_error.number.not_le&quot;,
            &quot;ctx&quot;: {
                &quot;limit_value&quot;: 20
            }
        },
        {
            &quot;loc&quot;: [&quot;body&quot;, &quot;cagr_decay_rate&quot;],
            &quot;msg&quot;: &quot;ensure this value is less than or equal to 1&quot;,
            &quot;type&quot;: &quot;value_error.number.not_le&quot;,
            &quot;ctx&quot;: {
                &quot;limit_value&quot;: 1
            }
        }
    ]
}
</code></pre>
<h5 id="5-">5. 错误响应 - 股票数据未找到</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;无法获取股票基本信息: 999999.SH&quot;
}
</code></pre>
<h5 id="6-">6. 错误响应 - 业务逻辑错误</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;预测期年数必须在1-20之间&quot;
}
</code></pre>
<h5 id="7-">7. 错误响应 - 服务器内部错误</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;服务器内部错误: 计算WACC失败&quot;
}
</code></pre>
<h5 id="8-">8. 成功响应 - 金融行业特殊警告</h5>
<pre><code class="language-json">{
    &quot;stock_info&quot;: {
        &quot;ts_code&quot;: &quot;600036.SH&quot;,
        &quot;name&quot;: &quot;招商银行&quot;,
        &quot;industry&quot;: &quot;银行&quot;,
        &quot;market&quot;: &quot;A&quot;,
        &quot;latest_pe_ttm&quot;: 8.5,
        &quot;base_report_date&quot;: &quot;2024-09-30&quot;
    },
    &quot;valuation_results&quot;: {
        &quot;latest_price&quot;: 35.6,
        &quot;current_pe&quot;: 8.5,
        &quot;dcf_forecast_details&quot;: {
            &quot;value_per_share&quot;: 38.2,
            &quot;wacc_used&quot;: 0.075,
            &quot;terminal_value_method_used&quot;: &quot;perpetual_growth&quot;,
            &quot;perpetual_growth_rate_used&quot;: 0.03
        },
        &quot;special_industry_warning&quot;: &quot;⚠️ 金融行业警告：DCF模型对金融企业适用性有限。建议使用以下方法辅助估值：\n1. 股息折现模型(DDM)\n2. 市净率(P/B)相对估值\n3. 净资产收益率(ROE)分析\n4. 不良贷款率和拨备覆盖率分析\n\n当前DCF估值结果仅供参考，投资决策请结合专业金融分析。&quot;
    },
    &quot;error&quot;: null
}
</code></pre>
<h5 id="9-llm">9. 成功响应 - 批量处理（无LLM）</h5>
<pre><code class="language-json">{
    &quot;stock_info&quot;: {
        &quot;ts_code&quot;: &quot;600519.SH&quot;,
        &quot;name&quot;: &quot;贵州茅台&quot;,
        &quot;industry&quot;: &quot;白酒&quot;,
        &quot;market&quot;: &quot;A&quot;,
        &quot;latest_pe_ttm&quot;: 45.2,
        &quot;total_shares&quot;: 1256197800,
        &quot;base_report_date&quot;: &quot;2024-09-30&quot;
    },
    &quot;valuation_results&quot;: {
        &quot;latest_price&quot;: 1725.0,
        &quot;current_pe&quot;: 45.2,
        &quot;dcf_forecast_details&quot;: {
            &quot;enterprise_value&quot;: 2150000000000,
            &quot;equity_value&quot;: 2100000000000,
            &quot;value_per_share&quot;: 1675.5,
            &quot;wacc_used&quot;: 0.085,
            &quot;terminal_value_method_used&quot;: &quot;exit_multiple&quot;,
            &quot;exit_multiple_used&quot;: 15.2,
            &quot;forecast_period_years&quot;: 5,
            &quot;dcf_implied_diluted_pe&quot;: 33.97
        },
        &quot;llm_analysis_summary&quot;: null,
        &quot;data_warnings&quot;: [&quot;批量处理模式，已关闭LLM分析以提高性能&quot;],
        &quot;detailed_forecast_table&quot;: [...],
        &quot;historical_financial_summary&quot;: [...]
    },
    &quot;error&quot;: null
}
</code></pre>
<p><strong>业务逻辑流程</strong>:
1. <strong>数据获取阶段</strong>: 获取股票基本信息、价格、财务报表数据
2. <strong>数据处理阶段</strong>: 清洗数据、计算财务指标、生成历史比率
3. <strong>估值计算阶段</strong>: 
   - 初始化WACC计算器
   - 运行财务预测
   - 计算DCF估值
   - 计算终值
4. <strong>敏感性分析阶段</strong>: 多维度参数敏感性测试
5. <strong>LLM分析阶段</strong>: 调用大语言模型生成投资建议
6. <strong>结果整合阶段</strong>: 整合所有计算结果和警告信息</p>
<p><strong>状态码</strong>:
- <code>200</code>: 成功
- <code>400</code>: 请求参数错误
- <code>404</code>: 股票数据未找到
- <code>500</code>: 服务器内部错误</p>
<hr />
<h3 id="3_1">3. 数据更新接口</h3>
<h4 id="post-update_stock_basic">POST <code>/update_stock_basic</code></h4>
<p><strong>接口描述</strong>: 更新股票基本信息数据</p>
<p><strong>请求参数</strong>: 无</p>
<p><strong>请求体示例</strong>:</p>
<pre><code class="language-json">{}
</code></pre>
<p><strong>详细响应体示例</strong>:</p>
<h5 id="1-_1">1. 成功响应 - 正常更新</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;股票基本信息更新成功，共5,234条记录&quot;,
    &quot;count&quot;: 5234,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 5234,
        &quot;new_count&quot;: 156,
        &quot;execution_time&quot;: 45.2,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:30:00Z&quot;
    }
}
</code></pre>
<h5 id="2-_1">2. 成功响应 - 无新数据</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;股票基本信息已是最新，无需更新&quot;,
    &quot;count&quot;: 0,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 0,
        &quot;new_count&quot;: 0,
        &quot;execution_time&quot;: 5.1,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:30:00Z&quot;
    }
}
</code></pre>
<h5 id="3-">3. 成功响应 - 部分更新</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;partial_success&quot;,
    &quot;message&quot;: &quot;股票基本信息部分更新成功，共更新3,200条记录，1,500条记录失败&quot;,
    &quot;count&quot;: 3200,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 3200,
        &quot;failed_count&quot;: 1500,
        &quot;new_count&quot;: 89,
        &quot;execution_time&quot;: 38.7,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:30:00Z&quot;,
        &quot;errors&quot;: [
            &quot;API调用频率限制&quot;,
            &quot;部分股票代码格式错误&quot;
        ]
    }
}
</code></pre>
<h5 id="4-api">4. 错误响应 - API调用失败</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;error&quot;,
    &quot;message&quot;: &quot;更新失败：TuShare API调用失败&quot;,
    &quot;error&quot;: &quot;API connection timeout&quot;,
    &quot;details&quot;: {
        &quot;error_code&quot;: &quot;API_TIMEOUT&quot;,
        &quot;error_message&quot;: &quot;Connection to TuShare API timed out after 30 seconds&quot;,
        &quot;execution_time&quot;: 30.0,
        &quot;failed_count&quot;: 0
    }
}
</code></pre>
<h5 id="5-_1">5. 错误响应 - 数据库错误</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;error&quot;,
    &quot;message&quot;: &quot;更新失败：数据库连接错误&quot;,
    &quot;error&quot;: &quot;Database connection failed&quot;,
    &quot;details&quot;: {
        &quot;error_code&quot;: &quot;DB_CONNECTION_ERROR&quot;,
        &quot;error_message&quot;: &quot;Unable to connect to PostgreSQL database&quot;,
        &quot;execution_time&quot;: 0.5,
        &quot;failed_count&quot;: 0
    }
}
</code></pre>
<p><strong>业务逻辑</strong>:
1. 调用数据处理器更新股票基本信息
2. 强制从数据源获取最新数据
3. 更新数据库记录
4. 返回更新结果统计</p>
<p><strong>状态码</strong>:
- <code>200</code>: 更新成功
- <code>500</code>: 更新失败</p>
<hr />
<h4 id="post-update_daily_basic">POST <code>/update_daily_basic</code></h4>
<p><strong>接口描述</strong>: 更新每日行情指标数据</p>
<p><strong>请求参数</strong>: 无</p>
<p><strong>请求体示例</strong>:</p>
<pre><code class="language-json">{}
</code></pre>
<p><strong>详细响应体示例</strong>:</p>
<h5 id="1-_2">1. 成功响应 - 正常更新</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;每日行情指标更新成功，共4,856条记录&quot;,
    &quot;count&quot;: 4856,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 4856,
        &quot;new_count&quot;: 45,
        &quot;execution_time&quot;: 32.8,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:35:00Z&quot;,
        &quot;trade_date&quot;: &quot;2024-12-30&quot;
    }
}
</code></pre>
<h5 id="2-_2">2. 成功响应 - 市场休市</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;当前日期为周末或节假日，无需更新行情数据&quot;,
    &quot;count&quot;: 0,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 0,
        &quot;new_count&quot;: 0,
        &quot;execution_time&quot;: 2.1,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:35:00Z&quot;,
        &quot;trade_date&quot;: &quot;2024-12-29&quot;,
        &quot;note&quot;: &quot;周末休市&quot;
    }
}
</code></pre>
<h5 id="3-_1">3. 成功响应 - 部分更新</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;partial_success&quot;,
    &quot;message&quot;: &quot;每日行情指标部分更新成功，共更新4,000条记录，500条记录失败&quot;,
    &quot;count&quot;: 4000,
    &quot;details&quot;: {
        &quot;updated_count&quot;: 4000,
        &quot;failed_count&quot;: 500,
        &quot;new_count&quot;: 23,
        &quot;execution_time&quot;: 28.5,
        &quot;data_source&quot;: &quot;tushare&quot;,
        &quot;update_time&quot;: &quot;2024-12-31T10:35:00Z&quot;,
        &quot;trade_date&quot;: &quot;2024-12-30&quot;,
        &quot;errors&quot;: [
            &quot;部分股票停牌&quot;,
            &quot;API调用频率限制&quot;
        ]
    }
}
</code></pre>
<h5 id="4-_1">4. 错误响应 - 网络错误</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;error&quot;,
    &quot;message&quot;: &quot;更新失败：网络连接错误&quot;,
    &quot;error&quot;: &quot;Network connection failed&quot;,
    &quot;details&quot;: {
        &quot;error_code&quot;: &quot;NETWORK_ERROR&quot;,
        &quot;error_message&quot;: &quot;Unable to connect to TuShare API server&quot;,
        &quot;execution_time&quot;: 10.0,
        &quot;failed_count&quot;: 0
    }
}
</code></pre>
<h5 id="5-_2">5. 错误响应 - 数据格式错误</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;error&quot;,
    &quot;message&quot;: &quot;更新失败：数据格式错误&quot;,
    &quot;error&quot;: &quot;Data format error&quot;,
    &quot;details&quot;: {
        &quot;error_code&quot;: &quot;DATA_FORMAT_ERROR&quot;,
        &quot;error_message&quot;: &quot;Received data format does not match expected schema&quot;,
        &quot;execution_time&quot;: 15.2,
        &quot;failed_count&quot;: 0,
        &quot;sample_error&quot;: &quot;Field 'pe_ttm' is missing in some records&quot;
    }
}
</code></pre>
<p><strong>业务逻辑</strong>:
1. 调用数据处理器更新每日行情数据
2. 获取最新PE、PB、市值等指标
3. 更新数据库记录
4. 返回更新结果统计</p>
<p><strong>状态码</strong>:
- <code>200</code>: 更新成功
- <code>500</code>: 更新失败</p>
<hr />
<h3 id="4_1">4. 股票筛选接口</h3>
<h4 id="post-screen_stocks">POST <code>/screen_stocks</code></h4>
<p><strong>接口描述</strong>: 根据PE、PB、市值等条件筛选股票</p>
<p><strong>请求参数详解</strong>:
| 参数名 | 类型 | 必填 | 默认值 | 说明 | 约束条件 | 示例 |
|--------|------|------|--------|------|----------|------|
| <code>pe_min</code> | float | 否 | 无 | 最小市盈率 | &gt;=0 | 10, 15 |
| <code>pe_max</code> | float | 否 | 无 | 最大市盈率 | &gt;=pe_min | 30, 50 |
| <code>pb_min</code> | float | 否 | 无 | 最小市净率 | &gt;=0 | 1, 2 |
| <code>pb_max</code> | float | 否 | 无 | 最大市净率 | &gt;=pb_min | 5, 8 |
| <code>market_cap_min</code> | float | 否 | 无 | 最小市值(亿元) | &gt;=0 | 100, 200 |
| <code>market_cap_max</code> | float | 否 | 无 | 最大市值(亿元) | &gt;=market_cap_min | 1000, 2000 |</p>
<p><strong>详细请求体示例</strong>:</p>
<h5 id="1_2">1. 基础筛选请求</h5>
<pre><code class="language-json">{
    &quot;pe_min&quot;: 10,
    &quot;pe_max&quot;: 30,
    &quot;market_cap_min&quot;: 100
}
</code></pre>
<h5 id="2_2">2. 完整筛选条件</h5>
<pre><code class="language-json">{
    &quot;pe_min&quot;: 5,
    &quot;pe_max&quot;: 25,
    &quot;pb_min&quot;: 0.5,
    &quot;pb_max&quot;: 3,
    &quot;market_cap_min&quot;: 50,
    &quot;market_cap_max&quot;: 500
}
</code></pre>
<h5 id="3_2">3. 单一条件筛选</h5>
<pre><code class="language-json">{
    &quot;pe_max&quot;: 20
}
</code></pre>
<h5 id="4_2">4. 大盘股筛选</h5>
<pre><code class="language-json">{
    &quot;market_cap_min&quot;: 1000,
    &quot;pe_max&quot;: 25,
    &quot;pb_max&quot;: 5
}
</code></pre>
<h5 id="5_1">5. 小盘价值股筛选</h5>
<pre><code class="language-json">{
    &quot;market_cap_max&quot;: 200,
    &quot;pe_max&quot;: 15,
    &quot;pb_max&quot;: 2
}
</code></pre>
<h5 id="6_1">6. 边界值测试请求</h5>
<pre><code class="language-json">{
    &quot;pe_min&quot;: 0,
    &quot;pe_max&quot;: 9999,
    &quot;pb_min&quot;: 0,
    &quot;pb_max&quot;: 9999,
    &quot;market_cap_min&quot;: 0,
    &quot;market_cap_max&quot;: 999999
}
</code></pre>
<h5 id="7">7. 错误请求示例</h5>
<pre><code class="language-json">{
    &quot;pe_min&quot;: 30,  // 错误：pe_min &gt; pe_max
    &quot;pe_max&quot;: 10,
    &quot;pb_min&quot;: -5,  // 错误：负值
    &quot;market_cap_min&quot;: 5000,  // 错误：market_cap_min &gt; market_cap_max
    &quot;market_cap_max&quot;: 1000
}
</code></pre>
<p><strong>详细响应体示例</strong>:</p>
<h5 id="1-_3">1. 成功响应 - 基础筛选</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;筛选完成，共找到150只符合条件的股票&quot;,
    &quot;count&quot;: 150,
    &quot;data&quot;: [
        {
            &quot;ts_code&quot;: &quot;600519.SH&quot;,
            &quot;name&quot;: &quot;贵州茅台&quot;,
            &quot;industry&quot;: &quot;白酒&quot;,
            &quot;area&quot;: &quot;贵州&quot;,
            &quot;market&quot;: &quot;主板&quot;,
            &quot;list_date&quot;: &quot;2001-08-27&quot;,
            &quot;close&quot;: 1725.0,
            &quot;pe&quot;: 45.2,
            &quot;pb&quot;: 12.8,
            &quot;total_mv&quot;: 21500.0,
            &quot;float_mv&quot;: 21500.0,
            &quot;turnover_rate&quot;: 0.85,
            &quot;volume_ratio&quot;: 1.2,
            &quot;price_change&quot;: 2.5
        },
        {
            &quot;ts_code&quot;: &quot;000858.SZ&quot;,
            &quot;name&quot;: &quot;五粮液&quot;,
            &quot;industry&quot;: &quot;白酒&quot;,
            &quot;area&quot;: &quot;四川&quot;,
            &quot;market&quot;: &quot;主板&quot;,
            &quot;list_date&quot;: &quot;1998-04-27&quot;,
            &quot;close&quot;: 125.8,
            &quot;pe&quot;: 28.5,
            &quot;pb&quot;: 8.2,
            &quot;total_mv&quot;: 5150.0,
            &quot;float_mv&quot;: 5150.0,
            &quot;turnover_rate&quot;: 1.2,
            &quot;volume_ratio&quot;: 1.5,
            &quot;price_change&quot;: 1.8
        }
    ]
}
</code></pre>
<h5 id="2-_3">2. 成功响应 - 无结果</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;筛选完成，未找到符合条件的股票&quot;,
    &quot;count&quot;: 0,
    &quot;data&quot;: []
}
</code></pre>
<h5 id="3-_2">3. 成功响应 - 单一结果</h5>
<pre><code class="language-json">{
    &quot;status&quot;: &quot;success&quot;,
    &quot;message&quot;: &quot;筛选完成，共找到1只符合条件的股票&quot;,
    &quot;count&quot;: 1,
    &quot;data&quot;: [
        {
            &quot;ts_code&quot;: &quot;600519.SH&quot;,
            &quot;name&quot;: &quot;贵州茅台&quot;,
            &quot;industry&quot;: &quot;白酒&quot;,
            &quot;area&quot;: &quot;贵州&quot;,
            &quot;market&quot;: &quot;主板&quot;,
            &quot;list_date&quot;: &quot;2001-08-27&quot;,
            &quot;close&quot;: 1725.0,
            &quot;pe&quot;: 45.2,
            &quot;pb&quot;: 12.8,
            &quot;total_mv&quot;: 21500.0,
            &quot;float_mv&quot;: 21500.0,
            &quot;turnover_rate&quot;: 0.85,
            &quot;volume_ratio&quot;: 1.2,
            &quot;price_change&quot;: 2.5
        }
    ]
}
</code></pre>
<h5 id="4-_2">4. 错误响应 - 参数验证失败</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: [
        {
            &quot;loc&quot;: [&quot;body&quot;, &quot;pe_min&quot;],
            &quot;msg&quot;: &quot;ensure this value is greater than or equal to 0&quot;,
            &quot;type&quot;: &quot;value_error.number.not_ge&quot;,
            &quot;ctx&quot;: {
                &quot;limit_value&quot;: 0
            }
        },
        {
            &quot;loc&quot;: [&quot;body&quot;, &quot;market_cap_min&quot;],
            &quot;msg&quot;: &quot;ensure this value is less than or equal to market_cap_max&quot;,
            &quot;type&quot;: &quot;value_error.number.not_le&quot;,
            &quot;ctx&quot;: {
                &quot;limit_value&quot;: 1000
            }
        }
    ]
}
</code></pre>
<h5 id="5-_3">5. 错误响应 - 数据未找到</h5>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;无法获取股票数据，请先更新股票基本信息&quot;
}
</code></pre>
<p><strong>业务逻辑</strong>:
1. 获取合并后的股票数据
2. 应用筛选条件（PE、PB、市值范围）
3. 移除无效数据
4. 按市值降序排列
5. 返回筛选结果</p>
<p><strong>状态码</strong>:
- <code>200</code>: 筛选成功
- <code>404</code>: 数据未找到
- <code>500</code>: 筛选失败</p>
<hr />
<h2 id="_10">📋 参数约束条件总结表</h2>
<h3 id="_11">股票估值接口参数约束</h3>
<h4 id="_12">基础参数约束</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>约束条件</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ts_code</code></td>
<td>string</td>
<td>符合A股格式</td>
<td>6位数字+.SH/.SZ</td>
<td>"600519.SH"</td>
<td>"600519", "999999.SH"</td>
</tr>
<tr>
<td><code>market</code></td>
<td>string</td>
<td>枚举值</td>
<td>"A", "HK"</td>
<td>"A"</td>
<td>"US", "NASDAQ"</td>
</tr>
<tr>
<td><code>valuation_date</code></td>
<td>string</td>
<td>YYYY-MM-DD格式</td>
<td>有效的日期格式</td>
<td>"2024-12-31"</td>
<td>"2024/12/31", "invalid"</td>
</tr>
</tbody>
</table>
<h4 id="_13">数值范围约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>最小值</th>
<th>最大值</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>forecast_years</code></td>
<td>int</td>
<td>1</td>
<td>20</td>
<td>预测期年数</td>
<td>5, 10, 20</td>
<td>0, 25, -1</td>
</tr>
<tr>
<td><code>cagr_decay_rate</code></td>
<td>float</td>
<td>0</td>
<td>1</td>
<td>CAGR衰减率</td>
<td>0.1, 0.5, 0.99</td>
<td>-0.1, 1.5</td>
</tr>
<tr>
<td><code>target_operating_margin</code></td>
<td>float</td>
<td>0</td>
<td>1</td>
<td>目标营业利润率</td>
<td>0.25, 0.5</td>
<td>-0.1, 1.5</td>
</tr>
<tr>
<td><code>op_margin_transition_years</code></td>
<td>int</td>
<td>1</td>
<td>无限制</td>
<td>过渡年数</td>
<td>3, 5, 10</td>
<td>0, -1</td>
</tr>
<tr>
<td><code>target_debt_ratio</code></td>
<td>float</td>
<td>0</td>
<td>1</td>
<td>目标债务比例</td>
<td>0.3, 0.5</td>
<td>-0.1, 1.5</td>
</tr>
<tr>
<td><code>llm_temperature</code></td>
<td>float</td>
<td>0.0</td>
<td>2.0</td>
<td>LLM温度参数</td>
<td>0.0, 1.0, 2.0</td>
<td>-0.1, 2.1</td>
</tr>
<tr>
<td><code>llm_top_p</code></td>
<td>float</td>
<td>0.0</td>
<td>1.0</td>
<td>LLM Top-P参数</td>
<td>0.0, 0.5, 1.0</td>
<td>-0.1, 1.1</td>
</tr>
</tbody>
</table>
<h4 id="_14">非负约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>约束条件</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cost_of_debt</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>税前债务成本</td>
<td>0.05, 0.08</td>
<td>-0.01</td>
</tr>
<tr>
<td><code>risk_free_rate</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>无风险利率</td>
<td>0.03, 0.035</td>
<td>-0.01</td>
</tr>
<tr>
<td><code>market_risk_premium</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>市场风险溢价</td>
<td>0.05, 0.06</td>
<td>-0.01</td>
</tr>
<tr>
<td><code>exit_multiple</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>退出乘数</td>
<td>15.0, 18.0</td>
<td>-1.0</td>
</tr>
<tr>
<td><code>perpetual_growth_rate</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>永续增长率</td>
<td>0.03, 0.035</td>
<td>-0.01</td>
</tr>
<tr>
<td><code>llm_max_tokens</code></td>
<td>int</td>
<td>&gt;=1</td>
<td>最大Token数</td>
<td>1000, 4000</td>
<td>0, -100</td>
</tr>
</tbody>
</table>
<h4 id="_15">枚举值约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>可选值</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>op_margin_forecast_mode</code></td>
<td>string</td>
<td>"historical_median", "transition_to_target"</td>
<td>利润率预测模式</td>
<td>"historical_median"</td>
<td>"invalid_mode"</td>
</tr>
<tr>
<td><code>wacc_weight_mode</code></td>
<td>string</td>
<td>"target", "market"</td>
<td>WACC权重模式</td>
<td>"target"</td>
<td>"invalid_mode"</td>
</tr>
<tr>
<td><code>terminal_value_method</code></td>
<td>string</td>
<td>"exit_multiple", "perpetual_growth"</td>
<td>终值计算方法</td>
<td>"exit_multiple"</td>
<td>"invalid_method"</td>
</tr>
</tbody>
</table>
<h4 id="_16">条件约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>依赖条件</th>
<th>约束说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>target_operating_margin</code></td>
<td>float</td>
<td>op_margin_forecast_mode="transition_to_target"</td>
<td>必须提供目标利润率</td>
<td>0.30</td>
<td>null</td>
</tr>
<tr>
<td><code>op_margin_transition_years</code></td>
<td>int</td>
<td>op_margin_forecast_mode="transition_to_target"</td>
<td>必须提供过渡年数</td>
<td>5</td>
<td>null</td>
</tr>
<tr>
<td><code>exit_multiple</code></td>
<td>float</td>
<td>terminal_value_method="exit_multiple"</td>
<td>必须提供退出乘数</td>
<td>15.0</td>
<td>null</td>
</tr>
<tr>
<td><code>perpetual_growth_rate</code></td>
<td>float</td>
<td>terminal_value_method="perpetual_growth"</td>
<td>必须提供永续增长率</td>
<td>0.03</td>
<td>null</td>
</tr>
<tr>
<td><code>target_debt_ratio</code></td>
<td>float</td>
<td>wacc_weight_mode="target"</td>
<td>建议提供目标债务比例</td>
<td>0.35</td>
<td>null</td>
</tr>
</tbody>
</table>
<h3 id="_17">股票筛选接口参数约束</h3>
<h4 id="_18">相对约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>约束条件</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pe_max</code></td>
<td>float</td>
<td>&gt;=pe_min</td>
<td>最大市盈率</td>
<td>30 (当pe_min=10)</td>
<td>10 (当pe_min=30)</td>
</tr>
<tr>
<td><code>pb_max</code></td>
<td>float</td>
<td>&gt;=pb_min</td>
<td>最大市净率</td>
<td>5 (当pb_min=1)</td>
<td>1 (当pb_min=5)</td>
</tr>
<tr>
<td><code>market_cap_max</code></td>
<td>float</td>
<td>&gt;=market_cap_min</td>
<td>最大市值</td>
<td>1000 (当market_cap_min=100)</td>
<td>100 (当market_cap_min=1000)</td>
</tr>
</tbody>
</table>
<h4 id="_19">非负约束参数</h4>
<table>
<thead>
<tr>
<th>参数名</th>
<th>类型</th>
<th>约束条件</th>
<th>说明</th>
<th>有效示例</th>
<th>无效示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pe_min</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最小市盈率</td>
<td>10, 0</td>
<td>-5</td>
</tr>
<tr>
<td><code>pe_max</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最大市盈率</td>
<td>30, 9999</td>
<td>-10</td>
</tr>
<tr>
<td><code>pb_min</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最小市净率</td>
<td>1, 0</td>
<td>-2</td>
</tr>
<tr>
<td><code>pb_max</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最大市净率</td>
<td>5, 9999</td>
<td>-3</td>
</tr>
<tr>
<td><code>market_cap_min</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最小市值</td>
<td>100, 0</td>
<td>-50</td>
</tr>
<tr>
<td><code>market_cap_max</code></td>
<td>float</td>
<td>&gt;=0</td>
<td>最大市值</td>
<td>1000, 999999</td>
<td>-100</td>
</tr>
</tbody>
</table>
<h3 id="_20">参数验证错误码对照表</h3>
<table>
<thead>
<tr>
<th>错误类型</th>
<th>HTTP状态码</th>
<th>错误码示例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>参数缺失</td>
<td>400</td>
<td><code>field required</code></td>
<td>必填参数未提供</td>
</tr>
<tr>
<td>数值超出范围</td>
<td>400</td>
<td><code>ensure this value is less than or equal to 20</code></td>
<td>数值大于最大允许值</td>
</tr>
<tr>
<td>数值小于最小值</td>
<td>400</td>
<td><code>ensure this value is greater than or equal to 0</code></td>
<td>数值小于最小允许值</td>
</tr>
<tr>
<td>枚举值无效</td>
<td>400</td>
<td><code>value is not a valid enumeration member</code></td>
<td>提供的值不在枚举范围内</td>
</tr>
<tr>
<td>格式错误</td>
<td>400</td>
<td><code>invalid date format</code></td>
<td>日期格式不正确</td>
</tr>
<tr>
<td>相对约束违反</td>
<td>400</td>
<td><code>ensure this value is less than or equal to maximum</code></td>
<td>最大值小于最小值</td>
</tr>
<tr>
<td>条件约束违反</td>
<td>422</td>
<td><code>target_operating_margin is required when transition mode</code></td>
<td>条件满足时未提供必需参数</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_21">📊 数据模型</h2>
<h3 id="_22">请求模型详解</h3>
<h4 id="stockvaluationrequest">StockValuationRequest</h4>
<pre><code class="language-python">class StockValuationRequest(BaseModel):
    # 基础参数
    ts_code: str                                    # 股票代码
    market: Optional[str] = &quot;A&quot;                     # 市场标识
    valuation_date: Optional[str] = None           # 估值日期
    ltm_baseline_enabled: Optional[bool] = False    # 是否使用LTM/Interim基期

    # DCF假设参数
    forecast_years: int = 5                        # 预测年数
    cagr_decay_rate: Optional[float] = None        # CAGR衰减率
    op_margin_forecast_mode: str = &quot;historical_median&quot;  # 利润率预测模式

    # WACC参数
    wacc_weight_mode: str = &quot;target&quot;               # WACC权重模式
    target_debt_ratio: Optional[float] = None      # 目标债务比例
    risk_free_rate: Optional[float] = None         # 无风险利率
    beta: Optional[float] = None                   # 贝塔系数

    # 终值参数
    terminal_value_method: str = &quot;exit_multiple&quot;   # 终值计算方法
    exit_multiple: Optional[float] = None         # 退出乘数
    perpetual_growth_rate: Optional[float] = None  # 永续增长率

    # LLM参数
    request_llm_summary: bool = False              # LLM分析开关
    llm_provider: Optional[str] = None            # LLM提供商
    llm_temperature: Optional[float] = None       # 温度参数

    # 敏感性分析
    sensitivity_analysis: Optional[SensitivityAnalysisRequest] = None
</code></pre>
<h4 id="sensitivityanalysisrequest">SensitivityAnalysisRequest</h4>
<pre><code class="language-python">class SensitivityAnalysisRequest(BaseModel):
    row_axis: SensitivityAxisInput      # 行轴配置
    column_axis: SensitivityAxisInput   # 列轴配置

class SensitivityAxisInput(BaseModel):
    parameter_name: str                  # 参数名
    values: list[float]                 # 测试值列表
    step: Optional[float] = None        # 步长
    points: Optional[int] = None        # 点数
</code></pre>
<h3 id="_23">响应模型详解</h3>
<h4 id="stockvaluationresponse">StockValuationResponse</h4>
<pre><code class="language-python">class StockValuationResponse(BaseModel):
    stock_info: StockBasicInfoModel                    # 股票基本信息
    valuation_results: ValuationResultsContainer       # 估值结果容器
    error: Optional[str] = None                      # 错误信息
</code></pre>
<h4 id="valuationresultscontainer">ValuationResultsContainer</h4>
<pre><code class="language-python">class ValuationResultsContainer(BaseModel):
    latest_price: Optional[float]                      # 最新价格
    current_pe: Optional[float]                        # 当前PE
    current_pb: Optional[float]                        # 当前PB
    dcf_forecast_details: Optional[DcfForecastDetails] # DCF详情
    detailed_forecast_table: Optional[list[dict]]      # 预测表格
    sensitivity_analysis_result: Optional[SensitivityAnalysisResult]  # 敏感性分析
    llm_analysis_summary: Optional[str]               # LLM分析
    data_warnings: Optional[list[str]]                # 数据警告
    historical_financial_summary: Optional[list[dict]] # 历史财务摘要
    historical_ratios_summary: Optional[list[dict]]   # 历史比率摘要
    special_industry_warning: Optional[str]          # 行业警告
</code></pre>
<h4 id="dcfforecastdetails">DcfForecastDetails</h4>
<pre><code class="language-python">class DcfForecastDetails(BaseModel):
    enterprise_value: Optional[float]          # 企业价值
    equity_value: Optional[float]              # 股权价值
    value_per_share: Optional[float]           # 每股价值
    wacc_used: Optional[float]                 # 使用的WACC
    terminal_value: Optional[float]             # 终值
    dcf_implied_diluted_pe: Optional[float]    # DCF隐含PE
    base_ev_ebitda: Optional[float]            # EV/EBITDA
    implied_perpetual_growth_rate: Optional[float]  # 隐含永续增长率
    # ... 其他字段
</code></pre>
<hr />
<h2 id="_24">⚠️ 错误处理</h2>
<h3 id="_25">错误类型分类</h3>
<h4 id="1-400">1. 参数验证错误 (400)</h4>
<ul>
<li><strong>触发条件</strong>: 请求参数格式错误或缺失必需参数</li>
<li><strong>错误示例</strong>:</li>
</ul>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;field required (type=value_error.missing)&quot;
}
</code></pre>
<h4 id="2-404">2. 数据未找到错误 (404)</h4>
<ul>
<li><strong>触发条件</strong>: 股票代码不存在或数据不可用</li>
<li><strong>错误示例</strong>:</li>
</ul>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;无法获取股票基本信息: 999999.SH&quot;
}
</code></pre>
<h4 id="3-422">3. 业务逻辑错误 (422)</h4>
<ul>
<li><strong>触发条件</strong>: 参数值不符合业务规则</li>
<li><strong>错误示例</strong>:</li>
</ul>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;预测期年数必须在1-20之间&quot;
}
</code></pre>
<h4 id="4-500">4. 服务器内部错误 (500)</h4>
<ul>
<li><strong>触发条件</strong>: 计算过程异常、外部服务调用失败</li>
<li><strong>错误示例</strong>:</li>
</ul>
<pre><code class="language-json">{
    &quot;detail&quot;: &quot;服务器内部错误: 计算WACC失败&quot;
}
</code></pre>
<p>注意：
- <code>target_debt_ratio</code> 指 WACC 权重用的债务比例 D/(D+E)（市值口径），请勿与“资产负债率”（账面口径）混淆。
- 当启用 <code>ltm_baseline_enabled</code> 且缺少必要的上年同口径或上年年报导致 LTM 计算失败时，系统自动回退为“年报基期”，并在 <code>debug_request_slice.baseline_debug</code> 给出提示。</p>
<h3 id="_26">错误处理机制</h3>
<h4 id="1_3">1. 输入验证</h4>
<pre><code class="language-python"># Pydantic模型自动验证
class StockValuationRequest(BaseModel):
    forecast_years: int = Field(default=5, ge=1, le=20)
    # 自动验证范围约束
</code></pre>
<h4 id="2_3">2. 业务逻辑验证</h4>
<pre><code class="language-python"># 业务规则检查
if latest_price is None or latest_price &lt;= 0:
    raise HTTPException(
        status_code=404, 
        detail=f&quot;无法获取有效的最新价格: {request.ts_code}&quot;
    )
</code></pre>
<h4 id="3_3">3. 异常捕获和转换</h4>
<pre><code class="language-python">try:
    # 业务逻辑
    result = valuation_service.run_single_valuation(...)
except Exception as e:
    logger.error(f&quot;Unexpected error: {e}&quot;)
    raise HTTPException(status_code=500, detail=f&quot;服务器内部错误: {str(e)}&quot;)
</code></pre>
<h4 id="4_3">4. 警告信息处理</h4>
<pre><code class="language-python"># 非致命警告收集
all_warnings = base_data_warnings + base_run_warnings
data_warnings = list(set(all_warnings)) if all_warnings else None
</code></pre>
<h3 id="_27">数据验证规则</h3>
<h4 id="_28">数值范围验证</h4>
<ul>
<li><code>forecast_years</code>: 1-20年</li>
<li><code>target_operating_margin</code>: 0-1之间</li>
<li><code>llm_temperature</code>: 0.0-2.0之间</li>
<li><code>llm_top_p</code>: 0.0-1.0之间</li>
</ul>
<h4 id="_29">格式验证</h4>
<ul>
<li><code>ts_code</code>: 符合股票代码格式 (如 600519.SH)</li>
<li><code>valuation_date</code>: YYYY-MM-DD格式</li>
<li><code>wacc_weight_mode</code>: 枚举值 (target/market)</li>
</ul>
<h4 id="_30">业务规则验证</h4>
<ul>
<li>历史数据完整性检查</li>
<li>财务数据有效性验证</li>
<li>计算结果合理性验证</li>
</ul>
<hr />
<h2 id="_31">🚀 部署和测试</h2>
<h3 id="_32">环境要求</h3>
<ul>
<li>Python 3.8+</li>
<li>FastAPI 0.100+</li>
<li>uvicorn 0.20+</li>
<li>pandas 2.0+</li>
<li>pydantic 2.0+</li>
</ul>
<h3 id="_33">本地部署</h3>
<pre><code class="language-bash"># 安装依赖
pip install -e .

# 启动服务
uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8124

# 或使用项目脚本
python -m uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8124
</code></pre>
<h3 id="_34">生产部署</h3>
<pre><code class="language-bash"># 使用gunicorn启动
gunicorn src.api.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8124

# 使用docker
docker build -t stock-valuation-api .
docker run -p 8124:8124 stock-valuation-api
</code></pre>
<h3 id="api_1">API文档</h3>
<p>启动服务后访问：
- Swagger UI: http://localhost:8124/docs
- ReDoc: http://localhost:8124/redoc
- OpenAPI Schema: http://localhost:8124/openapi.json</p>
<h3 id="_35">测试脚本</h3>
<h4 id="1_4">1. 健康检查测试</h4>
<pre><code class="language-bash"># 基础健康检查
curl http://localhost:8124/

# 预期响应
# {&quot;message&quot;: &quot;Welcome to the Stock Valuation API (Streamlit Backend)&quot;}
</code></pre>
<h4 id="2_4">2. 股票估值测试</h4>
<h5 id="_36">基础估值测试</h5>
<pre><code class="language-bash">curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 5,
    &quot;request_llm_summary&quot;: false
  }'
</code></pre>
<h5 id="_37">完整参数估值测试</h5>
<pre><code class="language-bash">curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;market&quot;: &quot;A&quot;,
    &quot;valuation_date&quot;: &quot;2024-12-31&quot;,
    &quot;forecast_years&quot;: 10,
    &quot;cagr_decay_rate&quot;: 0.15,
    &quot;op_margin_forecast_mode&quot;: &quot;transition_to_target&quot;,
    &quot;target_operating_margin&quot;: 0.30,
    &quot;op_margin_transition_years&quot;: 5,
    &quot;wacc_weight_mode&quot;: &quot;target&quot;,
    &quot;target_debt_ratio&quot;: 0.35,
    &quot;cost_of_debt&quot;: 0.045,
    &quot;risk_free_rate&quot;: 0.03,
    &quot;beta&quot;: 1.1,
    &quot;market_risk_premium&quot;: 0.055,
    &quot;size_premium&quot;: 0.015,
    &quot;terminal_value_method&quot;: &quot;exit_multiple&quot;,
    &quot;exit_multiple&quot;: 16.5,
    &quot;request_llm_summary&quot;: true,
    &quot;llm_provider&quot;: &quot;deepseek&quot;,
    &quot;llm_model_id&quot;: &quot;deepseek-chat&quot;,
    &quot;llm_temperature&quot;: 0.8,
    &quot;llm_top_p&quot;: 0.9,
    &quot;llm_max_tokens&quot;: 3000
  }'
</code></pre>
<h5 id="_38">敏感性分析测试</h5>
<pre><code class="language-bash">curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 5,
    &quot;sensitivity_analysis&quot;: {
      &quot;row_axis&quot;: {
        &quot;parameter_name&quot;: &quot;wacc&quot;,
        &quot;values&quot;: [0.08, 0.09, 0.10, 0.11],
        &quot;step&quot;: 0.01,
        &quot;points&quot;: 4
      },
      &quot;column_axis&quot;: {
        &quot;parameter_name&quot;: &quot;exit_multiple&quot;,
        &quot;values&quot;: [14, 16, 18, 20],
        &quot;step&quot;: 2,
        &quot;points&quot;: 4
      }
    }
  }'
</code></pre>
<h5 id="_39">边界值测试</h5>
<pre><code class="language-bash"># 测试最小预测年数
curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 1
  }'

# 测试最大预测年数
curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 20
  }'

# 测试LLM参数边界值
curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 5,
    &quot;request_llm_summary&quot;: true,
    &quot;llm_temperature&quot;: 0.0,
    &quot;llm_top_p&quot;: 1.0,
    &quot;llm_max_tokens&quot;: 100
  }'
</code></pre>
<h5 id="_40">错误请求测试</h5>
<pre><code class="language-bash"># 测试无效股票代码
curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;999999.SH&quot;,
    &quot;forecast_years&quot;: 5
  }'

# 测试参数超出范围
curl -X POST &quot;http://localhost:8124/api/v1/valuation&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;ts_code&quot;: &quot;600519.SH&quot;,
    &quot;forecast_years&quot;: 25,
    &quot;cagr_decay_rate&quot;: 1.5,
    &quot;llm_temperature&quot;: 3.0
  }'
</code></pre>
<h4 id="3_4">3. 数据更新测试</h4>
<h5 id="_41">股票基本信息更新测试</h5>
<pre><code class="language-bash"># 基础更新
curl -X POST &quot;http://localhost:8124/update_stock_basic&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{}'

# 预期成功响应
# {
#   &quot;status&quot;: &quot;success&quot;,
#   &quot;message&quot;: &quot;股票基本信息更新成功，共5,234条记录&quot;,
#   &quot;count&quot;: 5234
# }
</code></pre>
<h5 id="_42">每日行情更新测试</h5>
<pre><code class="language-bash"># 更新每日行情
curl -X POST &quot;http://localhost:8124/update_daily_basic&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{}'

# 预期成功响应
# {
#   &quot;status&quot;: &quot;success&quot;,
#   &quot;message&quot;: &quot;每日行情指标更新成功，共4,856条记录&quot;,
#   &quot;count&quot;: 4856
# }
</code></pre>
<h4 id="4_4">4. 股票筛选测试</h4>
<h5 id="_43">基础筛选测试</h5>
<pre><code class="language-bash"># 低PE股票筛选
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;pe_min&quot;: 0,
    &quot;pe_max&quot;: 15,
    &quot;market_cap_min&quot;: 100
  }'

# 大盘蓝筹股筛选
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;market_cap_min&quot;: 1000,
    &quot;pe_max&quot;: 25,
    &quot;pb_max&quot;: 5
  }'

# 价值股筛选
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;pe_max&quot;: 15,
    &quot;pb_max&quot;: 2,
    &quot;market_cap_max&quot;: 500
  }'
</code></pre>
<h5 id="_44">边界值测试</h5>
<pre><code class="language-bash"># 测试极值筛选
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;pe_min&quot;: 0,
    &quot;pe_max&quot;: 9999,
    &quot;pb_min&quot;: 0,
    &quot;pb_max&quot;: 9999,
    &quot;market_cap_min&quot;: 0,
    &quot;market_cap_max&quot;: 999999
  }'

# 测试空筛选条件
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{}'
</code></pre>
<h5 id="_45">错误请求测试</h5>
<pre><code class="language-bash"># 测试无效参数组合
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;pe_min&quot;: 30,
    &quot;pe_max&quot;: 10,
    &quot;market_cap_min&quot;: 5000,
    &quot;market_cap_max&quot;: 1000
  }'

# 测试负值
curl -X POST &quot;http://localhost:8124/screen_stocks&quot; \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
    &quot;pe_min&quot;: -5,
    &quot;pb_min&quot;: -1
  }'
</code></pre>
<h3 id="_46">性能测试</h3>
<h4 id="_47">并发测试</h4>
<pre><code class="language-bash"># 使用ab测试
ab -n 100 -c 10 -p test_request.json -T application/json http://localhost:8124/api/v1/valuation

# 使用wrk测试
wrk -t12 -c400 -d30s -s post.lua http://localhost:8124/api/v1/valuation
</code></pre>
<h4 id="_48">响应时间监控</h4>
<ul>
<li>单次估值请求: 3-10秒 (取决于LLM调用)</li>
<li>数据更新请求: 10-60秒</li>
<li>股票筛选请求: 1-3秒</li>
</ul>
<hr />
<h2 id="_49">💡 使用示例</h2>
<h3 id="python">Python客户端示例</h3>
<pre><code class="language-python">import requests
import json

# API配置
API_BASE_URL = &quot;http://localhost:8124&quot;

def calculate_stock_valuation(ts_code, forecast_years=5, request_llm=True):
    &quot;&quot;&quot;计算股票估值&quot;&quot;&quot;

    # 构建请求参数
    request_data = {
        &quot;ts_code&quot;: ts_code,
        &quot;forecast_years&quot;: forecast_years,
        &quot;request_llm_summary&quot;: request_llm,
        &quot;terminal_value_method&quot;: &quot;exit_multiple&quot;,
        &quot;wacc_weight_mode&quot;: &quot;target&quot;,
        # 可选：自定义WACC参数
        &quot;risk_free_rate&quot;: 0.03,
        &quot;market_risk_premium&quot;: 0.05,
        &quot;beta&quot;: 1.0
    }

    try:
        # 发送请求
        response = requests.post(
            f&quot;{API_BASE_URL}/api/v1/valuation&quot;,
            headers={&quot;Content-Type&quot;: &quot;application/json&quot;},
            json=request_data,
            timeout=60  # 60秒超时
        )

        response.raise_for_status()
        result = response.json()

        # 解析结果
        stock_info = result[&quot;stock_info&quot;]
        valuation = result[&quot;valuation_results&quot;]
        dcf_details = valuation[&quot;dcf_forecast_details&quot;]

        print(f&quot;股票: {stock_info['name']} ({stock_info['ts_code']})&quot;)
        print(f&quot;当前价格: {valuation['latest_price']:.2f}&quot;)
        print(f&quot;DCF估值: {dcf_details['value_per_share']:.2f}&quot;)
        print(f&quot;估值差异: {((dcf_details['value_per_share'] / valuation['latest_price'] - 1) * 100):.1f}%&quot;)

        if valuation[&quot;llm_analysis_summary&quot;]:
            print(&quot;\n=== LLM分析 ===&quot;)
            print(valuation[&quot;llm_analysis_summary&quot;])

        return result

    except requests.exceptions.RequestException as e:
        print(f&quot;请求失败: {e}&quot;)
        return None

def screen_stocks(pe_min=None, pe_max=None, market_cap_min=None):
    &quot;&quot;&quot;筛选股票&quot;&quot;&quot;

    request_data = {}
    if pe_min is not None:
        request_data[&quot;pe_min&quot;] = pe_min
    if pe_max is not None:
        request_data[&quot;pe_max&quot;] = pe_max
    if market_cap_min is not None:
        request_data[&quot;market_cap_min&quot;] = market_cap_min

    try:
        response = requests.post(
            f&quot;{API_BASE_URL}/screen_stocks&quot;,
            headers={&quot;Content-Type&quot;: &quot;application/json&quot;},
            json=request_data
        )

        response.raise_for_status()
        result = response.json()

        print(f&quot;找到 {result['count']} 只符合条件的股票:&quot;)
        for stock in result[&quot;data&quot;][:10]:  # 显示前10只
            print(f&quot;{stock['name']} ({stock['ts_code']}): PE={stock['pe']:.1f}, 市值={stock['total_mv']:.0f}亿&quot;)

        return result

    except requests.exceptions.RequestException as e:
        print(f&quot;筛选失败: {e}&quot;)
        return None

# 使用示例
if __name__ == &quot;__main__&quot;:
    # 计算贵州茅台估值
    result = calculate_stock_valuation(&quot;600519.SH&quot;, forecast_years=5)

    # 筛选低PE股票
    screen_stocks(pe_min=0, pe_max=20, market_cap_min=100)
</code></pre>
<h3 id="javascript">JavaScript客户端示例</h3>
<pre><code class="language-javascript">// API配置
const API_BASE_URL = 'http://localhost:8124';

// 计算股票估值
async function calculateStockValuation(tsCode, options = {}) {
    const requestData = {
        ts_code: tsCode,
        forecast_years: options.forecastYears || 5,
        request_llm_summary: options.requestLLM || false,
        ...options
    };

    try {
        const response = await fetch(`${API_BASE_URL}/api/v1/valuation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        console.log(`股票: ${result.stock_info.name} (${result.stock_info.ts_code})`);
        console.log(`当前价格: ${result.valuation_results.latest_price}`);
        console.log(`DCF估值: ${result.valuation_results.dcf_forecast_details.value_per_share}`);

        return result;

    } catch (error) {
        console.error('请求失败:', error);
        throw error;
    }
}

// 股票筛选
async function screenStocks(filters = {}) {
    const requestData = {};

    if (filters.peMin !== undefined) requestData.pe_min = filters.peMin;
    if (filters.peMax !== undefined) requestData.pe_max = filters.peMax;
    if (filters.marketCapMin !== undefined) requestData.market_cap_min = filters.marketCapMin;

    try {
        const response = await fetch(`${API_BASE_URL}/screen_stocks`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log(`找到 ${result.count} 只符合条件的股票`);

        return result;

    } catch (error) {
        console.error('筛选失败:', error);
        throw error;
    }
}

// 使用示例
(async () =&gt; {
    try {
        // 计算估值
        const valuation = await calculateStockValuation('600519.SH', {
            forecastYears: 5,
            requestLLM: true
        });

        // 筛选股票
        const screened = await screenStocks({
            peMin: 0,
            peMax: 20,
            marketCapMin: 100
        });

    } catch (error) {
        console.error('API调用失败:', error);
    }
})();
</code></pre>
<h3 id="_50">批量处理示例</h3>
<pre><code class="language-python">import asyncio
import aiohttp
import json

async def batch_valuation(session, stock_codes):
    &quot;&quot;&quot;批量计算股票估值&quot;&quot;&quot;

    tasks = []
    for ts_code in stock_codes:
        task = calculate_single_valuation(session, ts_code)
        tasks.append(task)

    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results

async def calculate_single_valuation(session, ts_code):
    &quot;&quot;&quot;单只股票估值&quot;&quot;&quot;

    request_data = {
        &quot;ts_code&quot;: ts_code,
        &quot;forecast_years&quot;: 5,
        &quot;request_llm_summary&quot;: False  # 批量时关闭LLM以提高速度
    }

    try:
        async with session.post(
            f&quot;{API_BASE_URL}/api/v1/valuation&quot;,
            json=request_data,
            timeout=aiohttp.ClientTimeout(total=30)
        ) as response:
            result = await response.json()
            return {
                &quot;ts_code&quot;: ts_code,
                &quot;success&quot;: True,
                &quot;data&quot;: result
            }
    except Exception as e:
        return {
            &quot;ts_code&quot;: ts_code,
            &quot;success&quot;: False,
            &quot;error&quot;: str(e)
        }

# 使用示例
async def main():
    stock_codes = [&quot;600519.SH&quot;, &quot;000858.SZ&quot;, &quot;600036.SH&quot;]

    async with aiohttp.ClientSession() as session:
        results = await batch_valuation(session, stock_codes)

        for result in results:
            if result[&quot;success&quot;]:
                stock_info = result[&quot;data&quot;][&quot;stock_info&quot;]
                dcf_details = result[&quot;data&quot;][&quot;valuation_results&quot;][&quot;dcf_forecast_details&quot;]
                print(f&quot;{stock_info['name']}: {dcf_details['value_per_share']:.2f}&quot;)
            else:
                print(f&quot;{result['ts_code']}: 失败 - {result['error']}&quot;)

if __name__ == &quot;__main__&quot;:
    asyncio.run(main())
</code></pre>
<hr />
<h2 id="_51">📝 最佳实践</h2>
<h3 id="1_5">1. 请求优化</h3>
<ul>
<li><strong>批量处理</strong>: 使用异步请求批量处理多只股票</li>
<li><strong>缓存策略</strong>: 对相同参数的估值结果进行缓存</li>
<li><strong>超时设置</strong>: 根据网络环境合理设置超时时间</li>
<li><strong>重试机制</strong>: 对临时性错误实现指数退避重试</li>
</ul>
<h3 id="2_5">2. 错误处理</h3>
<ul>
<li><strong>参数验证</strong>: 在发送请求前验证参数格式</li>
<li><strong>状态码检查</strong>: 检查HTTP状态码和业务错误码</li>
<li><strong>异常捕获</strong>: 捕获网络异常和解析异常</li>
<li><strong>日志记录</strong>: 记录请求和响应信息用于调试</li>
</ul>
<h3 id="3_5">3. 性能优化</h3>
<ul>
<li><strong>并发控制</strong>: 合理控制并发请求数量</li>
<li><strong>LLM调用</strong>: 批量处理时关闭LLM分析以提高速度</li>
<li><strong>数据分页</strong>: 对大量结果进行分页处理</li>
<li><strong>连接池</strong>: 使用HTTP连接池减少连接开销</li>
</ul>
<h3 id="4_5">4. 安全考虑</h3>
<ul>
<li><strong>HTTPS</strong>: 生产环境使用HTTPS协议</li>
<li><strong>认证授权</strong>: 实现API密钥或OAuth认证</li>
<li><strong>限流控制</strong>: 实现请求频率限制</li>
<li><strong>输入验证</strong>: 严格验证所有输入参数</li>
</ul>
<hr />
<h2 id="_52">🔧 故障排除</h2>
<h3 id="_53">常见问题</h3>
<h4 id="1_6">1. 连接超时</h4>
<p><strong>问题</strong>: 请求超时失败
<strong>解决</strong>: 
- 增加超时时间到60秒
- 检查网络连接
- 验证服务是否正常运行</p>
<h4 id="2_6">2. 数据未找到</h4>
<p><strong>问题</strong>: 返回404错误
<strong>解决</strong>:
- 验证股票代码格式
- 检查数据是否已更新
- 确认股票是否存在</p>
<h4 id="3_6">3. 计算失败</h4>
<p><strong>问题</strong>: 返回500错误
<strong>解决</strong>:
- 检查请求参数是否合理
- 查看服务器日志
- 验证财务数据完整性</p>
<h4 id="4-llm">4. LLM调用失败</h4>
<p><strong>问题</strong>: LLM分析返回错误
<strong>解决</strong>:
- 检查LLM服务配置
- 验证API密钥和网络连接
- 尝试使用不同的LLM提供商</p>
<h3 id="_54">调试技巧</h3>
<h4 id="1_7">1. 启用详细日志</h4>
<pre><code class="language-bash"># 设置日志级别为DEBUG
export LOG_LEVEL=DEBUG
uvicorn src.api.main:app --reload
</code></pre>
<h4 id="2-swagger-ui">2. 使用Swagger UI</h4>
<p>访问 http://localhost:8124/docs 进行交互式测试</p>
<h4 id="3_7">3. 检查请求/响应</h4>
<pre><code class="language-python">import logging

# 启用请求日志
logging.basicConfig(level=logging.DEBUG)
</code></pre>
<h4 id="4_6">4. 验证数据格式</h4>
<pre><code class="language-python"># 使用Pydantic验证数据
from pydantic import ValidationError

try:
    request = StockValuationRequest(**data)
except ValidationError as e:
    print(f&quot;验证错误: {e}&quot;)
</code></pre>
<hr />
<h2 id="_55">📊 监控和运维</h2>
<h3 id="_56">关键指标</h3>
<ul>
<li><strong>响应时间</strong>: 单次请求处理时间</li>
<li><strong>错误率</strong>: HTTP错误码分布</li>
<li><strong>并发数</strong>: 同时处理的请求数</li>
<li><strong>内存使用</strong>: 服务内存占用</li>
<li><strong>CPU使用</strong>: 服务CPU占用率</li>
</ul>
<h3 id="_57">日志监控</h3>
<pre><code class="language-python"># 关键日志模式
INFO - Received valuation request for: 600519.SH
INFO - Step 1: Fetching data...
INFO - Step 2: Processing data...
INFO - Base case valuation successful.
ERROR - Error during LLM call: API timeout
</code></pre>
<h3 id="_58">健康检查</h3>
<pre><code class="language-bash"># 基础健康检查
curl http://localhost:8124/

# 详细健康检查
curl http://localhost:8124/health
</code></pre>
<h3 id="_59">性能优化建议</h3>
<ol>
<li><strong>数据库优化</strong>: 添加适当的索引</li>
<li><strong>缓存策略</strong>: 实现Redis缓存</li>
<li><strong>异步处理</strong>: 使用异步I/O提高并发</li>
<li><strong>负载均衡</strong>: 部署多实例分担负载</li>
</ol>
<hr />
<h2 id="_60">📅 最新更新记录</h2>
<h3 id="v300-2025-09-22">v3.0.0 (2025-09-22)</h3>
<p><strong>重大功能更新</strong>:
- ✅ <strong>TuShare数据源</strong>: 完全集成TuShare API，支持数据源热切换
- ✅ <strong>LTM基线功能</strong>: 新增Last Twelve Months收入基期支持
- ✅ <strong>数据清洗优化</strong>: 修复资产负债表基准日回退问题，保护关键科目
- ✅ <strong>敏感性分析增强</strong>: 新增EV/EBITDA倍数、隐含PE/PGR等指标
- ✅ <strong>生产级部署</strong>: 完整的错误处理、兜底机制和监控能力</p>
<p><strong>API接口更新</strong>:
- 新增 <code>ltm_baseline_enabled</code> 参数启用LTM基线
- 增强估值响应字段，包含更多诊断信息
- 优化错误处理和用户友好的错误消息</p>
<p><strong>数据质量提升</strong>:
- TuShare与PostgreSQL数据源端到端验证完成
- 关键估值指标(EV/VPS/CAGR/EBITDA)对齐确认
- 按年择优数据选择策略，确保使用最新年报</p>
<p><strong>性能优化</strong>:
- 数据获取链路优化，减少API调用次数
- Decimal精度计算，避免浮点误差
- 异步处理支持，提高并发处理能力</p>
<h3 id="v2xx-2025-09">v2.x.x (2025-09之前)</h3>
<p><strong>历史功能</strong>:
- 基础DCF估值计算
- PostgreSQL数据源集成
- Streamlit前端
- 基础敏感性分析
- 股票筛选器</p>
<h3 id="v310">下一版本计划 (v3.1.0)</h3>
<p><strong>计划功能</strong>:
- 性能缓存机制
- 批量估值API
- 更多行业模型支持
- 实时数据流处理</p>
<hr />
<p>这份API文档提供了完整的技术规格和使用指南，方便其他项目进行对接和测试。项目已达到生产级标准，具备完整的估值分析能力。如有任何问题，请参考故障排除部分或联系技术支持。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
