<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>DCF 核心业务逻辑优化方案（v1） - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">01 project overview</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../01_project_overview/" class="dropdown-item">项目概览文档</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_analysis_report/" class="dropdown-item">股票估值系统项目分析报告</a>
</li>
                                    
<li>
    <a href="../../01_project_overview/project_status_2025_09_latest/" class="dropdown-item">股票估值系统项目状态报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">02 architecture</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../02_architecture/" class="dropdown-item">架构设计文档</a>
</li>
                                    
<li>
    <a href="../../02_architecture/dcf_architecture/" class="dropdown-item">DCF 核心业务逻辑与架构</a>
</li>
                                    
<li>
    <a href="../../02_architecture/hybrid_architecture_design/" class="dropdown-item">股票估值系统混合架构设计文档</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">03 development</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../03_development/" class="dropdown-item">开发文档</a>
</li>
                                    
<li>
    <a href="../../03_development/development_guide_2025_09/" class="dropdown-item">股票估值系统开发指南</a>
</li>
                                    
<li>
    <a href="../../03_development/testing_strategy_2025_09/" class="dropdown-item">测试策略与质量保障指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">04 deployment</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../04_deployment/" class="dropdown-item">部署运维文档</a>
</li>
                                    
<li>
    <a href="../../04_deployment/deployment_operations_guide_2025_09/" class="dropdown-item">部署运维指南</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">05 data sources</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../05_data_sources/" class="dropdown-item">数据源专题文档</a>
</li>
                                    
<li>
    <a href="../../05_data_sources/tushare_alignment/" class="dropdown-item">TuShare数据源对齐与生产部署报告</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Archived</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">归档文档</a>
</li>
                                    
<li>
    <a href="../Stock_investment_decision_making_process/" class="dropdown-item">Stock investment decision making process</a>
</li>
                                    
<li>
    <a href="../api_backend_comprehensive_analysis/" class="dropdown-item">Stock Valuation API 后端接口详细分析文档</a>
</li>
                                    
<li>
    <a href="../dcf_industry_standards_comprehensive_analysis/" class="dropdown-item">DCF估值项目与行业标准深度对比分析报告</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">DCF 核心业务逻辑优化方案（v1）</a>
</li>
                                    
<li>
    <a href="../dcf_rolling_revaluation_guide/" class="dropdown-item">DCF 滚动重评实践指南（季度/中报更新版）</a>
</li>
                                    
<li>
    <a href="../directory_optimization_plan/" class="dropdown-item">项目目录结构优化方案</a>
</li>
                                    
<li>
    <a href="../mckinsey_financial_ratios_and_forecasting_analysis/" class="dropdown-item">Stock Vale Valuation 3.0 财务比率与预测逻辑 McKinsey 标准合规性专题分析报告</a>
</li>
                                    
<li>
    <a href="../mckinsey_standards_compliance_report/" class="dropdown-item">Stock Vale Valuation 3.0 项目 McKinsey 标准合规性分析报告</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../dcf_industry_standards_comprehensive_analysis/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../dcf_rolling_revaluation_guide/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#dcf-v1" class="nav-link">DCF 核心业务逻辑优化方案（v1）</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">目标与范围</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">核心优化（高优先级）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_3" class="nav-link">预测增强（中优先级）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_4" class="nav-link">透明度与可审计</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_5" class="nav-link">敏感性与情景</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_6" class="nav-link">数据质量治理</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_7" class="nav-link">测试与基准</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#streamlit" class="nav-link">Streamlit 体验</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2025-09-10" class="nav-link">实施路线图（2025-09-10）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_8" class="nav-link">代码参考</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_9" class="nav-link">配置与字段（节选）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_10" class="nav-link">验收标准（关键）</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="dcf-v1">DCF 核心业务逻辑优化方案（v1）</h1>
<h2 id="_1">目标与范围</h2>
<ul>
<li>目标：将模型从“参数可调的标准 DCF”升级为“带行业校准、宏观约束、口径统一、可审计”的企业级 DCF。</li>
<li>范围：折现时点、WACC 结构、终值治理、利润与成本路径、营运资本口径、透明度与审计、敏感性与情景、数据质量、测试与 UX。</li>
</ul>
<h2 id="_2">核心优化（高优先级）</h2>
<ul>
<li>折现时点（Mid-Year Convention）</li>
<li>默认支持年中折现，结果页标注折现惯例。</li>
<li>已落地：<code>PresentValueCalculator(mid_year_convention)</code>；Streamlit 复选项：<code>mid_year_convention</code>。</li>
<li>WACC/Ke 结构（CRP / IRP）</li>
<li>Ke = Rf + β×(MRP + CRP) + Size + IRP；Rf/β/MRP 支持 UI 覆盖与 ENV。</li>
<li>已落地：<code>COUNTRY_RISK_PREMIUM</code>、<code>INDUSTRY_RISK_PREMIUM</code>（ENV+API+UI）。</li>
<li>终值治理（TV）</li>
<li>永续增长法：以“名义 GDP（通胀+实际）”为上限校验（min(PGR, GDP_cap)），超限给出来源与被更正值（已落地：ENV/请求控制）。</li>
<li>退出乘数法：提供行业区间参考与偏离警示；同步展示隐含 PGR 与 EV/EBITDA（已落地：隐含 PGR 计算与提示）。</li>
<li>利润率与 COGS 双模式</li>
<li>反推法（默认）：Revenue − EBIT − SGA − RD，保持损益恒等式，匹配目标利润率/费用率。</li>
<li>直接比率法（可选）：COGS = Revenue × 历史 COGS/Revenue 中位数，适用于跟踪毛利趋势。</li>
<li>已落地：<code>cogs_forecast_mode = residual|direct_ratio</code>（API+UI）。</li>
<li>营运资本（NWC）与 ΔNWC 基期</li>
<li>“纯历史中位数”场景：DIO/DPO 用损益口径的 COGS；“目标/过渡”场景用历史 COGS 比率，降低扭曲。</li>
<li>统一并兼容 ΔNWC 基期键名：<code>last_historical_nwc/last_actual_nwc</code>。</li>
<li>结果页固定展示首年 ΔNWC 构成（AR/Inv/AP/OCA/OCL）及基期。</li>
<li>LTM/Interim 基期（新增）：支持 <code>ltm_baseline_enabled</code>（默认关闭）以 LTM 口径确定 <code>last_actual_revenue</code>；估值日滚动最新资产负债表并重算 <code>last_component_nwc</code>（已落地）。</li>
<li>税率与 NOPAT</li>
<li>有效税率从历史中位数过渡到目标，设合理上下限（如 5%–35%），越界告警。</li>
<li>Capex 与 D&amp;A 联动</li>
<li>维持性投资约束（Capex ≥ D&amp;A）+ 收入驱动的扩张项，长期趋于稳态（后续落地）。</li>
<li>股权桥口径</li>
<li>Net Debt = 有息负债 − 现金等价物；在桥接中扣除少数股东权益与优先股；UI 标注口径。</li>
</ul>
<h2 id="_3">预测增强（中优先级）</h2>
<ul>
<li>收入路径：历史 CAGR ×（名义 GDP/行业基准）×（份额因子），并提供“行业预设”快捷项。</li>
<li>利润率路径：线性→逻辑/指数平滑可选；自动夹持在历史/行业上下限。</li>
<li>行业标尺库：β、预测期、PGR 上限、EV/EBITDA 参考、DSO/DIO/DPO 典型值。</li>
</ul>
<h2 id="_4">透明度与可审计</h2>
<ul>
<li>关键假设摘要卡片（常驻）：</li>
<li>WACC 构成（Rf/β/MRP/CRP/IRP/权重/Ke/Kd(AT)）</li>
<li>TV 方法与参数、隐含 PGR 与 EV/EBITDA</li>
<li>收入/利润率/COGS 模式与路径、首年 ΔNWC 构成、净债务口径</li>
<li>审计导出：请求载荷、映射后假设、历史中位数、逐年预测表、DCF 分解（JSON/CSV）。</li>
<li>基期调试：在 <code>debug_request_slice</code> 中注入 <code>baseline_debug</code>（Annual/LTM 模式、YTD/LTM 构成），使滚动重评可追溯。</li>
</ul>
<h2 id="_5">敏感性与情景</h2>
<ul>
<li>二维敏感性保持；新增轻量蒙特卡洛（1000 次）：输出估值分布、置信区间、关键驱动排序。</li>
<li>三情景（悲观/基准/乐观）联动调整增长/利润率/WACC/PGR，并合并展示区间与驱动。</li>
</ul>
<h2 id="_6">数据质量治理</h2>
<ul>
<li>指标覆盖率、异常值计数、时效性标识（可视化评分）；跨源一致性与基准校验。</li>
<li>口径一致性检查：损益恒等式、周转基底一致性、ΔNWC 基期有效性—触发提示与修正建议。</li>
</ul>
<h2 id="_7">测试与基准</h2>
<ul>
<li>单元测试：</li>
<li>mid_year_convention、CRP/IRP 对 Ke/WACC 影响</li>
<li><code>cogs_forecast_mode</code> 两模式边界与一致性</li>
<li>ΔNWC 基期键名与首年 ΔNWC 合理性</li>
<li>TV 上限校验（名义 GDP）与隐含指标</li>
<li>回归样例：建立锚定股票（不同行业）目标区间，防止模型漂移。</li>
</ul>
<h2 id="streamlit">Streamlit 体验</h2>
<ul>
<li>行业模板：一键加载“预测期/增长/PGR/WACC/周转/乘数区间”，并展示行业警示。</li>
<li>解释力：价值驱动分解图（增长、利润率、WACC、PGR、ΔNWC、Capex/D&amp;A 贡献）。</li>
<li>NWC 控件：新增“营运资本基准口径（component/aggregate）”与“天数过渡年数（默认3年）”。</li>
</ul>
<h2 id="2025-09-10">实施路线图（2025-09-10）</h2>
<ul>
<li>里程碑 1（本月）</li>
<li>[x] Mid-Year Convention（已落地：API+UI）</li>
<li>[x] CRP/IRP（已落地：ENV+API+UI）</li>
<li>[x] COGS 双模式（已落地：API+UI）</li>
<li>[x] ΔNWC 基期统一与调试明细（已落地）</li>
<li>[x] LTM/Interim 基期与最新资产负债表滚动（已落地：API+Fetcher+UI）</li>
<li>里程碑 2（下月）</li>
<li>[x] TV 名义 GDP 上限校验与隐含 PGR 提示（已落地）</li>
<li>[ ] 关键假设摘要卡片常驻与审计导出（进行中：debug_* 已可用）</li>
<li>[x] 行业标尺库 v1（β/预测期/PGR/周转/乘数，GICS 11 + 白酒变体）（已落地）</li>
<li>[x] 股息口径回退链（TTM 实施/完成 → 预案 → 年度）与 UI 标签（已落地）</li>
<li>[x] as-of 一致性（价格≤估值日、EPS≤估值日）与 UI 标签（已落地）</li>
<li>里程碑 3（+1 月）</li>
<li>[ ] 收入多因子与利润平滑路径开关</li>
<li>[ ] 维持性/扩张性 Capex 与 D&amp;A 联动</li>
<li>[ ] 蒙特卡洛情景与三情景联动</li>
</ul>
<h2 id="_8">代码参考</h2>
<ul>
<li>预测引擎：<code>src/core/financial/forecaster.py</code></li>
<li>现值：<code>src/core/calculators/dcf/present_value_calculator.py</code></li>
<li>终值：<code>src/core/calculators/dcf/terminal_value_calculator.py</code></li>
<li>WACC：<code>src/core/calculators/dcf/wacc_calculator.py</code></li>
<li>股权桥：<code>src/core/calculators/equity_bridge_calculator.py</code></li>
<li>Streamlit 参数：<code>frontend-streamlit/streamlit_app.py</code></li>
</ul>
<h2 id="_9">配置与字段（节选）</h2>
<ul>
<li>ENV：<code>COUNTRY_RISK_PREMIUM</code>、<code>INDUSTRY_RISK_PREMIUM</code>、<code>RISK_FREE_RATE</code>、<code>MARKET_RISK_PREMIUM</code> …</li>
<li>API（新增）：<code>mid_year_convention: bool</code>、<code>cogs_forecast_mode: residual|direct_ratio</code>、<code>nwc_baseline_mode: component|aggregate</code>、<code>nwc_days_transition_years: int</code>、<code>country_risk_premium</code>、<code>industry_risk_premium</code>、<code>ltm_baseline_enabled: bool</code></li>
<li>ENV（新增）：<code>DEFAULT_LTM_BASELINE_ENABLED=0</code>（默认关闭；前端可覆盖）</li>
</ul>
<h2 id="_10">验收标准（关键）</h2>
<ul>
<li>开关默认关闭时估值回归一致；开启后影响方向与幅度可解释。</li>
<li><code>nwc_baseline_mode=component</code> 时，与 <code>aggregate</code> 相比，首年 ΔNWC 不出现非经济性跳变；当设置 <code>nwc_days_transition_years&gt;0</code>，ΔNWC 在预测头两年平滑释放。</li>
<li>关键假设与输出在 UI 可视并可导出；调试面板包含“请求摘录/映射假设/历史中位数/首年构成”。</li>
<li>行业与宏观约束生效时，TV 与 Ke 更具合理性与稳定性。</li>
<li>LTM/Interim：开启 <code>ltm_baseline_enabled</code> 时，<code>baseline_debug</code> 显示 YTD/LTM 分解；关闭时使用最新年报；两种基期下首年 ΔNWC 方向与幅度可解释、且与 NWC 基准口径一致。</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
